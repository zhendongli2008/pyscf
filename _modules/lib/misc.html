

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>lib.misc &mdash; PySCF 1.5.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PySCF 1.5.0 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">1. An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tutorial.html">2. Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">3. Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../gto.html">4. gto &#8212; Molecular structure and GTO basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lib.html">5. <code class="docutils literal"><span class="pre">lib</span></code> &#8212; Helper functions, parameters, and C extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scf.html">6. scf &#8212; Mean-field methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ao2mo.html">7. ao2mo &#8212; Integral transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mcscf.html">8. mcscf &#8212; Multi-configurational self-consistent field</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fci.html">9. fci &#8212; Full configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../symm.html">10. symm &#8211; Point group symmetry and spin symmetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../df.html">11. df &#8212; Density fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dft.html">12. dft &#8212; Density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tddft.html">13. tddft &#8212; Time dependent density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../cc.html">14. cc &#8212; Coupled cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ci.html">15. ci &#8212; Configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../dmrgscf.html">16. dmrgscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../fciqmcscf.html">17. fciqmcscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools.html">18. tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../grad.html">19. grad &#8212; Analytical nuclear gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hessian.html">20. hessian &#8212; Analytical nuclear Hessian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pbc.html">21. pbc &#8212; Periodic boundary conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lo.html">22. lo &#8212; Orbital localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../advanced.html">23. Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../qmmm.html">24. qmmm &#8212; QM/MM interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mrpt.html">25. mrpt &#8212; Multi-reference perturbation theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../benchmark.html">26. Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code-rule.html">27. Code standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../version.html">28. Version history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PySCF</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>lib.misc</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for lib.misc</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># Copyright 2014-2018 The PySCF Developers. All Rights Reserved.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>
<span class="c1"># Author: Qiming Sun &lt;osirpt.sun@gmail.com&gt;</span>
<span class="c1">#</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Some hacky functions</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="k">import</span> <span class="n">param</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">__config__</span>

<span class="k">if</span> <span class="n">h5py</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2.2.&#39;</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;h5py-</span><span class="si">%s</span><span class="s1"> is found in your environment. &#39;</span>
                     <span class="s1">&#39;h5py-</span><span class="si">%s</span><span class="s1"> has bug in threading mode.</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s1">&#39;Async-IO is disabled.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">((</span><span class="n">h5py</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">,)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>

<span class="n">c_double_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">)</span>
<span class="n">c_int_p</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">)</span>
<span class="n">c_null_ptr</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">POINTER</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">load_library</span><span class="p">(</span><span class="n">libname</span><span class="p">):</span>
<span class="c1"># numpy 1.6 has bug in ctypeslib.load_library, see numpy/distutils/misc_util.py</span>
    <span class="k">if</span> <span class="s1">&#39;1.6&#39;</span> <span class="ow">in</span> <span class="n">numpy</span><span class="o">.</span><span class="n">__version__</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;gnukfreebsd&#39;</span><span class="p">)):</span>
            <span class="n">so_ext</span> <span class="o">=</span> <span class="s1">&#39;.so&#39;</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;darwin&#39;</span><span class="p">):</span>
            <span class="n">so_ext</span> <span class="o">=</span> <span class="s1">&#39;.dylib&#39;</span>
        <span class="k">elif</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
            <span class="n">so_ext</span> <span class="o">=</span> <span class="s1">&#39;.dll&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Unknown platform&#39;</span><span class="p">)</span>
        <span class="n">libname_so</span> <span class="o">=</span> <span class="n">libname</span> <span class="o">+</span> <span class="n">so_ext</span>
        <span class="k">return</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">CDLL</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">),</span> <span class="n">libname_so</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_loaderpath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">__file__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="n">libname</span><span class="p">,</span> <span class="n">_loaderpath</span><span class="p">)</span>

<span class="c1">#Fixme, the standard resouce module gives wrong number when objects are released</span>
<span class="c1">#see http://fa.bianp.net/blog/2013/different-ways-to-get-memory-consumption-or-lessons-learned-from-memory_profiler/#fn:1</span>
<span class="c1">#or use slow functions as memory_profiler._get_memory did</span>
<span class="n">CLOCK_TICKS</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s2">&quot;SC_CLK_TCK&quot;</span><span class="p">)</span>
<span class="n">PAGESIZE</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s2">&quot;SC_PAGE_SIZE&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">current_memory</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Return the size of used memory and allocated virtual memory (in MB)&#39;&#39;&#39;</span>
    <span class="c1">#import resource</span>
    <span class="c1">#return resource.getrusage(resource.RUSAGE_SELF).ru_maxrss / 1000</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;linux&#39;</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/proc/</span><span class="si">%s</span><span class="s2">/statm&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">())</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">vms</span><span class="p">,</span> <span class="n">rss</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">PAGESIZE</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()[:</span><span class="mi">2</span><span class="p">]]</span>
            <span class="k">return</span> <span class="n">rss</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="n">vms</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

<span class="k">def</span> <span class="nf">num_threads</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Set the number of OMP threads.  If argument is not specified, the</span>
<span class="sd">    function will return the total number of available OMP threads.</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; from pyscf import lib</span>
<span class="sd">    &gt;&gt;&gt; print(lib.num_threads())</span>
<span class="sd">    8</span>
<span class="sd">    &gt;&gt;&gt; lib.num_threads(4)</span>
<span class="sd">    4</span>
<span class="sd">    &gt;&gt;&gt; print(lib.num_threads())</span>
<span class="sd">    4</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="kn">from</span> <span class="nn">pyscf.lib.numpy_helper</span> <span class="k">import</span> <span class="n">_np_helper</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_np_helper</span><span class="o">.</span><span class="n">set_omp_threads</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>
        <span class="n">threads</span> <span class="o">=</span> <span class="n">_np_helper</span><span class="o">.</span><span class="n">set_omp_threads</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">threads</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;OpenMP is not available. &#39;</span>
                          <span class="s1">&#39;Setting omp_threads to </span><span class="si">%s</span><span class="s1"> has no effects.&#39;</span> <span class="o">%</span> <span class="n">n</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">threads</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_np_helper</span><span class="o">.</span><span class="n">get_omp_threads</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span>
        <span class="k">return</span> <span class="n">_np_helper</span><span class="o">.</span><span class="n">get_omp_threads</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">with_omp_threads</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Using this macro to create a temporary context in which the number of</span>
<span class="sd">    OpenMP threads are set to the required value. When the program exits the</span>
<span class="sd">    context, the number OpenMP threads will be restored.</span>

<span class="sd">    Args:</span>
<span class="sd">        nthreads : int</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; from pyscf import lib</span>
<span class="sd">    &gt;&gt;&gt; print(lib.num_threads())</span>
<span class="sd">    8</span>
<span class="sd">    &gt;&gt;&gt; with lib.with_omp_threads(2):</span>
<span class="sd">    ...     print(lib.num_threads())</span>
<span class="sd">    2</span>
<span class="sd">    &gt;&gt;&gt; print(lib.num_threads())</span>
<span class="sd">    8</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nthreads</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span> <span class="o">=</span> <span class="n">nthreads</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sys_threads</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sys_threads</span> <span class="o">=</span> <span class="n">num_threads</span><span class="p">()</span>
            <span class="n">num_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nthreads</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sys_threads</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">num_threads</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sys_threads</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">c_int_arr</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">npm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span> <span class="o">*</span> <span class="n">npm</span><span class="o">.</span><span class="n">size</span><span class="p">)(</span><span class="o">*</span><span class="n">npm</span><span class="p">)</span>
    <span class="c1"># cannot return LP_c_double class,</span>
    <span class="c1">#Xreturn npm.ctypes.data_as(c_int_p), which destructs npm before return</span>
    <span class="k">return</span> <span class="n">arr</span>
<span class="k">def</span> <span class="nf">f_int_arr</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">npm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span> <span class="o">*</span> <span class="n">npm</span><span class="o">.</span><span class="n">size</span><span class="p">)(</span><span class="o">*</span><span class="n">npm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span>
<span class="k">def</span> <span class="nf">c_double_arr</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">npm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">npm</span><span class="o">.</span><span class="n">size</span><span class="p">)(</span><span class="o">*</span><span class="n">npm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span>
<span class="k">def</span> <span class="nf">f_double_arr</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
    <span class="n">npm</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">m</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
    <span class="n">arr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span> <span class="o">*</span> <span class="n">npm</span><span class="o">.</span><span class="n">size</span><span class="p">)(</span><span class="o">*</span><span class="n">npm</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">arr</span>


<span class="k">def</span> <span class="nf">member</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="k">def</span> <span class="nf">remove_dup</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">lst</span><span class="p">,</span> <span class="n">from_end</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">test</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">set</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">from_end</span><span class="p">:</span>
            <span class="n">lst</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">lst</span><span class="p">))</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">member</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">seen</span><span class="p">):</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">seen</span>

<span class="k">def</span> <span class="nf">remove_if</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lst</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">test</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>

<span class="k">def</span> <span class="nf">find_if</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">test</span><span class="p">(</span><span class="n">l</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">l</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No element of the given list matches the test condition.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">arg_first_match</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">lst</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">test</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">i</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No element of the given list matches the test condition.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_balanced_partition</span><span class="p">(</span><span class="n">cum</span><span class="p">,</span> <span class="n">ntasks</span><span class="p">):</span>
    <span class="n">segsize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">cum</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">ntasks</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ntasks</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">segsize</span>
    <span class="n">displs</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">bounds</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">cum</span><span class="p">)</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">displs</span>

<span class="k">def</span> <span class="nf">_blocksize_partition</span><span class="p">(</span><span class="n">cum</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cum</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">displs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">displs</span>

    <span class="n">p0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cum</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">cum</span><span class="p">[</span><span class="n">p0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">blocksize</span><span class="p">:</span>
            <span class="n">displs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">i</span>
    <span class="n">displs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">displs</span>

<div class="viewcode-block" id="flatten"><a class="viewcode-back" href="../../lib.html#lib.misc.flatten">[docs]</a><span class="k">def</span> <span class="nf">flatten</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;flatten nested lists</span>
<span class="sd">    x[0] + x[1] + x[2] + ...</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; flatten([[0, 2], [1], [[9, 8, 7]]])</span>
<span class="sd">    [0, 2, 1, [9, 8, 7]]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="o">.</span><span class="n">from_iterable</span><span class="p">(</span><span class="n">lst</span><span class="p">))</span></div>

<span class="k">def</span> <span class="nf">prange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;This function splits the number sequence between &quot;start&quot; and &quot;end&quot;</span>
<span class="sd">    using uniform &quot;step&quot; length. It yields the boundary (start, end) for each</span>
<span class="sd">    fragment.</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; for p0, p1 in lib.prange(0, 8, 2):</span>
<span class="sd">    ...    print(p0, p1)</span>
<span class="sd">    (0, 2)</span>
<span class="sd">    (2, 4)</span>
<span class="sd">    (4, 6)</span>
<span class="sd">    (6, 8)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prange_tril</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Similar to :func:`prange`, yeilds start (p0) and end (p1) with the</span>
<span class="sd">    restriction p1*(p1+1)/2-p0*(p0+1)/2 &lt; blocksize</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; for p0, p1 in lib.prange_tril(0, 10, 25):</span>
<span class="sd">    ...     print(p0, p1)</span>
<span class="sd">    (0, 6)</span>
<span class="sd">    (6, 9)</span>
<span class="sd">    (9, 10)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;=</span> <span class="n">stop</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">cum_costs</span> <span class="o">=</span> <span class="n">idx</span><span class="o">*</span><span class="p">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="n">start</span><span class="o">*</span><span class="p">(</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">displs</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">+</span><span class="n">start</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">_blocksize_partition</span><span class="p">(</span><span class="n">cum_costs</span><span class="p">,</span> <span class="n">blocksize</span><span class="p">)]</span>
    <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="n">displs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">displs</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

<span class="k">def</span> <span class="nf">tril_product</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Cartesian product in lower-triangular form for multiple indices</span>

<span class="sd">    For a given list of indices (`iterables`), this function yields all</span>
<span class="sd">    indices such that the sub-indices given by the kwarg `tril_idx` satisfy a</span>
<span class="sd">    lower-triangular form.  The lower-triangular form satisfies:</span>

<span class="sd">    .. math:: i[tril_idx[0]] &gt;= i[tril_idx[1]] &gt;= ... &gt;= i[tril_idx[len(tril_idx)-1]]</span>

<span class="sd">    Args:</span>
<span class="sd">        *iterables: Variable length argument list of indices for the cartesian product</span>
<span class="sd">        **kwds: Arbitrary keyword arguments.  Acceptable keywords include:</span>
<span class="sd">            repeat (int): Number of times to repeat the iterables</span>
<span class="sd">            tril_idx (array_like): Indices to put into lower-triangular form.</span>

<span class="sd">    Yields:</span>
<span class="sd">        product (tuple): Tuple in lower-triangular form.</span>

<span class="sd">    Examples:</span>
<span class="sd">        Specifying no `tril_idx` is equivalent to just a cartesian product.</span>

<span class="sd">        &gt;&gt;&gt; list(tril_product(range(2), repeat=2))</span>
<span class="sd">        [(0, 0), (0, 0), (0, 1), (0, 1), (1, 0), (1, 0), (1, 1), (1, 1)]</span>

<span class="sd">        We can specify only sub-indices to satisfy a lower-triangular form:</span>

<span class="sd">        &gt;&gt;&gt; list(tril_product(range(2), repeat=3, tril_idx=[1,2]))</span>
<span class="sd">        [(0, 0, 0), (0, 1, 0), (0, 1, 1), (1, 0, 0), (1, 1, 0), (1, 1, 1)]</span>

<span class="sd">        We specify all indices to satisfy a lower-triangular form, useful for iterating over</span>
<span class="sd">        the symmetry unique elements of occupied/virtual orbitals in a 3-particle operator:</span>

<span class="sd">        &gt;&gt;&gt; list(tril_product(range(3), repeat=3, tril_idx=[0,1,2]))</span>
<span class="sd">        [(0, 0, 0), (1, 0, 0), (1, 1, 0), (1, 1, 1), (2, 0, 0), (2, 1, 0), (2, 1, 1), (2, 2, 0), (2, 2, 1), (2, 2, 2)]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">repeat</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;repeat&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">tril_idx</span> <span class="o">=</span> <span class="n">kwds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tril_idx&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">niterables</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">iterables</span><span class="p">)</span> <span class="o">*</span> <span class="n">repeat</span>
    <span class="n">ntril_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tril_idx</span><span class="p">)</span>

    <span class="k">assert</span> <span class="n">ntril_idx</span> <span class="o">&lt;=</span> <span class="n">niterables</span><span class="p">,</span> <span class="s1">&#39;Cant have a greater number of tril indices than iterables!&#39;</span>
    <span class="k">if</span> <span class="n">ntril_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">tril_idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">niterables</span><span class="p">,</span> <span class="s1">&#39;Tril index out of bounds for </span><span class="si">%d</span><span class="s1"> iterables! idx = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> \
                                                 <span class="p">(</span><span class="n">niterables</span><span class="p">,</span> <span class="n">tril_idx</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">iterables</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ntril_idx</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">tup</span>

        <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">tup</span><span class="p">[</span><span class="n">tril_idx</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&gt;=</span> <span class="n">tup</span><span class="p">[</span><span class="n">tril_idx</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">ntril_idx</span><span class="o">-</span><span class="mi">1</span><span class="p">)]):</span>
            <span class="k">yield</span> <span class="n">tup</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

<span class="k">def</span> <span class="nf">square_mat_in_trilu_indices</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Return a n x n symmetric index matrix, in which the elements are the</span>
<span class="sd">    indices of the unique elements of a tril vector</span>
<span class="sd">    [0 1 3 ... ]</span>
<span class="sd">    [1 2 4 ... ]</span>
<span class="sd">    [3 4 5 ... ]</span>
<span class="sd">    [...       ]</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="n">tril2sq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">tril2sq</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tril2sq</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tril2sq</span>

<span class="k">class</span> <span class="nc">ctypes_stdout</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;make c-printf output to string, but keep python print in /dev/pts/1.</span>
<span class="sd">    Note it cannot correctly handle c-printf with GCC, don&#39;t know why.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">fdopen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">fsync</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout</span> <span class="c1"># self.bak_stdout_fd is closed</span>
        <span class="c1">#os.close(self.fd) is closed when os.fdopen is closed</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1">#f = os.fdopen(self.fd, &#39;r&#39;) # need to rewind(0) before reading</span>
            <span class="c1">#f.seek(0)</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">capture_stdout</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;redirect all stdout (c printf &amp; python print) into a string</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from pyscf import lib</span>
<span class="sd">    &gt;&gt;&gt; with lib.capture_stdout as out:</span>
<span class="sd">    ...     os.system(&#39;ls&#39;)</span>
<span class="sd">    &gt;&gt;&gt; print(out.read())</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1">#TODO: handle stderr</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkstemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span><span class="p">)</span>
        <span class="c1">#os.close(self.fd) will be closed when os.fdopen is closed</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contents</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1">#f = os.fdopen(self.fd, &#39;r&#39;) # need to rewind(0) before reading</span>
            <span class="c1">#f.seek(0)</span>
            <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ftmp</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">class</span> <span class="nc">quite_run</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;capture all stdout (c printf &amp; python print) but output nothing</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; import os</span>
<span class="sd">    &gt;&gt;&gt; from pyscf import lib</span>
<span class="sd">    &gt;&gt;&gt; with lib.quite_run():</span>
<span class="sd">    ...     os.system(&#39;ls&#39;)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dirnow</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">dup</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnull</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">devnull</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fnull</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bak_stdout_fd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_stdout_fileno</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fnull</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tmpdir</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dirnow</span><span class="p">)</span>


<span class="c1"># from pygeocoder</span>
<span class="c1"># this decorator lets me use methods as both static and instance methods</span>
<span class="c1"># In contrast to classmethod, when obj.function() is called, the first</span>
<span class="c1"># argument is obj in omnimethod rather than obj.__class__ in classmethod</span>
<span class="k">class</span> <span class="nc">omnimethod</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>

    <span class="k">def</span> <span class="nf">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">instance</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">StreamObject</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;For most methods, there are three stream functions to pipe computing stream:</span>

<span class="sd">    1 ``.set_`` function to update object attributes, eg</span>
<span class="sd">    ``mf = scf.RHF(mol).set(conv_tol=1e-5)`` is identical to proceed in two steps</span>
<span class="sd">    ``mf = scf.RHF(mol); mf.conv_tol=1e-5``</span>

<span class="sd">    2 ``.run`` function to execute the kenerl function (the function arguments</span>
<span class="sd">    are passed to kernel function).  If keyword arguments is given, it will first</span>
<span class="sd">    call ``.set`` function to update object attributes then execute the kernel</span>
<span class="sd">    function.  Eg</span>
<span class="sd">    ``mf = scf.RHF(mol).run(dm_init, conv_tol=1e-5)`` is identical to three steps</span>
<span class="sd">    ``mf = scf.RHF(mol); mf.conv_tol=1e-5; mf.kernel(dm_init)``</span>

<span class="sd">    3 ``.apply`` function to apply the given function/class to the current object</span>
<span class="sd">    (function arguments and keyword arguments are passed to the given function).</span>
<span class="sd">    Eg</span>
<span class="sd">    ``mol.apply(scf.RHF).run().apply(mcscf.CASSCF, 6, 4, frozen=4)`` is identical to</span>
<span class="sd">    ``mf = scf.RHF(mol); mf.kernel(); mcscf.CASSCF(mf, 6, 4, frozen=4)``</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
    <span class="n">_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="s1">&#39;verbose&#39;</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Kernel function is the main driver of a method.  Every method should</span>
<span class="sd">        define the kernel function as the entry of the calculation.  Note the</span>
<span class="sd">        return value of kernel function is not strictly defined.  It can be</span>
<span class="sd">        anything related to the method (such as the energy, the wave-function,</span>
<span class="sd">        the DFT mesh grids etc.).</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">pre_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A hook to be run before the main body of kernel function is executed.</span>
<span class="sd">        Internal variables are exposed to pre_kernel through the &quot;envs&quot;</span>
<span class="sd">        dictionary.  Return value of pre_kernel function is not required.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">post_kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        A hook to be run after the main body of the kernel function.  Internal</span>
<span class="sd">        variables are exposed to post_kernel through the &quot;envs&quot; dictionary.</span>
<span class="sd">        Return value of post_kernel function is not required.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Call the kernel function of current object.  `args` will be passed</span>
<span class="sd">        to kernel function.  `kwargs` will be used to update the attributes of</span>
<span class="sd">        current object.  The return value of method run is the object itself.</span>
<span class="sd">        This allows a series of functions/methods to be executed in pipe.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Update the attributes of the current object.  The return value of</span>
<span class="sd">        method set is the object itself.  This allows a series of</span>
<span class="sd">        functions/methods to be executed in pipe.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1">#if hasattr(self, &#39;_keys&#39;):</span>
        <span class="c1">#    for k,v in kwargs.items():</span>
        <span class="c1">#        setattr(self, k, v)</span>
        <span class="c1">#        if k not in self._keys:</span>
        <span class="c1">#            sys.stderr.write(&#39;Warning: %s does not have attribute %s\n&#39;</span>
        <span class="c1">#                             % (self.__class__, k))</span>
        <span class="c1">#else:</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">apply</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Apply the fn to rest arguments:  return fn(*args, **kwargs).  The</span>
<span class="sd">        return value of method set is the object itself.  This allows a series</span>
<span class="sd">        of functions/methods to be executed in pipe.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="c1">#    def _format_args(self, args, kwargs, kernel_kw_lst):</span>
<span class="c1">#        args1 = [kwargs.pop(k, v) for k, v in kernel_kw_lst]</span>
<span class="c1">#        return args + args1[len(args):], kwargs</span>

    <span class="k">def</span> <span class="nf">check_sanity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">        Check input of class/object attributes, check whether a class method is</span>
<span class="sd">        overwritten.  It does not check the attributes which are prefixed with</span>
<span class="sd">        &quot;_&quot;.  The</span>
<span class="sd">        return value of method set is the object itself.  This allows a series</span>
<span class="sd">        of functions/methods to be executed in pipe.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>  <span class="c1"># logger.QUIET</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_keys&#39;</span><span class="p">)):</span>
            <span class="n">check_sanity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

<span class="n">_warn_once_registry</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">def</span> <span class="nf">check_sanity</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">keysref</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Check misinput of class attributes, check whether a class method is</span>
<span class="sd">    overwritten.  It does not check the attributes which are prefixed with</span>
<span class="sd">    &quot;_&quot;.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">objkeys</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">x</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)]</span>
    <span class="n">keysub</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">objkeys</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">keysref</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">keysub</span><span class="p">:</span>
        <span class="n">class_attr</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="n">keyin</span> <span class="o">=</span> <span class="n">keysub</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">class_attr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">keyin</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;Overwritten attributes  </span><span class="si">%s</span><span class="s1">  of </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keyin</span><span class="p">),</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_warn_once_registry</span><span class="p">:</span>
                <span class="n">_warn_once_registry</span><span class="p">[</span><span class="n">msg</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="n">keydiff</span> <span class="o">=</span> <span class="n">keysub</span> <span class="o">-</span> <span class="n">class_attr</span>
        <span class="k">if</span> <span class="n">keydiff</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> does not have attributes  </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span>
                   <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">keydiff</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">msg</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_warn_once_registry</span><span class="p">:</span>
                <span class="n">_warn_once_registry</span><span class="p">[</span><span class="n">msg</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stdout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                    <span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">def</span> <span class="nf">with_doc</span><span class="p">(</span><span class="n">doc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Use this decorator to add doc string for function</span>

<span class="sd">        @with_doc(doc)</span>
<span class="sd">        def fn:</span>
<span class="sd">            ...</span>

<span class="sd">    is equivalent to</span>

<span class="sd">        fn.__doc__ = doc</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">make_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span><span class="o">.</span><span class="n">__doc__</span> <span class="o">=</span> <span class="n">doc</span>
        <span class="k">return</span> <span class="n">fn</span>
    <span class="k">return</span> <span class="n">make_fn</span>

<span class="k">def</span> <span class="nf">import_as_method</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">default_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    The statement &quot;fn1 = import_as_method(fn, default_keys=[&#39;a&#39;,&#39;b&#39;])&quot;</span>
<span class="sd">    in a class is equivalent to define the following method in the class:</span>

<span class="sd">    .. code-block:: python</span>
<span class="sd">        def fn1(self, ..., a=None, b=None, ...):</span>
<span class="sd">            if a is None: a = self.a</span>
<span class="sd">            if b is None: b = self.b</span>
<span class="sd">            return fn(..., a, b, ...)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">code_obj</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">__code__</span>
<span class="c1"># Add the default_keys as kwargs in CodeType is very complicated</span>
<span class="c1">#    new_code_obj = types.CodeType(code_obj.co_argcount+1,</span>
<span class="c1">#                                  code_obj.co_nlocals,</span>
<span class="c1">#                                  code_obj.co_stacksize,</span>
<span class="c1">#                                  code_obj.co_flags,</span>
<span class="c1">#                                  code_obj.co_code,</span>
<span class="c1">#                                  code_obj.co_consts,</span>
<span class="c1">#                                  code_obj.co_names,</span>
<span class="c1">## As a class method, the first argument should be self</span>
<span class="c1">#                                  (&#39;self&#39;,) + code_obj.co_varnames,</span>
<span class="c1">#                                  code_obj.co_filename,</span>
<span class="c1">#                                  code_obj.co_name,</span>
<span class="c1">#                                  code_obj.co_firstlineno,</span>
<span class="c1">#                                  code_obj.co_lnotab,</span>
<span class="c1">#                                  code_obj.co_freevars,</span>
<span class="c1">#                                  code_obj.co_cellvars)</span>
<span class="c1">#    clsmethod = types.FunctionType(new_code_obj, fn.__globals__)</span>
<span class="c1">#    clsmethod.__defaults__ = fn.__defaults__</span>

    <span class="c1"># exec is a bad solution here.  But I didn&#39;t find a better way to</span>
    <span class="c1"># implement this for now.</span>
    <span class="n">nargs</span> <span class="o">=</span> <span class="n">code_obj</span><span class="o">.</span><span class="n">co_argcount</span>
    <span class="n">argnames</span> <span class="o">=</span> <span class="n">code_obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">[:</span><span class="n">nargs</span><span class="p">]</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">__defaults__</span>
    <span class="n">new_code_str</span> <span class="o">=</span> <span class="s1">&#39;def clsmethod(self, </span><span class="si">%s</span><span class="s1">):</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argnames</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">default_keys</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">default_keys</span><span class="p">:</span>
            <span class="n">new_code_str</span> <span class="o">+=</span> <span class="s1">&#39;    if </span><span class="si">%s</span><span class="s1"> is None: </span><span class="si">%s</span><span class="s1"> = self.</span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">defaults</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="n">nargs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">defaults</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,)</span> <span class="o">*</span> <span class="p">(</span><span class="n">nargs</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">defaults</span><span class="p">))</span> <span class="o">+</span> <span class="n">defaults</span>
    <span class="n">new_code_str</span> <span class="o">+=</span> <span class="s1">&#39;    return </span><span class="si">%s</span><span class="s1">(</span><span class="si">%s</span><span class="s1">)</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">fn</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">argnames</span><span class="p">))</span>
    <span class="n">exec</span><span class="p">(</span><span class="n">new_code_str</span><span class="p">,</span> <span class="n">fn</span><span class="o">.</span><span class="n">__globals__</span><span class="p">,</span> <span class="nb">locals</span><span class="p">())</span>

    <span class="n">clsmethod</span><span class="o">.</span><span class="n">__name__</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">clsmethod</span><span class="o">.</span><span class="n">__defaults__</span> <span class="o">=</span> <span class="n">defaults</span>
    <span class="k">return</span> <span class="n">clsmethod</span>

<span class="k">def</span> <span class="nf">overwrite_mro</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">mro</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A hacky function to overwrite the __mro__ attribute&#39;&#39;&#39;</span>
    <span class="k">class</span> <span class="nc">HackMRO</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
        <span class="k">pass</span>
<span class="c1"># Overwrite type.mro function so that Temp class can use the given mro</span>
    <span class="n">HackMRO</span><span class="o">.</span><span class="n">mro</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="n">mro</span>
    <span class="c1">#if sys.version_info &lt; (3,):</span>
    <span class="c1">#    class Temp(obj.__class__):</span>
    <span class="c1">#        __metaclass__ = HackMRO</span>
    <span class="c1">#else:</span>
    <span class="c1">#    class Temp(obj.__class__, metaclass=HackMRO):</span>
    <span class="c1">#        pass</span>
    <span class="n">Temp</span> <span class="o">=</span> <span class="n">HackMRO</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__bases__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">Temp</span><span class="p">()</span>
<span class="c1"># Delete mro function otherwise all subclass of Temp are not able to</span>
<span class="c1"># resolve the right mro</span>
    <span class="k">del</span><span class="p">(</span><span class="n">HackMRO</span><span class="o">.</span><span class="n">mro</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">obj</span>

<span class="k">def</span> <span class="nf">izip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;python2 izip == python3 zip&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,):</span>
        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">izip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">threading</span> <span class="k">import</span> <span class="n">Thread</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="k">import</span> <span class="n">Queue</span><span class="p">,</span> <span class="n">Process</span>
<span class="k">class</span> <span class="nc">ProcessWithReturnValue</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">def</span> <span class="nf">qwrap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_e</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">qwrap</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ProcessRuntimeError</span><span class="p">(</span><span class="s1">&#39;Error on process </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Process</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">get</span> <span class="o">=</span> <span class="n">join</span>

<span class="k">class</span> <span class="nc">ProcessRuntimeError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">class</span> <span class="nc">ThreadWithReturnValue</span><span class="p">(</span><span class="n">Thread</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span>
                 <span class="n">kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_q</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_e</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">def</span> <span class="nf">qwrap</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">target</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_e</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">raise</span> <span class="n">e</span>
        <span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group</span><span class="p">,</span> <span class="n">qwrap</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">join</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ThreadRuntimeError</span><span class="p">(</span><span class="s1">&#39;Error on thread </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Thread</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_q</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
    <span class="n">get</span> <span class="o">=</span> <span class="n">join</span>

<span class="k">class</span> <span class="nc">ThreadRuntimeError</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="k">def</span> <span class="nf">background_thread</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;applying function in background&#39;&#39;&#39;</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">ThreadWithReturnValue</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">thread</span>

<span class="k">def</span> <span class="nf">background_process</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;applying function in background&#39;&#39;&#39;</span>
    <span class="n">thread</span> <span class="o">=</span> <span class="n">ProcessWithReturnValue</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">thread</span>

<span class="n">bg</span> <span class="o">=</span> <span class="n">background</span> <span class="o">=</span> <span class="n">bg_thread</span> <span class="o">=</span> <span class="n">background_thread</span>
<span class="n">bp</span> <span class="o">=</span> <span class="n">bg_process</span> <span class="o">=</span> <span class="n">background_process</span>


<span class="k">class</span> <span class="nc">call_in_background</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Within this macro, function(s) can be executed asynchronously (the</span>
<span class="sd">    given functions are executed in background).</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; with call_in_background(fun) as async_fun:</span>
<span class="sd">    ...     async_fun(a, b)  # == fun(a, b)</span>
<span class="sd">    ...     do_something_else()</span>

<span class="sd">    &gt;&gt;&gt; with call_in_background(fun1, fun2) as (afun1, afun2):</span>
<span class="sd">    ...     afun2(a, b)</span>
<span class="sd">    ...     do_something_else()</span>
<span class="sd">    ...     afun2(a, b)</span>
<span class="sd">    ...     do_something_else()</span>
<span class="sd">    ...     afun1(a, b)</span>
<span class="sd">    ...     do_something_else()</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">fns</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fns</span> <span class="o">=</span> <span class="n">fns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;sync&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;sync&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">__config__</span><span class="p">,</span> <span class="s1">&#39;ASYNC_IO&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="ow">or</span> <span class="n">h5py</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">version</span><span class="p">[:</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;2.2.&#39;</span><span class="p">:</span> <span class="c1"># h5py-2.2.* has bug in threading mode</span>
        <span class="c1"># Disable back-ground mode</span>
        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fns</span>
    <span class="k">else</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">def_async_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">fn</span>
            <span class="k">elif</span> <span class="n">imp</span><span class="o">.</span><span class="n">lock_held</span><span class="p">():</span>
<span class="c1"># Some modules like nosetests, coverage etc</span>
<span class="c1">#   python -m unittest test_xxx.py  or  nosetests test_xxx.py</span>
<span class="c1"># hang when Python multi-threading was used in the import stage due to (Python</span>
<span class="c1"># import lock) bug in the threading module.  See also</span>
<span class="c1"># https://github.com/paramiko/paramiko/issues/104</span>
<span class="c1"># https://docs.python.org/2/library/threading.html#importing-in-threaded-code</span>
<span class="c1"># Disable the asynchoronous mode for safe importing</span>
                <span class="k">def</span> <span class="nf">def_async_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">fn</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Enable back-ground mode</span>
                <span class="k">def</span> <span class="nf">def_async_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
                    <span class="k">def</span> <span class="nf">async_fn</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="o">=</span> <span class="n">ThreadWithReturnValue</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">fn</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span>
                                                             <span class="n">kwargs</span><span class="o">=</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span>
                    <span class="k">return</span> <span class="n">async_fn</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">def_async_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fns</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">def_async_fn</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fns</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">handler</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handler</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">H5TmpFile</span><span class="p">(</span><span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Create and return an HDF5 temporary file.</span>

<span class="sd">    Kwargs:</span>
<span class="sd">        filename : str or None</span>
<span class="sd">            If a string is given, an HDF5 file of the given filename will be</span>
<span class="sd">            created. The temporary file will exist even if the H5TmpFile</span>
<span class="sd">            object is released.  If nothing is specified, the HDF5 temporary</span>
<span class="sd">            file will be deleted when the H5TmpFile object is released.</span>

<span class="sd">    The return object is an h5py.File object. The file will be automatically</span>
<span class="sd">    deleted when it is closed or the object is released (unless filename is</span>
<span class="sd">    specified).</span>

<span class="sd">    Examples:</span>

<span class="sd">    &gt;&gt;&gt; from pyscf import lib</span>
<span class="sd">    &gt;&gt;&gt; ftmp = lib.H5TmpFile()</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">filename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmpfile</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">name</span>
        <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">fingerprint</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Fingerprint of numpy array&#39;&#39;&#39;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">)),</span> <span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
<span class="n">finger</span> <span class="o">=</span> <span class="n">fingerprint</span>


<span class="k">def</span> <span class="nf">ndpointer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ctypeslib</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_param</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>
        <span class="k">return</span> <span class="n">base</span><span class="o">.</span><span class="n">from_param</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">base</span><span class="p">,),</span> <span class="p">{</span><span class="s1">&#39;from_param&#39;</span><span class="p">:</span> <span class="n">from_param</span><span class="p">})</span>


<span class="c1"># A tag to label the derived Scanner class</span>
<span class="k">class</span> <span class="nc">SinglePointScanner</span><span class="p">:</span> <span class="k">pass</span>
<span class="k">class</span> <span class="nc">GradScanner</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">g</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">g</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">as_scanner</span><span class="p">()</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">e_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">e_tot</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">converged</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">converged</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">prange_tril</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">300</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">-</span><span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-, Qiming Sun &lt;osirpt.sun@gmail.com&gt;.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.5.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>