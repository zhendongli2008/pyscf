

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyscf.cc.uccsd &mdash; PySCF 1.4.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PySCF 1.4.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gto.html">gto &#8212; Molecular structure and GTO basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib.html">lib &#8212; Helper functions, parameters, and C extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scf.html">scf &#8212; Mean-field methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ao2mo.html">ao2mo &#8212; Integral transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mcscf.html">mcscf &#8212; Multi-configurational self-consistent field</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fci.html">fci &#8212; Full configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../symm.html">symm &#8211; Point group symmetry and spin symmetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../df.html">df &#8212; Density fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dft.html">dft &#8212; Density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tddft.html">tddft &#8212; Time dependent density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cc.html">cc &#8212; Coupled cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">ci &#8212; Configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dmrgscf.html">dmrgscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fciqmcscf.html">fciqmcscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grad.html">grad &#8212; Analytical nuclear gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hessian.html">hessian &#8212; Analytical nuclear Hessian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pbc.html">pbc &#8212; Periodic boundary conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lo.html">lo &#8212; Orbital localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Miscellaneous</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qmmm.html">qmmm &#8212; QM/MM interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mrpt.html">mrpt &#8212; Multi-reference perturbation theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark.html">Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-rule.html">Code standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version.html">Version history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySCF</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyscf.cc.uccsd</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscf.cc.uccsd</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">UCCSD with spatial integrals</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">ao2mo</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">rccsd</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="k">import</span> <span class="n">linalg_helper</span>
<span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">uintermediates</span> <span class="k">as</span> <span class="n">imd</span>
<span class="kn">from</span> <span class="nn">pyscf.cc.addons</span> <span class="k">import</span> <span class="n">spatial2spin</span><span class="p">,</span> <span class="n">spin2spatial</span>

<span class="c1">#einsum = np.einsum</span>
<span class="n">einsum</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span>

<span class="c1"># This is unrestricted (U)CCSD, i.e. spin-orbital form.</span>

<div class="viewcode-block" id="kernel"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.uccsd.kernel">[docs]</a><span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">tolnormt</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span>
           <span class="n">verbose</span><span class="o">=</span><span class="n">logger</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Exactly the same as pyscf.cc.ccsd.kernel, which calls a</span>
<span class="sd">    *local* energy() function.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">verbose</span><span class="p">,</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">verbose</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">r1</span>
    <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">r2</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">cput1</span> <span class="o">=</span> <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">eold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eccsd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis</span><span class="p">:</span>
        <span class="n">adiis</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">diis</span><span class="o">.</span><span class="n">DIIS</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis_file</span><span class="p">)</span>
        <span class="n">adiis</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis_space</span>

    <span class="n">conv</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_cycle</span><span class="p">):</span>
        <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">update_amps</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span><span class="p">)</span>
        <span class="n">normt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span> <span class="o">-</span> <span class="n">cc</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">))</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span>
        <span class="n">t1new</span> <span class="o">=</span> <span class="n">t2new</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis</span><span class="p">:</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">diis</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">eccsd</span><span class="o">-</span><span class="n">eold</span><span class="p">,</span> <span class="n">adiis</span><span class="p">)</span>
        <span class="n">eold</span><span class="p">,</span> <span class="n">eccsd</span> <span class="o">=</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;istep = </span><span class="si">%d</span><span class="s1">  E(CCSD) = </span><span class="si">%.15g</span><span class="s1">  dE = </span><span class="si">%.9g</span><span class="s1">  norm(t1,t2) = </span><span class="si">%.6g</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">istep</span><span class="p">,</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">eccsd</span> <span class="o">-</span> <span class="n">eold</span><span class="p">,</span> <span class="n">normt</span><span class="p">)</span>
        <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD iter&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eccsd</span><span class="o">-</span><span class="n">eold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">normt</span> <span class="o">&lt;</span> <span class="n">tolnormt</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conv</span><span class="p">,</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span></div>

<span class="k">def</span> <span class="nf">update_amps</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>

    <span class="n">fooa</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span>
    <span class="n">foob</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
    <span class="n">fova</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
    <span class="n">fovb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
    <span class="n">fvva</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span>
    <span class="n">fvvb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span>

    <span class="n">u1a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t1a</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t1b</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t2aa</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t2ab</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">t2bb</span><span class="p">)</span>

    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>

    <span class="n">Fooa</span>  <span class="o">=</span> <span class="n">fooa</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">fooa</span><span class="p">))</span>
    <span class="n">Foob</span>  <span class="o">=</span> <span class="n">foob</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">foob</span><span class="p">))</span>
    <span class="n">Fvva</span>  <span class="o">=</span> <span class="n">fvva</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">fvva</span><span class="p">))</span>
    <span class="n">Fvvb</span>  <span class="o">=</span> <span class="n">fvvb</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">fvvb</span><span class="p">))</span>
    <span class="n">Fooa</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span> <span class="n">fova</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
    <span class="n">Foob</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span> <span class="n">fovb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
    <span class="n">Fvva</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="n">fova</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
    <span class="n">Fvvb</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="n">fovb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
    <span class="n">wOVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
    <span class="n">woVvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
    <span class="n">woVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
    <span class="n">wOvVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
    <span class="n">wOvvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>

    <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
    <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
        <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">ovvv</span> <span class="o">=</span> <span class="n">ovvv</span> <span class="o">-</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Fvva</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
        <span class="n">wovvo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mebf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">)</span>
        <span class="n">u1a</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mief,meaf-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
        <span class="n">u2aa</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbea-&gt;imab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,mebf-&gt;ijmb&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">)</span>
        <span class="n">u2aa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijmb,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp1aa</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ovvv</span> <span class="o">=</span> <span class="n">tmp1aa</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
        <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">OVVV</span> <span class="o">=</span> <span class="n">OVVV</span> <span class="o">-</span> <span class="n">OVVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Fvvb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVVV</span><span class="p">)</span>
        <span class="n">wOVVO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mebf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">)</span>
        <span class="n">u1b</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIEF,MEAF-&gt;IA&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVVV</span><span class="p">)</span>
        <span class="n">u2bb</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbea-&gt;imab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OVVV</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,mebf-&gt;ijmb&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">)</span>
        <span class="n">u2bb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijmb,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmp1bb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">OVVV</span> <span class="o">=</span> <span class="n">tmp1bb</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
        <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Fvvb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfAE-&gt;AE&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovVV</span><span class="p">)</span>
        <span class="n">woVvO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JF,meBF-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">)</span>
        <span class="n">woVVo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mfBE-&gt;mBEj&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1a</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">)</span>
        <span class="n">u1b</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mIeF,meAF-&gt;IA&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovVV</span><span class="p">)</span>
        <span class="n">u2ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,maEB-&gt;mIaB&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">ovVV</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeF,meBF-&gt;iJmB&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">)</span>
        <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJmB,ma-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
        <span class="n">ovVV</span> <span class="o">=</span> <span class="n">tmp1ab</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nocca</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
        <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Fvva</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MF,MFae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVvv</span><span class="p">)</span>
        <span class="n">wOvVo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,MEbf-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">)</span>
        <span class="n">wOvvO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JF,MFbe-&gt;MbeJ&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1b</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">)</span>
        <span class="n">u1a</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iMfE,MEaf-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVvv</span><span class="p">)</span>
        <span class="n">u2ab</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,MBea-&gt;iMaB&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">OVvv</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span>
        <span class="n">tmp1abba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeF,MFbe-&gt;iJbM&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">)</span>
        <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJbM,MA-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">tmp1abba</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
        <span class="n">OVvv</span> <span class="o">=</span> <span class="n">tmp1abba</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
    <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mine-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">Woooo</span> <span class="o">-</span> <span class="n">Woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">u2aa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mnij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">Woooo</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">Woooo</span> <span class="o">=</span> <span class="n">tauaa</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">-</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">Fooa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,mine-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">ooov</span><span class="p">)</span>
    <span class="n">u1a</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnae,nime-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">ooov</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mjne-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">ooov</span><span class="p">)</span>
    <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">tilaa</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Fvva</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tilaa</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
    <span class="n">Fooa</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilaa</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
    <span class="n">Fova</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">+=</span> <span class="n">ovov</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">wovvo</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
    <span class="n">woVvO</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,menf-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
    <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,menf-&gt;mnej&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">ovov</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mnej-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmpaa</span><span class="p">)</span>
    <span class="n">eirs_ovov</span> <span class="o">=</span> <span class="n">ovov</span> <span class="o">=</span> <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">tilaa</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
    <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mine-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOOV</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">WOOOO</span> <span class="o">-</span> <span class="n">WOOOO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">u2bb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mnij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">,</span> <span class="n">WOOOO</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">WOOOO</span> <span class="o">=</span> <span class="n">taubb</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">-</span> <span class="n">eris_OOOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">Foob</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,mine-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnae,nime-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">)</span>
    <span class="n">wOVVO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mjne-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OOOV</span><span class="p">)</span>
    <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">tilbb</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">-</span> <span class="n">eris_OVOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">Fvvb</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MNAF,MENF-&gt;AE&#39;</span><span class="p">,</span> <span class="n">tilbb</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">)</span>
    <span class="n">Foob</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilbb</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">)</span>
    <span class="n">Fovb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">+=</span> <span class="n">OVOV</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">wOVVO</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">)</span>
    <span class="n">wOvVo</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MENF-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">)</span>
    <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,menf-&gt;mnej&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">)</span>
    <span class="n">wOVVO</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mnej-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmpbb</span><span class="p">)</span>
    <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">OVOV</span> <span class="o">=</span> <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">tilbb</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">)</span>
    <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">)</span>
    <span class="n">Fooa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NE,miNE-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
    <span class="n">u1a</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nMaE,niME-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
    <span class="n">wOvVo</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,njME-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
    <span class="n">woVVo</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,mjNE-&gt;mBEj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
    <span class="n">Foob</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,MIne-&gt;MI&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNeA,NIme-&gt;IA&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
    <span class="n">woVvO</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,NJme-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
    <span class="n">wOvvO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,MJne-&gt;MbeJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
    <span class="n">WoOoO</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,miNE-&gt;mNiJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
    <span class="n">WoOoO</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,MIne-&gt;nMjI&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
    <span class="n">WoOoO</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">eris_OOov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
    <span class="n">WoOoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeF,meNF-&gt;mNiJ&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaB,mNiJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">WoOoO</span><span class="p">)</span>
    <span class="n">WoOoO</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">tilab</span> <span class="o">=</span> <span class="n">make_tau_ab</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t1</span> <span class="p">,</span> <span class="n">t1</span> <span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    <span class="n">Fvva</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaF,meNF-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">Fvvb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nMfA,nfME-&gt;AE&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">Fooa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNeF,meNF-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">Foob</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfE,nfME-&gt;MI&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">Fova</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NF,meNF-&gt;me&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">Fovb</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,nfME-&gt;ME&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">eris_ovOV</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,meNF-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">wOVVO</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,nfME-&gt;MBEJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">wOvVo</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,nfME-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">woVvO</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNFB,meNF-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">woVVo</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNfB,mfNE-&gt;mBEj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">wOvvO</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJbF,neMF-&gt;MbeJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">tmpabab</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JF,meNF-&gt;mNeJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">tmpbaba</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nfME-&gt;MnEj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">woVvO</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,mNeJ-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmpabab</span><span class="p">)</span>
    <span class="n">wOvVo</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,MnEj-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmpbaba</span><span class="p">)</span>
    <span class="n">woVVo</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,NmEj-&gt;mBEj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmpbaba</span><span class="p">)</span>
    <span class="n">wOvvO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,nMeJ-&gt;MbeJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmpabab</span><span class="p">)</span>
    <span class="n">tmpabab</span> <span class="o">=</span> <span class="n">tmpbaba</span> <span class="o">=</span> <span class="n">tilab</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">u1a</span> <span class="o">+=</span> <span class="n">fova</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">u1a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,ae-&gt;ia&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">Fvva</span><span class="p">)</span>
    <span class="n">u1a</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mi-&gt;ia&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">Fooa</span><span class="p">)</span>
    <span class="n">u1a</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imea,me-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">Fova</span><span class="p">)</span>
    <span class="n">u1a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iMaE,ME-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">Fovb</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">+=</span> <span class="n">fovb</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">u1b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,ae-&gt;ia&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">Fvvb</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mi-&gt;ia&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">Foob</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imea,me-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">Fovb</span><span class="p">)</span>
    <span class="n">u1b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mIeA,me-&gt;IA&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">Fova</span><span class="p">)</span>

    <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span>
    <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">-=</span> <span class="n">eris_oovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">+=</span> <span class="n">eris_ovvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">oovv</span> <span class="o">=</span> <span class="n">eris_oovv</span> <span class="o">-</span> <span class="n">eris_ovvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u1a</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,niaf-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span>      <span class="n">oovv</span><span class="p">)</span>
    <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mjbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span>      <span class="n">oovv</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1aa</span><span class="p">)</span>
    <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">oovv</span> <span class="o">=</span> <span class="n">tmp1aa</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_OOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">)</span>
    <span class="n">eris_OVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVO</span><span class="p">)</span>
    <span class="n">wOVVO</span> <span class="o">-=</span> <span class="n">eris_OOVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">wOVVO</span> <span class="o">+=</span> <span class="n">eris_OVVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">OOVV</span> <span class="o">=</span> <span class="n">eris_OOVV</span> <span class="o">-</span> <span class="n">eris_OVVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u1b</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,niaf-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span>      <span class="n">OOVV</span><span class="p">)</span>
    <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mjbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span>      <span class="n">OOVV</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1bb</span><span class="p">)</span>
    <span class="n">eris_OVVO</span> <span class="o">=</span> <span class="n">eris_OOVV</span> <span class="o">=</span> <span class="n">OOVV</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_ooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">)</span>
    <span class="n">eris_ovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVO</span><span class="p">)</span>
    <span class="n">woVVo</span> <span class="o">-=</span> <span class="n">eris_ooVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">woVvO</span> <span class="o">+=</span> <span class="n">eris_ovVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">u1b</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,nfAI-&gt;IA&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovVO</span><span class="p">)</span>
    <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,meBJ-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovVO</span><span class="p">)</span>
    <span class="n">tmp1ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,mjBE-&gt;mBjI&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooVV</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mBiJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">)</span>
    <span class="n">eris_ooVV</span> <span class="o">=</span> <span class="n">eris_ovVo</span> <span class="o">=</span> <span class="n">tmp1ab</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">eris_OOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">)</span>
    <span class="n">eris_OVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvo</span><span class="p">)</span>
    <span class="n">wOvvO</span> <span class="o">-=</span> <span class="n">eris_OOvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">wOvVo</span> <span class="o">+=</span> <span class="n">eris_OVvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">u1a</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NF,NFai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OVvo</span><span class="p">)</span>
    <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MEbj-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OVvo</span><span class="p">)</span>
    <span class="n">tmp1ba</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,MJbe-&gt;MbJi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOvv</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MbIj-&gt;jIbA&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1ba</span><span class="p">)</span>
    <span class="n">eris_OOvv</span> <span class="o">=</span> <span class="n">eris_OVvO</span> <span class="o">=</span> <span class="n">tmp1ba</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">u2aa</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imae,mbej-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">wovvo</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iMaE,MbEj-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">wOvVo</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imae,mbej-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">wOVVO</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mIeA,mBeJ-&gt;IJAB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">woVvO</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imae,mBeJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">woVvO</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iMaE,MBEJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">wOVVO</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iMeA,MbeJ-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">wOvvO</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IMAE,MbEj-&gt;jIbA&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">wOvVo</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mIeA,mbej-&gt;jIbA&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">wovvo</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mIaE,mBEj-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">woVVo</span><span class="p">)</span>
    <span class="n">wovvo</span> <span class="o">=</span> <span class="n">wOVVO</span> <span class="o">=</span> <span class="n">woVvO</span> <span class="o">=</span> <span class="n">wOvVo</span> <span class="o">=</span> <span class="n">woVVo</span> <span class="o">=</span> <span class="n">wOvvO</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">Ftmpa</span> <span class="o">=</span> <span class="n">Fvva</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,me-&gt;be&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">Fova</span><span class="p">)</span>
    <span class="n">Ftmpb</span> <span class="o">=</span> <span class="n">Fvvb</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,me-&gt;be&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">Fovb</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijae,be-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">Ftmpa</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijae,be-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">Ftmpb</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJaE,BE-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">Ftmpb</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeA,be-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">Ftmpa</span><span class="p">)</span>
    <span class="n">Ftmpa</span> <span class="o">=</span> <span class="n">Fooa</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,me-&gt;mj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">Fova</span><span class="p">)</span>
    <span class="n">Ftmpb</span> <span class="o">=</span> <span class="n">Foob</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,me-&gt;mj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">Fovb</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imab,mj-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">Ftmpa</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;imab,mj-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">Ftmpb</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iMaB,MJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">Ftmpb</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mIaB,mj-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">Ftmpa</span><span class="p">)</span>

    <span class="c1">#:eris_vvvv = ao2mo.restore(1, np.asarray(eris.vvvv), nvirb)</span>
    <span class="c1">#:eris_VVVV = ao2mo.restore(1, np.asarray(eris.VVVV), nvirb)</span>
    <span class="c1">#:eris_vvVV = _restore(np.asarray(eris.vvVV), nvira, nvirb)</span>
    <span class="c1">#:u2aa += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tauaa, eris_vvvv) * .5</span>
    <span class="c1">#:u2bb += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, taubb, eris_VVVV) * .5</span>
    <span class="c1">#:u2ab += lib.einsum(&#39;iJeF,aeBF-&gt;iJaB&#39;, tauab, eris_vvVV)</span>
    <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
    <span class="n">_add_vvvv_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="p">(</span><span class="n">tauaa</span><span class="p">,</span><span class="n">tauab</span><span class="p">,</span><span class="n">taubb</span><span class="p">),</span> <span class="n">eris</span><span class="p">,</span> <span class="p">(</span><span class="n">u2aa</span><span class="p">,</span><span class="n">u2ab</span><span class="p">,</span><span class="n">u2bb</span><span class="p">))</span>

    <span class="n">eris_oovo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovo</span><span class="p">)</span>
    <span class="n">eris_OOVO</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVO</span><span class="p">)</span>
    <span class="n">eris_ooVO</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVO</span><span class="p">)</span>
    <span class="n">eris_OOvo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvo</span><span class="p">)</span>
    <span class="n">oovo</span> <span class="o">=</span> <span class="n">eris_oovo</span> <span class="o">-</span> <span class="n">eris_oovo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">OOVO</span> <span class="o">=</span> <span class="n">eris_OOVO</span> <span class="o">-</span> <span class="n">eris_OOVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mibj-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">oovo</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mibj-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OOVO</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,miBJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooVO</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MJbi-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOvo</span><span class="p">)</span>
    <span class="n">eris_oovo</span> <span class="o">=</span> <span class="n">eris_ooVO</span> <span class="o">=</span> <span class="n">eris_OOVO</span> <span class="o">=</span> <span class="n">eris_OOvo</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">u2aa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">u2bb</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">u2aa</span> <span class="o">=</span> <span class="n">u2aa</span> <span class="o">-</span> <span class="n">u2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">u2aa</span> <span class="o">=</span> <span class="n">u2aa</span> <span class="o">-</span> <span class="n">u2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">=</span> <span class="n">u2bb</span> <span class="o">-</span> <span class="n">u2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">=</span> <span class="n">u2bb</span> <span class="o">-</span> <span class="n">u2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

    <span class="n">eia_a</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;i-a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">fooa</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(),</span> <span class="n">fvva</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
    <span class="n">eia_b</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;i-a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">foob</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(),</span> <span class="n">fvvb</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
    <span class="n">u1a</span> <span class="o">/=</span> <span class="n">eia_a</span>
    <span class="n">u1b</span> <span class="o">/=</span> <span class="n">eia_b</span>

    <span class="n">u2aa</span> <span class="o">/=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia+jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">eia_a</span><span class="p">,</span> <span class="n">eia_a</span><span class="p">)</span>
    <span class="n">u2ab</span> <span class="o">/=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia+jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">eia_a</span><span class="p">,</span> <span class="n">eia_b</span><span class="p">)</span>
    <span class="n">u2bb</span> <span class="o">/=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia+jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">eia_b</span><span class="p">,</span> <span class="n">eia_b</span><span class="p">)</span>

    <span class="n">time0</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;update t1 t2&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
    <span class="n">t1new</span> <span class="o">=</span> <span class="n">u1a</span><span class="p">,</span> <span class="n">u1b</span>
    <span class="n">t2new</span> <span class="o">=</span> <span class="n">u2aa</span><span class="p">,</span> <span class="n">u2ab</span><span class="p">,</span> <span class="n">u2bb</span>
    <span class="k">return</span> <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span>


<span class="k">def</span> <span class="nf">get_nocc</span><span class="p">(</span><span class="n">mycc</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nocc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nocc</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">nocca</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">-</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
        <span class="n">noccb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">-</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
        <span class="c1">#assert(nocca &gt; 0 and noccb &gt; 0)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frozen</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frozen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frozen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
<span class="c1"># The same frozen orbital indices for alpha and beta orbitals</span>
            <span class="n">frozen</span> <span class="o">=</span> <span class="p">[</span><span class="n">frozen</span><span class="p">,</span> <span class="n">frozen</span><span class="p">]</span>
        <span class="n">occidxa</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">occidxa</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frozen</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">occidxb</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">occidxb</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frozen</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">nocca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">occidxa</span><span class="p">)</span>
        <span class="n">noccb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">occidxb</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span>

<span class="k">def</span> <span class="nf">get_nmo</span><span class="p">(</span><span class="n">mycc</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nmo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nmo</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">nmoa</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
        <span class="n">nmob</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">nmoa</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">)</span>
        <span class="n">nmob</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nmoa</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">nmob</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span>


<span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
    <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
    <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
    <span class="n">fova</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
    <span class="n">fovb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
    <span class="n">e</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ia&#39;</span><span class="p">,</span> <span class="n">fova</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ia&#39;</span><span class="p">,</span> <span class="n">fovb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,iajb&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">-=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ibja&#39;</span><span class="p">,</span><span class="n">t2aa</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,iajb&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">,</span><span class="n">eris_OVOV</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">-=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ibja&#39;</span><span class="p">,</span><span class="n">t2bb</span><span class="p">,</span><span class="n">eris_OVOV</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span>      <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJaB,iaJB&#39;</span><span class="p">,</span><span class="n">t2ab</span><span class="p">,</span><span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb,iajb&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb,ibja&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb,iajb&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">eris_OVOV</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb,ibja&#39;</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">eris_OVOV</span><span class="p">)</span>
    <span class="n">e</span> <span class="o">+=</span>     <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb,iajb&#39;</span><span class="p">,</span><span class="n">t1a</span><span class="p">,</span><span class="n">t1b</span><span class="p">,</span><span class="n">eris_ovOV</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">e</span><span class="o">.</span><span class="n">real</span>



<div class="viewcode-block" id="UCCSD"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.uccsd.UCCSD">[docs]</a><span class="k">class</span> <span class="nc">UCCSD</span><span class="p">(</span><span class="n">rccsd</span><span class="o">.</span><span class="n">RCCSD</span><span class="p">):</span>

<span class="c1"># argument frozen can be</span>
<span class="c1"># * An integer : The same number of inner-most alpha and beta orbitals are frozen</span>
<span class="c1"># * One list : Same alpha and beta orbital indices to be frozen</span>
<span class="c1"># * A pair of list : First list is the orbital indices to be frozen for alpha</span>
<span class="c1">#       orbitals, second list is for beta orbitals</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mo_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">rccsd</span><span class="o">.</span><span class="n">RCCSD</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">frozen</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">,</span> <span class="n">mo_occ</span><span class="p">)</span>
        <span class="c1"># Spin-orbital CCSD needs a stricter tolerance than spatial-orbital</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="s1">&#39;mo_energy&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="n">orbspin_of_sorted_mo_energy</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span><span class="o">.</span><span class="n">union</span><span class="p">([</span><span class="s1">&#39;orbspin&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Initialize integrals and orbspin&#39;&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nocc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nocc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nocca</span> <span class="o">+</span> <span class="n">noccb</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nmo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nmo</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">nmoa</span> <span class="o">+</span> <span class="n">nmob</span>

    <span class="n">get_nocc</span> <span class="o">=</span> <span class="n">get_nocc</span>
    <span class="n">get_nmo</span> <span class="o">=</span> <span class="n">get_nmo</span>

    <span class="k">def</span> <span class="nf">init_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nocc</span><span class="p">()</span>

        <span class="n">fooa</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span>
        <span class="n">foob</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
        <span class="n">fova</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
        <span class="n">fovb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
        <span class="n">fvva</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span>
        <span class="n">fvvb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span>
        <span class="n">eia_a</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;i-a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">fooa</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(),</span> <span class="n">fvva</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>
        <span class="n">eia_b</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;i-a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">foob</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(),</span> <span class="n">fvvb</span><span class="o">.</span><span class="n">diagonal</span><span class="p">())</span>

        <span class="n">t1a</span> <span class="o">=</span> <span class="n">fova</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">/</span> <span class="n">eia_a</span>
        <span class="n">t1b</span> <span class="o">=</span> <span class="n">fovb</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">/</span> <span class="n">eia_b</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">t2aa</span> <span class="o">=</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia+jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">eia_a</span><span class="p">,</span> <span class="n">eia_a</span><span class="p">)</span>
        <span class="n">t2ab</span> <span class="o">=</span> <span class="n">eris_ovOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia+jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">eia_a</span><span class="p">,</span> <span class="n">eia_b</span><span class="p">)</span>
        <span class="n">t2bb</span> <span class="o">=</span> <span class="n">eris_OVOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ia+jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">eia_b</span><span class="p">,</span> <span class="n">eia_b</span><span class="p">)</span>
        <span class="n">t2aa</span> <span class="o">=</span> <span class="n">t2aa</span> <span class="o">-</span> <span class="n">t2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2bb</span> <span class="o">-</span> <span class="n">t2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">e</span>  <span class="o">=</span>      <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJaB,iaJB&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,iajb&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">-=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ibja&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">+=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,iajb&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">-=</span> <span class="mf">0.25</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ibja&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">real</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Init t2, MP2 energy = </span><span class="si">%.15g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;init mp2&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span><span class="p">,</span> <span class="p">(</span><span class="n">t1a</span><span class="p">,</span><span class="n">t1b</span><span class="p">),</span> <span class="p">(</span><span class="n">t2aa</span><span class="p">,</span><span class="n">t2ab</span><span class="p">,</span><span class="n">t2bb</span><span class="p">)</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span>

    <span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mbpt2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccsd</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">mbpt2</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mbpt2</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Ground-state unrestricted (U)CCSD.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            mbpt2 : bool</span>
<span class="sd">                Use one-shot MBPT2 approximation to CCSD.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eris</span> <span class="o">=</span> <span class="n">eris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_flags</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">mbpt2</span><span class="p">:</span>
            <span class="n">cctyp</span> <span class="o">=</span> <span class="s1">&#39;MBPT2&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cctyp</span> <span class="o">=</span> <span class="s1">&#39;UCCSD&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> \
                    <span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                           <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">tolnormt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span><span class="p">,</span>
                           <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;UCCSD converged&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;UCCSD not converged&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">e_tot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;E_corr = </span><span class="si">%.16g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;E(</span><span class="si">%s</span><span class="s1">) = </span><span class="si">%.16g</span><span class="s1">  E_corr = </span><span class="si">%.16g</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="n">cctyp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>

    <span class="k">def</span> <span class="nf">solve_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">uccsd_lambda_slow</span> <span class="k">as</span> <span class="n">uccsd_lambda</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged_lambda</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">=</span> \
                <span class="n">uccsd_lambda</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span>
                                    <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                    <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span><span class="p">,</span>
                                    <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>

    <span class="k">def</span> <span class="nf">ccsd_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">uccsd_t</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uccsd_t</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">uccsd_t</span> <span class="o">=</span> <span class="n">ccsd_t</span>

    <span class="k">def</span> <span class="nf">make_rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Un-relaxed 1-particle density matrix in MO space</span>

<span class="sd">        Returns:</span>
<span class="sd">            dm1a, dm1b</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">uccsd_rdm_slow</span> <span class="k">as</span> <span class="n">uccsd_rdm</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span>
        <span class="k">if</span> <span class="n">l2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lambda</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uccsd_rdm</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_rdm2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;2-particle density matrix in spin-oribital basis.</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">uccsd_rdm_slow</span> <span class="k">as</span> <span class="n">uccsd_rdm</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span>
        <span class="k">if</span> <span class="n">l2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lambda</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">uccsd_rdm</span><span class="o">.</span><span class="n">make_rdm2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_ERIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">update_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">nip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nip</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nip</span>

    <span class="k">def</span> <span class="nf">nea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nea</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nea</span>

    <span class="k">def</span> <span class="nf">nee</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nee</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nee</span>

    <span class="k">def</span> <span class="nf">ipccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="c1"># Ref: Tu, Wang, and Li, J. Chem. Phys. 136, 174102 (2012) Eqs.(8)-(9)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ip_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ERISspin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ip</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ip</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">r2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>

        <span class="c1"># Eq. (8)</span>
        <span class="n">Hr1</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,mie-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,m-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nmie,mne-&gt;i&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wooov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>

        <span class="c1"># Eq. (9)</span>
        <span class="n">Hr2</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ije-&gt;ija&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,mja-&gt;ija&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">tmp1</span> <span class="o">-</span> <span class="n">tmp1</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maji,m-&gt;ija&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovoo</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mna-&gt;ija&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Woooo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">tmp2</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maei,mje-&gt;ija&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">tmp2</span> <span class="o">-</span> <span class="n">tmp2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnf-&gt;e&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfne,mnf-&gt;e&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;e,ijae-&gt;ija&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ip</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">ipccsd_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ip_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ERISspin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ip</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">)</span>
        <span class="n">Fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">=</span> <span class="o">-</span><span class="n">Fo</span>
        <span class="n">Hr2</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i-j+a-&gt;ija&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>

        <span class="n">Woooo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Woooo</span><span class="p">)</span>
        <span class="n">Woo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">Woo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">Woooo</span><span class="p">)</span>
        <span class="n">Woo</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijji-&gt;ij&#39;</span><span class="p">,</span> <span class="n">Woooo</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">Woo</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Wov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">Wov</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">Wov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iajb,ijab-&gt;ija&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iajb,ijab-&gt;ijb&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ip</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r2_tril</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2_tril</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="p">))</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="o">-</span><span class="n">r2_tril</span><span class="p">,</span> <span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">otril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">otril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">otril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[</span><span class="n">nocc</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eaccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="c1"># Ref: Nooijen and Bartlett, J. Chem. Phys. 102, 3629 (1994) Eqs.(30)-(31)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ea_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ERISspin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ea</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span><span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ea</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>

        <span class="n">Hr1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ac,c-&gt;a&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span><span class="n">r1</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ld,lad-&gt;a&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ac,jcb-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr2</span>  <span class="o">=</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">-</span> <span class="n">tmp1</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lj,lab-&gt;jab&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>

        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lcad,lcd-&gt;a&#39;</span><span class="p">,</span><span class="n">eris_ovvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ldac,lcd-&gt;a&#39;</span><span class="p">,</span><span class="n">eris_ovvv</span><span class="p">,</span><span class="n">r2</span><span class="p">)</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jd,c-&gt;jcd&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">tau2</span> <span class="o">=</span> <span class="n">tau2</span> <span class="o">-</span> <span class="n">tau2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mcad,jcd-&gt;maj&#39;</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maj-&gt;jab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">-</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,jef-&gt;mnj&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">25</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mnj-&gt;jab&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ndlc,lcd-&gt;n&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,n-&gt;a&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kcld,lcd-&gt;k&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;k,kjab-&gt;jab&#39;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;lbdj,lad-&gt;jab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abcj,c-&gt;jab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Wvvvo</span><span class="p">,</span> <span class="n">r1</span><span class="p">)</span>

        <span class="n">eris_vvvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;acbd,jcd-&gt;jab&#39;</span><span class="p">,</span><span class="n">eris_vvvv</span><span class="p">,</span><span class="n">tau2</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ea</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eaccsd_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ea_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eris</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">_ERISspin</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ea</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">Fo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Foo</span><span class="p">)</span>
        <span class="n">Fv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(</span><span class="n">imds</span><span class="o">.</span><span class="n">Fvv</span><span class="p">)</span>
        <span class="n">Hr1</span> <span class="o">=</span> <span class="n">Fv</span>
        <span class="n">Hr2</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-j+a+b-&gt;jab&#39;</span><span class="p">,</span> <span class="n">Fo</span><span class="p">,</span> <span class="n">Fv</span><span class="p">,</span> <span class="n">Fv</span><span class="p">)</span>
        <span class="n">Wov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Wovvo</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">Wov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">Wov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iajb,ijab-&gt;jab&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iajb,ijab-&gt;iab&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span>
        <span class="n">Wvv</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maab-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">)</span>
        <span class="n">Wvv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mbaa-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">)</span>
        <span class="n">Wvv</span> <span class="o">=</span> <span class="n">Wvv</span> <span class="o">+</span> <span class="n">Wvv</span><span class="o">.</span><span class="n">T</span>
        <span class="n">eris_vvvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">)</span>
        <span class="n">Wvv</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aabb-&gt;ab&#39;</span><span class="p">,</span> <span class="n">eris_vvvv</span><span class="p">)</span>
        <span class="n">Wvv</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;abba-&gt;ab&#39;</span><span class="p">,</span> <span class="n">eris_vvvv</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">Wvv</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,manb-&gt;ab&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Wvv</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,mbna-&gt;ab&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Hr2</span> <span class="o">+=</span> <span class="n">Wvv</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ea</span><span class="p">(</span><span class="n">Hr1</span><span class="p">,</span><span class="n">Hr2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">vector</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">r1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nvir</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">r2_tril</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nvir</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2_tril</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span><span class="o">-</span><span class="n">r2_tril</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span> <span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r1</span><span class="p">,</span><span class="n">r2</span><span class="p">):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nocc</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">r1</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">nvir</span><span class="p">]</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">vtril</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span>
                    <span class="n">vtril</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvir</span><span class="o">+</span><span class="n">vtril</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[</span><span class="n">nvir</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eeccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Calculate N-electron neutral excitations via EE-EOM-CCSD.</span>

<span class="sd">        Kwargs:</span>
<span class="sd">            nroots : int</span>
<span class="sd">                Number of roots (eigenvalues) requested</span>
<span class="sd">            koopmans : bool</span>
<span class="sd">                Calculate Koopmans&#39;-like (1p1h) excitations only, targeting via</span>
<span class="sd">                overlap.</span>
<span class="sd">            guess : list of ndarray</span>
<span class="sd">                List of guess vectors to use for targeting via overlap.</span>
<span class="sd">        &#39;&#39;&#39;</span>

        <span class="n">spinvec_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nee</span><span class="p">()</span>
        <span class="n">nroots</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nroots</span><span class="p">,</span> <span class="n">spinvec_size</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ip_imds</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ea_imds</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="n">orbspin_of_sorted_mo_energy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="n">diag_ee</span><span class="p">,</span> <span class="n">diag_sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()</span>
        <span class="n">guess_ee</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">guess_sf</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">guess</span> <span class="ow">and</span> <span class="n">guess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">spinvec_size</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ee</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spin2spatial</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">),</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">spin2spatial</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">g</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span><span class="p">:</span>
                    <span class="n">guess_ee</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin2spatial</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
                    <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spin2spatial</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_eomsf</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
                    <span class="n">guess_sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="n">r1</span> <span class="o">=</span> <span class="n">r2</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">nroots_ee</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_ee</span><span class="p">)</span>
            <span class="n">nroots_sf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_sf</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">guess</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag_ee</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
                    <span class="n">guess_ee</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">guess_sf</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
            <span class="n">nroots_ee</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_ee</span><span class="p">)</span>
            <span class="n">nroots_sf</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess_sf</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">diag_ee</span><span class="p">)[:</span><span class="n">nroots</span><span class="p">]</span>
            <span class="n">dsf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">diag_sf</span><span class="p">)[:</span><span class="n">nroots</span><span class="p">]</span>
            <span class="n">dmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">dee</span><span class="p">,</span><span class="n">dsf</span><span class="p">]))[</span><span class="n">nroots</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nroots_ee</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dee</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">)</span>
            <span class="n">nroots_sf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">dsf</span> <span class="o">&lt;=</span> <span class="n">dmax</span><span class="p">)</span>
            <span class="n">guess_ee</span> <span class="o">=</span> <span class="n">guess_sf</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">e0</span> <span class="o">=</span> <span class="n">e1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">v0</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">nroots_ee</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd</span><span class="p">(</span><span class="n">nroots_ee</span><span class="p">,</span> <span class="n">koopmans</span><span class="p">,</span> <span class="n">guess_ee</span><span class="p">,</span> <span class="n">diag_ee</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nroots_ee</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">e0</span><span class="p">,</span> <span class="n">v0</span> <span class="o">=</span> <span class="p">[</span><span class="n">e0</span><span class="p">],</span> <span class="p">[</span><span class="n">v0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nroots_sf</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">e1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eomsf_ccsd</span><span class="p">(</span><span class="n">nroots_sf</span><span class="p">,</span> <span class="n">koopmans</span><span class="p">,</span> <span class="n">guess_sf</span><span class="p">,</span> <span class="n">diag_sf</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">nroots_sf</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">e1</span><span class="p">,</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">[</span><span class="n">e1</span><span class="p">],</span> <span class="p">[</span><span class="n">v1</span><span class="p">]</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">e0</span><span class="p">,</span><span class="n">e1</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v0</span> <span class="o">+</span> <span class="n">v1</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">e</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="p">[</span><span class="n">v</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">]</span>


    <span class="k">def</span> <span class="nf">eomee_ccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nocc</span><span class="p">()</span>
        <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nmo</span><span class="p">()</span>
        <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">nmoa</span><span class="o">-</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nmob</span><span class="o">-</span><span class="n">noccb</span>

        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmob</span><span class="p">),</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nroots</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nroots</span><span class="p">]:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">diag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">eig</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd_matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                             <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                             <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eomee_ccsd_matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                             <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                             <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eee</span> <span class="o">=</span> <span class="n">eee</span><span class="o">.</span><span class="n">real</span>

        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eee</span><span class="p">],</span> <span class="p">[</span><span class="n">evecs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="p">(</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmob</span><span class="p">),</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
            <span class="n">qpwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-EE root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">qpwt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-EE-CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span>

    <span class="k">def</span> <span class="nf">eomsf_ccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">koopmans</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">diag</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">diag</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">diag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eeccsd_diag</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nocc</span><span class="p">()</span>
        <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nmo</span><span class="p">()</span>
        <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">nmoa</span><span class="o">-</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nmob</span><span class="o">-</span><span class="n">noccb</span>

        <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">guess</span><span class="p">:</span>
            <span class="n">user_guess</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span> <span class="o">==</span> <span class="n">nroots</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">guess</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">g</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">diag</span><span class="o">.</span><span class="n">size</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">diag</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
            <span class="n">guess</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">koopmans</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="p">(</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="o">.</span><span class="mi">9</span><span class="p">:</span>
                        <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>
                        <span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="n">nroots</span><span class="p">:</span>
                            <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idx</span><span class="p">[:</span><span class="n">nroots</span><span class="p">]:</span>
                    <span class="n">g</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">diag</span><span class="p">)</span>
                    <span class="n">g</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="n">guess</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">g</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">precond</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">e0</span><span class="p">,</span> <span class="n">x0</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">r</span><span class="o">/</span><span class="p">(</span><span class="n">e0</span><span class="o">-</span><span class="n">diag</span><span class="o">+</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">eig</span>
        <span class="k">if</span> <span class="n">user_guess</span> <span class="ow">or</span> <span class="n">koopmans</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">pickeig</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">nr</span><span class="p">,</span> <span class="n">envs</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">linalg_helper</span><span class="o">.</span><span class="n">_gen_x0</span><span class="p">(</span><span class="n">envs</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">envs</span><span class="p">[</span><span class="s1">&#39;xs&#39;</span><span class="p">])</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">guess</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">(),</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span> <span class="p">)</span>
                <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">v</span><span class="p">[:,</span><span class="n">idx</span><span class="p">]</span><span class="o">.</span><span class="n">real</span><span class="p">,</span> <span class="n">idx</span>
            <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eomsf_ccsd_matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span> <span class="n">pick</span><span class="o">=</span><span class="n">pickeig</span><span class="p">,</span>
                             <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                             <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="n">eig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">eomsf_ccsd_matvec</span><span class="p">,</span> <span class="n">guess</span><span class="p">,</span> <span class="n">precond</span><span class="p">,</span>
                             <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                             <span class="n">max_space</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_space</span><span class="p">,</span> <span class="n">nroots</span><span class="o">=</span><span class="n">nroots</span><span class="p">,</span>
                             <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">eee</span> <span class="o">=</span> <span class="n">eee</span><span class="o">.</span><span class="n">real</span>

        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">eee</span><span class="p">],</span> <span class="p">[</span><span class="n">evecs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">vn</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nroots</span><span class="p">),</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span><span class="p">):</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="n">vn</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="p">(</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">))</span>
            <span class="n">qpwt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-SF root </span><span class="si">%d</span><span class="s1"> E = </span><span class="si">%.16g</span><span class="s1">  qpwt = </span><span class="si">%.6g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">en</span><span class="p">,</span> <span class="n">qpwt</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;EOM-SF-CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nroots</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evecs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">eee</span><span class="p">,</span> <span class="n">evecs</span>

    <span class="c1"># Ref: Wang, Tu, and Wang, J. Chem. Theory Comput. 10, 5567 (2014) Eqs.(9)-(10)</span>
    <span class="c1"># Note: Last line in Eq. (10) is superfluous.</span>
    <span class="c1"># See, e.g. Gwaltney, Nooijen, and Barlett, Chem. Phys. Lett. 248, 189 (1996)</span>
    <span class="k">def</span> <span class="nf">eomee_ccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">vector</span><span class="p">)</span>
        <span class="n">r1a</span><span class="p">,</span> <span class="n">r1b</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="n">r2aa</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">,</span> <span class="n">r2bb</span> <span class="o">=</span> <span class="n">r2</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">Hr1a</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr1a</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fova</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,iMaE-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fovb</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr1b</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">Hr1b</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fovb</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,mIeA-&gt;IA&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">Fova</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>

        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woooo</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">25</span>
        <span class="n">Hr2bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOO</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">25</span>
        <span class="n">Hr2ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiJ,mNaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;BE,iJaE-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,iJeA-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJ,iMaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,mIaB-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>

        <span class="c1">#:tau2aa, tau2ab, tau2bb = make_tau(r2, r1, t1, 2)</span>
        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvira,nvira)</span>
        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:eris_OVVV = lib.unpack_tril(np.asarray(eris.OVVV).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvirb,nvirb)</span>
        <span class="c1">#:Hr1a += lib.einsum(&#39;mfae,imef-&gt;ia&#39;, eris_ovvv, r2aa)</span>
        <span class="c1">#:tmpaa = lib.einsum(&#39;meaf,ijef-&gt;maij&#39;, eris_ovvv, tau2aa)</span>
        <span class="c1">#:Hr2aa+= lib.einsum(&#39;mb,maij-&gt;ijab&#39;, t1a, tmpaa)</span>
        <span class="c1">#:tmpa = lib.einsum(&#39;mfae,me-&gt;af&#39;, eris_ovvv, r1a)</span>
        <span class="c1">#:tmpa-= lib.einsum(&#39;meaf,me-&gt;af&#39;, eris_ovvv, r1a)</span>

        <span class="c1">#:Hr1b += lib.einsum(&#39;mfae,imef-&gt;ia&#39;, eris_OVVV, r2bb)</span>
        <span class="c1">#:tmpbb = lib.einsum(&#39;meaf,ijef-&gt;maij&#39;, eris_OVVV, tau2bb)</span>
        <span class="c1">#:Hr2bb+= lib.einsum(&#39;mb,maij-&gt;ijab&#39;, t1b, tmpbb)</span>
        <span class="c1">#:tmpb = lib.einsum(&#39;mfae,me-&gt;af&#39;, eris_OVVV, r1b)</span>
        <span class="c1">#:tmpb-= lib.einsum(&#39;meaf,me-&gt;af&#39;, eris_OVVV, r1b)</span>

        <span class="c1">#:Hr1b += lib.einsum(&#39;mfAE,mIfE-&gt;IA&#39;, eris_ovVV, r2ab)</span>
        <span class="c1">#:tmpab = lib.einsum(&#39;meAF,iJeF-&gt;mAiJ&#39;, eris_ovVV, tau2ab)</span>
        <span class="c1">#:Hr2ab-= lib.einsum(&#39;mb,mAiJ-&gt;iJbA&#39;, t1a, tmpab)</span>
        <span class="c1">#:tmpb-= lib.einsum(&#39;meAF,me-&gt;AF&#39;, eris_ovVV, r1a)</span>

        <span class="c1">#:Hr1a += lib.einsum(&#39;MFae,iMeF-&gt;ia&#39;, eris_OVvv, r2ab)</span>
        <span class="c1">#:tmpba =-lib.einsum(&#39;MEaf,iJfE-&gt;MaiJ&#39;, eris_OVvv, tau2ab)</span>
        <span class="c1">#:Hr2ab+= lib.einsum(&#39;MB,MaiJ-&gt;iJaB&#39;, t1b, tmpba)</span>
        <span class="c1">#:tmpa-= lib.einsum(&#39;MEaf,ME-&gt;af&#39;, eris_OVvv, r1b)</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">r2aa</span><span class="p">,</span> <span class="n">r1a</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">tmpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">))</span>
        <span class="n">tmpb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">))</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,imef-&gt;ia&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijef-&gt;maij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2aa</span><span class="p">)</span>
            <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmpaa</span><span class="p">)</span>
            <span class="n">tmpa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">tmpaa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tau2bb</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">r2bb</span><span class="p">,</span> <span class="n">r1b</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,imef-&gt;ia&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,ijef-&gt;maij&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">tau2bb</span><span class="p">)</span>
            <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maij-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmpbb</span><span class="p">)</span>
            <span class="n">tmpb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,me-&gt;af&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">tmpbb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tau2bb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tau2ab</span> <span class="o">=</span> <span class="n">make_tau_ab</span><span class="p">(</span><span class="n">r2ab</span><span class="p">,</span> <span class="n">r1</span> <span class="p">,</span> <span class="n">t1</span> <span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfAE,mIfE-&gt;IA&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meAF,iJeF-&gt;mAiJ&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">)</span>
            <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mAiJ-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmpab</span><span class="p">)</span>
            <span class="n">tmpb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meAF,me-&gt;AF&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">r1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">tmpab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFae,iMeF-&gt;ia&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmpba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEaf,iJfE-&gt;MaiJ&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">)</span>
            <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MaiJ-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmpba</span><span class="p">)</span>
            <span class="n">tmpa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEaf,ME-&gt;af&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">r1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">tmpba</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">tau2ab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2aa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;af,ijfb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;af,ijfb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;af,iJfB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;AF,iJbF-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">r2aa</span><span class="p">,</span> <span class="n">r1a</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tauaa</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">t2aa</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,ijef-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2aa</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpaa</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="n">tau2aa</span> <span class="o">=</span> <span class="n">tauaa</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tau2bb</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">r2bb</span><span class="p">,</span> <span class="n">r1b</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">t2bb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
        <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,ijef-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">tau2bb</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpbb</span><span class="p">,</span> <span class="n">taubb</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.25</span>
        <span class="n">tau2bb</span> <span class="o">=</span> <span class="n">taubb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tau2ab</span> <span class="o">=</span> <span class="n">make_tau_ab</span><span class="p">(</span><span class="n">r2ab</span><span class="p">,</span> <span class="n">r1</span> <span class="p">,</span> <span class="n">t1</span> <span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">tauab</span> <span class="o">=</span> <span class="n">make_tau_ab</span><span class="p">(</span><span class="n">t2ab</span><span class="p">,</span> <span class="n">t1</span> <span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,iJeF-&gt;mNiJ&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiJ,mNaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmpab</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
        <span class="n">tau2ab</span> <span class="o">=</span> <span class="n">tauab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tmpa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,imef-&gt;ni&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">tmpa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;neMF,iMeF-&gt;ni&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">tmpb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,imef-&gt;ni&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">tmpb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfNE,mIfE-&gt;NI&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,ni-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">)</span>
        <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,ni-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJ,iMaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,mIaB-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>

        <span class="n">tmp1a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">tmp1a</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfne,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">tmp1a</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;neMF,MF-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">tmp1b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">tmp1b</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfne,mf-&gt;en&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">tmp1b</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfNE,mf-&gt;EN&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">tmpa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;en,nb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">tmp1a</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="n">tmpa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnfb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">tmpa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,mNbF-&gt;eb&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">tmpb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;en,nb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">tmp1b</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
        <span class="n">tmpb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnfb-&gt;eb&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">tmpb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nfME,nMfB-&gt;EB&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eb,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eb,ijae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;EB,iJaE-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eb,iJeA-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">eirs_ovov</span> <span class="o">=</span> <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2aa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbij,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovoo</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbij,ma-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVOO</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBiJ,ma-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVoO</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbJi,MA-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvOo</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>

        <span class="n">Hr1a</span><span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wooov</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr1a</span><span class="o">-=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiE,mNaE-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr1b</span><span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOV</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">Hr1b</span><span class="o">-=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MnIe,nMeA-&gt;IA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOoOv</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">tmpa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,me-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wooov</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">tmpa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nMiE,ME-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">tmpb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,me-&gt;ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOV</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
        <span class="n">tmpb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NmIe,me-&gt;NI&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOoOv</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni,njab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni,njab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ni,nJaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">tmpa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NI,jNaB-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">tmpb</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">):</span>
            <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ejab,ie-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wvovv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1a</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eJaB,ie-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1a</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">):</span>
            <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ejab,ie-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wVOVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1b</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;EjBa,IE-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1b</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>

        <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maei,me-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">wovvo</span><span class="p">,</span><span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr1a</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MaEi,ME-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">wOvVo</span><span class="p">,</span><span class="n">r1b</span><span class="p">)</span>
        <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;maei,me-&gt;ia&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">wOVVO</span><span class="p">,</span><span class="n">r1b</span><span class="p">)</span>
        <span class="n">Hr1b</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mAeI,me-&gt;IA&#39;</span><span class="p">,</span><span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">,</span><span class="n">r1a</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovvo</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbEj,iMaE-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvVo</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVVO</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBeJ,mIeA-&gt;IJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBeJ,imae-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">,</span> <span class="n">r2aa</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MBEJ,iMaE-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVVO</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBEj,mIaE-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,mIeA-&gt;jIbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovvo</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbEj,IMAE-&gt;jIbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvVo</span><span class="p">,</span> <span class="n">r2bb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbeJ,iMeA-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvvO</span><span class="p">,</span> <span class="n">r2ab</span><span class="p">)</span>

        <span class="c1">#:eris_vvvv = ao2mo.restore(1, np.asarray(eris.vvvv), nvirb)</span>
        <span class="c1">#:eris_VVVV = ao2mo.restore(1, np.asarray(eris.VVVV), nvirb)</span>
        <span class="c1">#:eris_vvVV = _restore(np.asarray(eris.vvVV), nvira, nvirb)</span>
        <span class="c1">#:Hr2aa += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2aa, eris_vvvv) * .5</span>
        <span class="c1">#:Hr2bb += lib.einsum(&#39;ijef,aebf-&gt;ijab&#39;, tau2bb, eris_VVVV) * .5</span>
        <span class="c1">#:Hr2ab += lib.einsum(&#39;iJeF,aeBF-&gt;iJaB&#39;, tau2ab, eris_vvVV)</span>
        <span class="n">tau2aa</span><span class="p">,</span> <span class="n">tau2ab</span><span class="p">,</span> <span class="n">tau2bb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">_add_vvvv_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="p">(</span><span class="n">tau2aa</span><span class="p">,</span><span class="n">tau2ab</span><span class="p">,</span><span class="n">tau2bb</span><span class="p">),</span> <span class="n">eris</span><span class="p">,</span> <span class="p">(</span><span class="n">Hr2aa</span><span class="p">,</span><span class="n">Hr2ab</span><span class="p">,</span><span class="n">Hr2bb</span><span class="p">))</span>
        <span class="n">Hr2aa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2bb</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">-</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">-</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">=</span> <span class="n">Hr2bb</span> <span class="o">-</span> <span class="n">Hr2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">=</span> <span class="n">Hr2bb</span> <span class="o">-</span> <span class="n">Hr2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">((</span><span class="n">Hr1a</span><span class="p">,</span><span class="n">Hr1b</span><span class="p">),</span> <span class="p">(</span><span class="n">Hr2aa</span><span class="p">,</span><span class="n">Hr2ab</span><span class="p">,</span><span class="n">Hr2bb</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eomsf_ccsd_matvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Spin flip EOM-CCSD&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="p">(</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">))</span>
        <span class="n">r1ab</span><span class="p">,</span> <span class="n">r1ba</span> <span class="o">=</span> <span class="n">r1</span>
        <span class="n">r2baaa</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">,</span> <span class="n">r2bbab</span> <span class="o">=</span> <span class="n">r2</span>

        <span class="n">Hr1ab</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">)</span>
        <span class="n">Hr1ab</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">)</span>
        <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fovb</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fova</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr1ba</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ae,ie-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mi,ma-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fova</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,imae-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fovb</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nMjI,Mnab-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnij,mnAb-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woooo</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiJ,mNAB-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">=</span> <span class="o">.</span><span class="mi">25</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MNIJ,MNaB-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOO</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,Ijae-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span>   <span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MJ,Miab-&gt;Jiab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span>   <span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;BE,IJaE-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,IJeA-&gt;IJbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span>   <span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;be,ijAe-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;BE,ijEa-&gt;ijBa&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;BE,iJAE-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span>   <span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,imab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mj,mIAB-&gt;jIAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>

        <span class="n">tau2baaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="n">tau2baaa</span> <span class="o">=</span> <span class="n">tau2baaa</span> <span class="o">-</span> <span class="n">tau2baaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tau2abbb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
        <span class="n">tau2abbb</span> <span class="o">=</span> <span class="n">tau2abbb</span> <span class="o">-</span> <span class="n">tau2abbb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">tau2aaba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="n">tau2aaba</span> <span class="o">=</span> <span class="n">tau2aaba</span> <span class="o">-</span> <span class="n">tau2aaba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">tau2bbab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
        <span class="n">tau2bbab</span> <span class="o">=</span> <span class="n">tau2bbab</span> <span class="o">-</span> <span class="n">tau2bbab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">tau2baaa</span> <span class="o">+=</span> <span class="n">r2baaa</span>
        <span class="n">tau2bbab</span> <span class="o">+=</span> <span class="n">r2bbab</span>
        <span class="n">tau2abbb</span> <span class="o">+=</span> <span class="n">r2abbb</span>
        <span class="n">tau2aaba</span> <span class="o">+=</span> <span class="n">r2aaba</span>
        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvira,nvira)</span>
        <span class="c1">#:Hr1ba += einsum(&#39;mfae,Imef-&gt;Ia&#39;, eris_ovvv, r2baaa)</span>
        <span class="c1">#:tmp1aaba = lib.einsum(&#39;meaf,Ijef-&gt;maIj&#39;, eris_ovvv, tau2baaa)</span>
        <span class="c1">#:Hr2baaa += lib.einsum(&#39;mb,maIj-&gt;Ijab&#39;, t1a   , tmp1aaba)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfae,Imef-&gt;Ia&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meaf,Ijef-&gt;maIj&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">)</span>
            <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maIj-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmp1aaba</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_OVVV = lib.unpack_tril(np.asarray(eris.OVVV).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvirb,nvirb)</span>
        <span class="c1">#:Hr1ab += einsum(&#39;MFAE,iMEF-&gt;iA&#39;, eris_OVVV, r2abbb)</span>
        <span class="c1">#:tmp1bbab = lib.einsum(&#39;MEAF,iJEF-&gt;MAiJ&#39;, eris_OVVV, tau2abbb)</span>
        <span class="c1">#:Hr2abbb += lib.einsum(&#39;MB,MAiJ-&gt;iJAB&#39;, t1b   , tmp1bbab)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFAE,iMEF-&gt;iA&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1bbab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEAF,iJEF-&gt;MAiJ&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">tau2abbb</span><span class="p">)</span>
            <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MAiJ-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tmp1bbab</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">tmp1bbab</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:Hr1ab += einsum(&#39;mfAE,imEf-&gt;iA&#39;, eris_ovVV, r2aaba)</span>
        <span class="c1">#:tmp1abaa = lib.einsum(&#39;meAF,ijFe-&gt;mAij&#39;, eris_ovVV, tau2aaba)</span>
        <span class="c1">#:tmp1abbb = lib.einsum(&#39;meAF,IJeF-&gt;mAIJ&#39;, eris_ovVV, tau2bbab)</span>
        <span class="c1">#:tmp1ba = lib.einsum(&#39;mfAE,mE-&gt;Af&#39;, eris_ovVV, r1ab)</span>
        <span class="c1">#:Hr2bbab -= lib.einsum(&#39;mb,mAIJ-&gt;IJbA&#39;, t1a*.5, tmp1abbb)</span>
        <span class="c1">#:Hr2aaba -= lib.einsum(&#39;mb,mAij-&gt;ijAb&#39;, t1a*.5, tmp1abaa)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">))</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfAE,imEf-&gt;iA&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1abaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meAF,ijFe-&gt;mAij&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">)</span>
            <span class="n">tmp1abbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meAF,IJeF-&gt;mAIJ&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tau2bbab</span><span class="p">)</span>
            <span class="n">tmp1ba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfAE,mE-&gt;Af&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mAIJ-&gt;IJbA&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1abbb</span><span class="p">)</span>
            <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mAij-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1abaa</span><span class="p">)</span>

        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:Hr1ba += einsum(&#39;MFae,IMeF-&gt;Ia&#39;, eris_OVvv, r2bbab)</span>
        <span class="c1">#:tmp1baaa = lib.einsum(&#39;MEaf,ijEf-&gt;Maij&#39;, eris_OVvv, tau2aaba)</span>
        <span class="c1">#:tmp1babb = lib.einsum(&#39;MEaf,IJfE-&gt;MaIJ&#39;, eris_OVvv, tau2bbab)</span>
        <span class="c1">#:tmp1ab = lib.einsum(&#39;MFae,Me-&gt;aF&#39;, eris_OVvv, r1ba)</span>
        <span class="c1">#:Hr2aaba -= lib.einsum(&#39;MB,Maij-&gt;ijBa&#39;, t1b*.5, tmp1baaa)</span>
        <span class="c1">#:Hr2bbab -= lib.einsum(&#39;MB,MaIJ-&gt;IJaB&#39;, t1b*.5, tmp1babb)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">))</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFae,IMeF-&gt;Ia&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEaf,ijEf-&gt;Maij&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">)</span>
            <span class="n">tmp1babb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEaf,IJfE-&gt;MaIJ&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tau2bbab</span><span class="p">)</span>
            <span class="n">tmp1ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFae,Me-&gt;aF&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,Maij-&gt;ijBa&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1baaa</span><span class="p">)</span>
            <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MB,MaIJ-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">tmp1babb</span><span class="p">)</span>

        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aF,jIbF-&gt;Ijba&#39;</span><span class="p">,</span> <span class="n">tmp1ab</span>   <span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;aF,IJFB-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Af,iJfB-&gt;iJBA&#39;</span><span class="p">,</span> <span class="n">tmp1ba</span>   <span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Af,ijfb-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">tmp1ba</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbIj,Ma-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvOo</span><span class="p">,</span> <span class="n">r1ba</span>   <span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MBIJ,Ma-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVOO</span><span class="p">,</span> <span class="n">r1ba</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBiJ,mA-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVoO</span><span class="p">,</span> <span class="n">r1ab</span>   <span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbij,mA-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovoo</span><span class="p">,</span> <span class="n">r1ab</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>

        <span class="n">Hr1ab</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnie,mnAe-&gt;iA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wooov</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr1ab</span> <span class="o">-=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiE,mNAE-&gt;iA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MNIE,MNaE-&gt;Ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOV</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">-=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MnIe,Mnae-&gt;Ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOoOv</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MnIe,Me-&gt;nI&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOoOv</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNiE,mE-&gt;Ni&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoV</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nI,njab-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nI,nJaB-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">tmp1ab</span>   <span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Ni,NJAB-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">tmp1ba</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Ni,jNbA-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">tmp1ba</span>   <span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">):</span>
            <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ejab,Ie-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wvovv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1ba</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eJaB,Ie-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1ba</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span>   <span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">):</span>
            <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;EJAB,iE-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wVOVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1ab</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">)</span>
            <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;EjAb,iE-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">r1ab</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span>   <span class="p">)</span>

        <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mAEi,mE-&gt;iA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MaeI,Me-&gt;Ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvvO</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,Imae-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovvo</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbeJ,Miae-&gt;Jiab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvvO</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbEj,IMaE-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvVo</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MBEJ,IMaE-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVVO</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbeJ,IMeA-&gt;IJbA&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvvO</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBeJ,Imae-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mbej,imAe-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovvo</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBEj,imEa-&gt;ijBa&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MbEj,iMAE-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvVo</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MBEJ,iMAE-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVVO</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBEj,mIAE-&gt;jIAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mBeJ,imAe-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVvO</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">tmp1baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nfME,ijEf-&gt;Mnij&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">)</span>
        <span class="n">tmp1aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,Ijef-&gt;mnIj&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">)</span>
        <span class="n">tmp1abbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,IJeF-&gt;mNIJ&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">tau2bbab</span><span class="p">)</span>
        <span class="n">tmp1bbab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MENF,iJEF-&gt;MNiJ&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">tau2abbb</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnIj,mnab-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">tmp1aaba</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span>     <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nMIJ,nMaB-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">tmp1abbb</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span>     <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Nmij,mNbA-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">tmp1baaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MNiJ,MNAB-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">tmp1bbab</span><span class="p">,</span> <span class="n">taubb</span><span class="p">)</span>
        <span class="n">tauaa</span> <span class="o">=</span> <span class="n">tauab</span> <span class="o">=</span> <span class="n">taubb</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tmpab</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,Imef-&gt;nI&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nfME,IMfE-&gt;nI&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">tmpba</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MENF,iMEF-&gt;Ni&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">tmpba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,imFe-&gt;Ni&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NA,Ni-&gt;iA&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmpba</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;na,nI-&gt;Ia&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmpab</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mJ,imab-&gt;Jiab&#39;</span><span class="p">,</span> <span class="n">tmpab</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mJ,mIaB-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">tmpab</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Mj,iMbA-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">tmpba</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2abbb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Mj,IMAB-&gt;jIAB&#39;</span><span class="p">,</span> <span class="n">tmpba</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>

        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,mF-&gt;eN&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nfME,Mf-&gt;En&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eN,NB-&gt;eB&#39;</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
        <span class="n">tmpba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;En,nb-&gt;Eb&#39;</span><span class="p">,</span> <span class="n">tmp1ba</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;menf,mnBf-&gt;eB&#39;</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meNF,mNFB-&gt;eB&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">)</span>
        <span class="n">tmpba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MENF,MNbF-&gt;Eb&#39;</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">)</span>
        <span class="n">tmpba</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nfME,Mnfb-&gt;Eb&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Eb,jIaE-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">tmpba</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">Hr2bbab</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;Eb,IJAE-&gt;IJbA&#39;</span><span class="p">,</span> <span class="n">tmpba</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eB,ijae-&gt;ijBa&#39;</span><span class="p">,</span> <span class="n">tmpab</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;eB,iJeA-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">tmpab</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_vvvv = ao2mo.restore(1, np.asarray(eris.vvvv), nvirb)</span>
        <span class="c1">#:eris_VVVV = ao2mo.restore(1, np.asarray(eris.VVVV), nvirb)</span>
        <span class="c1">#:eris_vvVV = _restore(np.asarray(eris.vvVV), nvira, nvirb)</span>
        <span class="c1">#:Hr2baaa += .5*lib.einsum(&#39;Ijef,aebf-&gt;Ijab&#39;, tau2baaa, eris_vvvv)</span>
        <span class="c1">#:Hr2abbb += .5*lib.einsum(&#39;iJEF,AEBF-&gt;iJAB&#39;, tau2abbb, eris_VVVV)</span>
        <span class="c1">#:Hr2bbab += .5*lib.einsum(&#39;IJeF,aeBF-&gt;IJaB&#39;, tau2bbab, eris_vvVV)</span>
        <span class="c1">#:Hr2aaba += .5*lib.einsum(&#39;ijEf,bfAE-&gt;ijAb&#39;, tau2aaba, eris_vvVV)</span>
        <span class="n">tau2baaa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">rccsd</span><span class="o">.</span><span class="n">_add_vvvv1_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2baaa</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Hr2baaa</span><span class="p">)</span>
        <span class="n">fakeri</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>
        <span class="n">fakeri</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span>
        <span class="n">tau2abbb</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">rccsd</span><span class="o">.</span><span class="n">_add_vvvv1_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2abbb</span><span class="p">,</span> <span class="n">fakeri</span><span class="p">,</span> <span class="n">Hr2abbb</span><span class="p">)</span>
        <span class="n">fakeri</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span>
        <span class="n">tau2bbab</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">rccsd</span><span class="o">.</span><span class="n">_add_vvvv1_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tau2bbab</span><span class="p">,</span> <span class="n">fakeri</span><span class="p">,</span> <span class="n">Hr2bbab</span><span class="p">)</span>
        <span class="n">fakeri</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvira</span><span class="p">):</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">Hr2aaba</span><span class="p">[:,:,:,</span><span class="n">i</span> <span class="p">]</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,fae-&gt;ija&#39;</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">[:,:,:,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">vvv</span><span class="p">)</span>
            <span class="n">Hr2aaba</span><span class="p">[:,:,:,:</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ije,bae-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">tau2aaba</span><span class="p">[:,:,:,</span><span class="n">i</span><span class="p">],</span> <span class="n">vvv</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="n">Hr2baaa</span> <span class="o">-</span> <span class="n">Hr2baaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">=</span> <span class="n">Hr2bbab</span> <span class="o">-</span> <span class="n">Hr2bbab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">=</span> <span class="n">Hr2abbb</span> <span class="o">-</span> <span class="n">Hr2abbb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="n">Hr2aaba</span> <span class="o">-</span> <span class="n">Hr2aaba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_eomsf</span><span class="p">((</span><span class="n">Hr1ab</span><span class="p">,</span> <span class="n">Hr1ba</span><span class="p">),</span> <span class="p">(</span><span class="n">Hr2baaa</span><span class="p">,</span><span class="n">Hr2aaba</span><span class="p">,</span><span class="n">Hr2abbb</span><span class="p">,</span><span class="n">Hr2bbab</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">eeccsd_diag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="s1">&#39;imds&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span> <span class="o">=</span> <span class="n">_IMDS</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">made_ee_imds</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">imds</span><span class="o">.</span><span class="n">make_ee</span><span class="p">()</span>
        <span class="n">imds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imds</span>

        <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
        <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">Foa</span> <span class="o">=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fooa</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">Fob</span> <span class="o">=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Foob</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">Fva</span> <span class="o">=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvva</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">Fvb</span> <span class="o">=</span> <span class="n">imds</span><span class="o">.</span><span class="n">Fvvb</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">Wovaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wovvo</span><span class="p">)</span>
        <span class="n">Wovbb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOVVO</span><span class="p">)</span>
        <span class="n">Wovab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woVVo</span><span class="p">)</span>
        <span class="n">Wovba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iaai-&gt;ia&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOvvO</span><span class="p">)</span>

        <span class="n">Hr1aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">Foa</span><span class="p">,</span> <span class="n">Fva</span><span class="p">)</span>
        <span class="n">Hr1bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">Fob</span><span class="p">,</span> <span class="n">Fvb</span><span class="p">)</span>
        <span class="n">Hr1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">Foa</span><span class="p">,</span> <span class="n">Fvb</span><span class="p">)</span>
        <span class="n">Hr1ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+a-&gt;ia&#39;</span><span class="p">,</span> <span class="n">Fob</span><span class="p">,</span> <span class="n">Fva</span><span class="p">)</span>
        <span class="n">Hr1aa</span> <span class="o">+=</span> <span class="n">Wovaa</span>
        <span class="n">Hr1bb</span> <span class="o">+=</span> <span class="n">Wovbb</span>
        <span class="n">Hr1ab</span> <span class="o">+=</span> <span class="n">Wovab</span>
        <span class="n">Hr1ba</span> <span class="o">+=</span> <span class="n">Wovba</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">-</span> <span class="n">eris_OVOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Wvvaa</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,manb-&gt;ab&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Wvvbb</span> <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnab,manb-&gt;ab&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span>
        <span class="n">Wvvab</span> <span class="o">=</span>    <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaB,maNB-&gt;aB&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">ijb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iejb,ijbe-&gt;ijb&#39;</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">IJB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iejb,ijbe-&gt;ijb&#39;</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">iJB</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ieJB,iJeB-&gt;iJB&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">Ijb</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jbIE,jIbE-&gt;Ijb&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">iJb</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ibJE,iJbE-&gt;iJb&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">IjB</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jeIB,jIeB-&gt;IjB&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">jab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kajb,jkab-&gt;jab&#39;</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">JAB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kajb,jkab-&gt;jab&#39;</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">jAb</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jbKA,jKbA-&gt;jAb&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">JaB</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kaJB,kJaB-&gt;JaB&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">jaB</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jaKB,jKaB-&gt;jaB&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">JAb</span> <span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kbJA,kJbA-&gt;JAb&#39;</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">ovov</span> <span class="o">=</span> <span class="n">OVOV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ijb+a-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">ijb</span><span class="p">,</span> <span class="n">Fva</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ijb+a-&gt;ijba&#39;</span><span class="p">,</span> <span class="n">IJB</span><span class="p">,</span> <span class="n">Fvb</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;iJb+A-&gt;iJbA&#39;</span><span class="p">,</span> <span class="n">iJb</span><span class="p">,</span> <span class="n">Fvb</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;iJB+a-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">iJB</span><span class="p">,</span> <span class="n">Fva</span><span class="p">)</span>
        <span class="n">Hr2aa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+jab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">Foa</span><span class="p">,</span> <span class="n">jab</span><span class="p">)</span>
        <span class="n">Hr2bb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+jab-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">Fob</span><span class="p">,</span> <span class="n">JAB</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+JaB-&gt;iJaB&#39;</span><span class="p">,</span> <span class="n">Foa</span><span class="p">,</span> <span class="n">JaB</span><span class="p">)</span>
        <span class="n">Hr2ab</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-I+jaB-&gt;jIaB&#39;</span><span class="p">,</span> <span class="n">Fob</span><span class="p">,</span> <span class="n">jaB</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">+</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">=</span> <span class="n">Hr2aa</span> <span class="o">+</span> <span class="n">Hr2aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">=</span> <span class="n">Hr2bb</span> <span class="o">+</span> <span class="n">Hr2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">=</span> <span class="n">Hr2bb</span> <span class="o">+</span> <span class="n">Hr2bb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2bb</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;Ijb+a-&gt;Ijba&#39;</span><span class="p">,</span> <span class="n">Ijb</span><span class="p">,</span> <span class="n">Fva</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;ijb+A-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">ijb</span><span class="p">,</span> <span class="n">Fvb</span><span class="p">)</span>
        <span class="n">Hr2aaba</span><span class="o">+=</span> <span class="n">Fva</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;iJB+A-&gt;iJBA&#39;</span><span class="p">,</span> <span class="n">iJB</span><span class="p">,</span> <span class="n">Fvb</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;IJB+a-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">IJB</span><span class="p">,</span> <span class="n">Fva</span><span class="p">)</span>
        <span class="n">Hr2bbab</span><span class="o">+=</span> <span class="n">Fvb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">=</span> <span class="n">Hr2baaa</span> <span class="o">+</span> <span class="n">Hr2baaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">=</span> <span class="n">Hr2abbb</span> <span class="o">+</span> <span class="n">Hr2abbb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">Hr2baaa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-I+jab-&gt;Ijab&#39;</span><span class="p">,</span> <span class="n">Fob</span><span class="p">,</span> <span class="n">jab</span><span class="p">)</span>
        <span class="n">Hr2baaa</span><span class="o">-=</span> <span class="n">Foa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tmpaaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+jAb-&gt;ijAb&#39;</span><span class="p">,</span> <span class="n">Foa</span><span class="p">,</span> <span class="n">jAb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-i+JAB-&gt;iJAB&#39;</span><span class="p">,</span> <span class="n">Foa</span><span class="p">,</span> <span class="n">JAB</span><span class="p">)</span>
        <span class="n">Hr2abbb</span><span class="o">-=</span> <span class="n">Fob</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tmpbbab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;-I+JaB-&gt;IJaB&#39;</span><span class="p">,</span> <span class="n">Fob</span><span class="p">,</span> <span class="n">JaB</span><span class="p">)</span>
        <span class="n">Hr2aaba</span><span class="o">+=</span> <span class="n">tmpaaba</span> <span class="o">+</span> <span class="n">tmpaaba</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Hr2bbab</span><span class="o">+=</span> <span class="n">tmpbbab</span> <span class="o">+</span> <span class="n">tmpbbab</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">tmpaaba</span> <span class="o">=</span> <span class="n">tmpbbab</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wovba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wovba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wovba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wovaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">Wovab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">Wovbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">Wovba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">Wovba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Wooaa</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woooo</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Wooaa</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijji-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woooo</span><span class="p">)</span>
        <span class="n">Woobb</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOO</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">Woobb</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijji-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">wOOOO</span><span class="p">)</span>
        <span class="n">Wooab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijij-&gt;ij&#39;</span><span class="p">,</span> <span class="n">imds</span><span class="o">.</span><span class="n">woOoO</span><span class="p">)</span>
        <span class="n">Wooba</span> <span class="o">=</span> <span class="n">Wooab</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wooaa</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Woobb</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wooaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wooab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">Woobb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wooba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wooaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">Wooab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">Woobb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvira,nvira)</span>
        <span class="c1">#:Wvvaa += np.einsum(&#39;mb,maab-&gt;ab&#39;, t1a, eris_ovvv)</span>
        <span class="c1">#:Wvvaa -= np.einsum(&#39;mb,mbaa-&gt;ab&#39;, t1a, eris_ovvv)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">Wvvaa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maab-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">Wvvaa</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mbaa-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#:eris_OVVV = lib.unpack_tril(np.asarray(eris.OVVV).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvirb,nvirb)</span>
        <span class="c1">#:Wvvbb += np.einsum(&#39;mb,maab-&gt;ab&#39;, t1b, eris_OVVV)</span>
        <span class="c1">#:Wvvbb -= np.einsum(&#39;mb,mbaa-&gt;ab&#39;, t1b, eris_OVVV)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">Wvvbb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,maab-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVVV</span><span class="p">)</span>
            <span class="n">Wvvbb</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mbaa-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVVV</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:Wvvab -= np.einsum(&#39;mb,mbaa-&gt;ba&#39;, t1a, eris_ovVV)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">Wvvab</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mbaa-&gt;ba&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovVV</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:Wvvab -= np.einsum(&#39;mb,mbaa-&gt;ab&#39;, t1b, eris_OVvv)</span>
        <span class="n">idxa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">idxa</span> <span class="o">=</span> <span class="n">idxa</span><span class="o">*</span><span class="p">(</span><span class="n">idxa</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">+</span><span class="n">idxa</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">Wvvab</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mb,mba-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVvv</span><span class="p">[:,:,</span><span class="n">idxa</span><span class="p">])</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Wvvaa</span> <span class="o">=</span> <span class="n">Wvvaa</span> <span class="o">+</span> <span class="n">Wvvaa</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Wvvbb</span> <span class="o">=</span> <span class="n">Wvvbb</span> <span class="o">+</span> <span class="n">Wvvbb</span><span class="o">.</span><span class="n">T</span>
        <span class="c1">#:eris_vvvv = ao2mo.restore(1, np.asarray(eris.vvvv), nvirb)</span>
        <span class="c1">#:eris_VVVV = ao2mo.restore(1, np.asarray(eris.VVVV), nvirb)</span>
        <span class="c1">#:eris_vvVV = _restore(np.asarray(eris.vvVV), nvira, nvirb)</span>
        <span class="c1">#:Wvvaa += np.einsum(&#39;aabb-&gt;ab&#39;, eris_vvvv) - np.einsum(&#39;abba-&gt;ab&#39;, eris_vvvv)</span>
        <span class="c1">#:Wvvbb += np.einsum(&#39;aabb-&gt;ab&#39;, eris_VVVV) - np.einsum(&#39;abba-&gt;ab&#39;, eris_VVVV)</span>
        <span class="c1">#:Wvvab += np.einsum(&#39;aabb-&gt;ab&#39;, eris_vvVV)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvira</span><span class="p">):</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Wvvaa</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[:,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Wvvaa</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp</span>
            <span class="n">Wvvaa</span><span class="p">[:</span><span class="n">i</span>  <span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">Wvvab</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvirb</span><span class="p">):</span>
            <span class="n">i0</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Wvvbb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;bb-&gt;b&#39;</span><span class="p">,</span> <span class="n">vvv</span><span class="p">[:,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">i</span><span class="p">])</span>
            <span class="n">Wvvbb</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp</span>
            <span class="n">Wvvbb</span><span class="p">[:</span><span class="n">i</span>  <span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">i</span><span class="p">]</span>
            <span class="n">vvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Wvvba</span> <span class="o">=</span> <span class="n">Wvvab</span><span class="o">.</span><span class="n">T</span>
        <span class="n">Hr2aa</span> <span class="o">+=</span> <span class="n">Wvvaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2ab</span> <span class="o">+=</span> <span class="n">Wvvab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2bb</span> <span class="o">+=</span> <span class="n">Wvvbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2baaa</span> <span class="o">+=</span> <span class="n">Wvvaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2aaba</span> <span class="o">+=</span> <span class="n">Wvvba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">Hr2abbb</span> <span class="o">+=</span> <span class="n">Wvvbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">Hr2bbab</span> <span class="o">+=</span> <span class="n">Wvvab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>

        <span class="n">vec_ee</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">((</span><span class="n">Hr1aa</span><span class="p">,</span><span class="n">Hr1bb</span><span class="p">),</span> <span class="p">(</span><span class="n">Hr2aa</span><span class="p">,</span><span class="n">Hr2ab</span><span class="p">,</span><span class="n">Hr2bb</span><span class="p">))</span>
        <span class="n">vec_sf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_eomsf</span><span class="p">((</span><span class="n">Hr1ab</span><span class="p">,</span><span class="n">Hr1ba</span><span class="p">),</span> <span class="p">(</span><span class="n">Hr2baaa</span><span class="p">,</span><span class="n">Hr2aaba</span><span class="p">,</span><span class="n">Hr2abbb</span><span class="p">,</span><span class="n">Hr2bbab</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">vec_ee</span><span class="p">,</span> <span class="n">vec_sf</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_ee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_s4</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_ee</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nvir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_s4</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">sizea</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">*</span> <span class="n">nvira</span> <span class="o">+</span> <span class="n">nocca</span><span class="o">*</span><span class="p">(</span><span class="n">nocca</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">sizeb</span> <span class="o">=</span> <span class="n">noccb</span> <span class="o">*</span> <span class="n">nvirb</span> <span class="o">+</span> <span class="n">noccb</span><span class="o">*</span><span class="p">(</span><span class="n">noccb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">sizeab</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">*</span> <span class="n">noccb</span> <span class="o">*</span> <span class="n">nvira</span> <span class="o">*</span> <span class="n">nvirb</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">sizea</span><span class="o">+</span><span class="n">sizeb</span><span class="o">+</span><span class="n">sizeab</span><span class="p">,</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ee</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[:</span><span class="n">sizea</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector_ee</span><span class="p">(</span><span class="n">t1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">vector</span><span class="p">[</span><span class="n">sizea</span><span class="p">:])</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">sizea</span><span class="o">+</span><span class="n">sizeb</span><span class="p">:]</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nmo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nocc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nmo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nmo</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span> <span class="o">=</span> <span class="n">nmo</span>
        <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">nmoa</span><span class="o">-</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nmob</span><span class="o">-</span><span class="n">noccb</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">+</span> <span class="n">noccb</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nvira</span> <span class="o">+</span> <span class="n">nvirb</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">vector</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">size</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ee</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">vector</span><span class="o">.</span><span class="n">size</span>
            <span class="n">sizea</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">*</span> <span class="n">nvira</span> <span class="o">+</span> <span class="n">nocca</span><span class="o">*</span><span class="p">(</span><span class="n">nocca</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">sizeb</span> <span class="o">=</span> <span class="n">noccb</span> <span class="o">*</span> <span class="n">nvirb</span> <span class="o">+</span> <span class="n">noccb</span><span class="o">*</span><span class="p">(</span><span class="n">noccb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">sizeab</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">*</span> <span class="n">noccb</span> <span class="o">*</span> <span class="n">nvira</span> <span class="o">*</span> <span class="n">nvirb</span>
            <span class="n">t1a</span><span class="p">,</span> <span class="n">t2aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ee</span><span class="p">(</span><span class="n">vector</span><span class="p">[:</span><span class="n">sizea</span><span class="p">],</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span><span class="p">)</span>
            <span class="n">t1b</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes_ee</span><span class="p">(</span><span class="n">vector</span><span class="p">[</span><span class="n">sizea</span><span class="p">:</span><span class="n">sizea</span><span class="o">+</span><span class="n">sizeb</span><span class="p">],</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">)</span>
            <span class="n">t2ab</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="n">sizeab</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">t1a</span><span class="p">,</span><span class="n">t1b</span><span class="p">),</span> <span class="p">(</span><span class="n">t2aa</span><span class="p">,</span><span class="n">t2ab</span><span class="p">,</span><span class="n">t2bb</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_from_rccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert spatial orbital T1,T2 to spin-orbital T1,T2&#39;&#39;&#39;</span>
        <span class="n">orbspin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span>
        <span class="n">t2aa</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">-</span> <span class="n">t2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">spatial2spin</span><span class="p">((</span><span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">),</span> <span class="n">orbspin</span><span class="p">),</span>
                <span class="n">spatial2spin</span><span class="p">((</span><span class="n">t2aa</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">),</span> <span class="n">orbspin</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">spatial2spin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">orbspin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">orbspin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">orbspin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span>
        <span class="k">return</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spin2spatial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tx</span><span class="p">,</span> <span class="n">orbspin</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">orbspin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">orbspin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span>
        <span class="k">return</span> <span class="n">spin2spatial</span><span class="p">(</span><span class="n">tx</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector_eomsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">t1ab</span><span class="p">,</span> <span class="n">t1ba</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="n">t2baaa</span><span class="p">,</span> <span class="n">t2aaba</span><span class="p">,</span> <span class="n">t2abbb</span><span class="p">,</span> <span class="n">t2bbab</span> <span class="o">=</span> <span class="n">t2</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t1ab</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">t1ba</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">nbaaa</span> <span class="o">=</span> <span class="n">noccb</span><span class="o">*</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">naaba</span> <span class="o">=</span> <span class="n">nocca</span><span class="o">*</span><span class="p">(</span><span class="n">nocca</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span>
        <span class="n">nabbb</span> <span class="o">=</span> <span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="o">*</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">nbbab</span> <span class="o">=</span> <span class="n">noccb</span><span class="o">*</span><span class="p">(</span><span class="n">noccb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span>
        <span class="n">size</span> <span class="o">=</span> <span class="n">t1ab</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">t1ba</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">nbaaa</span> <span class="o">+</span> <span class="n">naaba</span> <span class="o">+</span> <span class="n">nabbb</span> <span class="o">+</span> <span class="n">nbbab</span>
        <span class="n">vector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">t2baaa</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
        <span class="n">vector</span><span class="p">[:</span><span class="n">t1ab</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1ab</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">vector</span><span class="p">[</span><span class="n">t1ab</span><span class="o">.</span><span class="n">size</span><span class="p">:</span><span class="n">t1ab</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">t1ba</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1ba</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">pvec</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">t1ab</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">t1ba</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

        <span class="n">t2baaa</span> <span class="o">=</span> <span class="n">t2baaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">t2aaba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">t2abbb</span> <span class="o">=</span> <span class="n">t2abbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">t2bbab</span> <span class="o">=</span> <span class="n">t2bbab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">otrila</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">otrilb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtrila</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvira</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtrilb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvirb</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">oidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">vidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtrila</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvira</span><span class="o">+</span><span class="n">vtrila</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">pvec</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2aaba</span><span class="p">,</span> <span class="n">otrila</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocca</span><span class="o">+</span><span class="n">otrila</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="p">:])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2abbb</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtrilb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">vtrilb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="p">:])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">t2bbab</span><span class="p">,</span> <span class="n">otrilb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">noccb</span><span class="o">+</span><span class="n">otrilb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="o">+</span><span class="n">nabbb</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">vector</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes_eomsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nvir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nocc</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span> <span class="o">=</span> <span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nvir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nmoa</span><span class="p">,</span> <span class="n">nmob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nmo</span><span class="p">()</span>
            <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">nmoa</span><span class="o">-</span><span class="n">nocca</span><span class="p">,</span> <span class="n">nmob</span><span class="o">-</span><span class="n">noccb</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">nvir</span>

        <span class="n">t1ab</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvirb</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">t1ba</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvirb</span><span class="p">:</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">noccb</span><span class="o">*</span><span class="n">nvira</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pvec</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">t1ab</span><span class="o">.</span><span class="n">size</span><span class="o">+</span><span class="n">t1ba</span><span class="o">.</span><span class="n">size</span><span class="p">:]</span>

        <span class="n">nbaaa</span> <span class="o">=</span> <span class="n">noccb</span><span class="o">*</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">naaba</span> <span class="o">=</span> <span class="n">nocca</span><span class="o">*</span><span class="p">(</span><span class="n">nocca</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span>
        <span class="n">nabbb</span> <span class="o">=</span> <span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="o">*</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">nbbab</span> <span class="o">=</span> <span class="n">noccb</span><span class="o">*</span><span class="p">(</span><span class="n">noccb</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span>
        <span class="n">t2baaa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvira</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">t2abbb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">t2bbab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">otrila</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">otrilb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtrila</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvira</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">vtrilb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvirb</span><span class="p">,</span> <span class="n">k</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">oidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="n">vidxab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>

        <span class="n">v</span> <span class="o">=</span> <span class="n">pvec</span><span class="p">[:</span><span class="n">nbaaa</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtrila</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvira</span><span class="o">+</span><span class="n">vtrila</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtrila</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvira</span><span class="o">+</span><span class="n">vtrila</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="p">:</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2aaba</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">otrila</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocca</span><span class="o">+</span><span class="n">otrila</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2aaba</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">otrila</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nocca</span><span class="o">+</span><span class="n">otrila</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="p">:</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="o">+</span><span class="n">nabbb</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2abbb</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtrilb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">vtrilb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2abbb</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">oidxab</span><span class="p">,</span> <span class="n">vtrilb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">vtrilb</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">pvec</span><span class="p">[</span><span class="n">nbaaa</span><span class="o">+</span><span class="n">naaba</span><span class="o">+</span><span class="n">nabbb</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2bbab</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">otrilb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">noccb</span><span class="o">+</span><span class="n">otrilb</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2bbab</span><span class="p">,</span><span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">otrilb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">noccb</span><span class="o">+</span><span class="n">otrilb</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vidxab</span><span class="p">)</span>
        <span class="n">t2baaa</span> <span class="o">=</span> <span class="n">t2baaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">t2aaba</span> <span class="o">=</span> <span class="n">t2aaba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
        <span class="n">t2abbb</span> <span class="o">=</span> <span class="n">t2abbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="n">t2bbab</span> <span class="o">=</span> <span class="n">t2bbab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">t1ab</span><span class="p">,</span><span class="n">t1ba</span><span class="p">),</span> <span class="p">(</span><span class="n">t2baaa</span><span class="p">,</span> <span class="n">t2aaba</span><span class="p">,</span> <span class="n">t2abbb</span><span class="p">,</span> <span class="n">t2bbab</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spatial2spin_eomsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert EOM spatial R1,R2 to spin-orbital R1,R2&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># r1</span>
            <span class="n">r1ab</span><span class="p">,</span> <span class="n">r1ba</span> <span class="o">=</span> <span class="n">rx</span>
            <span class="n">nocca</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">r1ab</span><span class="o">.</span><span class="n">shape</span>
            <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">r1ba</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2baaa</span><span class="p">,</span><span class="n">r2aaba</span><span class="p">,</span><span class="n">r2abbb</span><span class="p">,</span><span class="n">r2bbab</span> <span class="o">=</span> <span class="n">rx</span>
            <span class="n">noccb</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">nvira</span> <span class="o">=</span> <span class="n">r2baaa</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">nvirb</span> <span class="o">=</span> <span class="n">r2aaba</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">nocc</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">+</span> <span class="n">noccb</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nvira</span> <span class="o">+</span> <span class="n">nvirb</span>
        <span class="n">idxoa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># r1</span>
            <span class="n">r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r1ab</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1ab</span><span class="p">,</span> <span class="n">idxoa</span><span class="p">,</span> <span class="n">idxvb</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r1ba</span><span class="p">,</span> <span class="n">idxob</span><span class="p">,</span> <span class="n">idxva</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">r2aaba</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">idxoaa</span> <span class="o">=</span> <span class="n">idxoa</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxoa</span>
            <span class="n">idxoab</span> <span class="o">=</span> <span class="n">idxoa</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxob</span>
            <span class="n">idxoba</span> <span class="o">=</span> <span class="n">idxob</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxoa</span>
            <span class="n">idxobb</span> <span class="o">=</span> <span class="n">idxob</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxob</span>
            <span class="n">idxvaa</span> <span class="o">=</span> <span class="n">idxva</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxva</span>
            <span class="n">idxvab</span> <span class="o">=</span> <span class="n">idxva</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxvb</span>
            <span class="n">idxvba</span> <span class="o">=</span> <span class="n">idxvb</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxva</span>
            <span class="n">idxvbb</span> <span class="o">=</span> <span class="n">idxvb</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxvb</span>
            <span class="n">r2baaa</span> <span class="o">=</span> <span class="n">r2baaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">r2aaba</span> <span class="o">=</span> <span class="n">r2aaba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">r2abbb</span> <span class="o">=</span> <span class="n">r2abbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">r2bbab</span> <span class="o">=</span> <span class="n">r2bbab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">,</span> <span class="n">idxoba</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvaa</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">,</span> <span class="n">idxoaa</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvba</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">,</span> <span class="n">idxoab</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvbb</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">,</span> <span class="n">idxobb</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvab</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2baaa</span><span class="p">,</span> <span class="n">idxoab</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvaa</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2aaba</span><span class="p">,</span> <span class="n">idxoaa</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvab</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2abbb</span><span class="p">,</span> <span class="n">idxoba</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvbb</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">r2bbab</span><span class="p">,</span> <span class="n">idxobb</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvba</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">r2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">spin2spatial_eomsf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rx</span><span class="p">,</span> <span class="n">orbspin</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Convert EOM spin-orbital R1,R2 to spatial R1,R2&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">rx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>  <span class="c1"># r1</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">shape</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">idxoa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxva</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">idxvb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nocca</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxoa</span><span class="p">)</span>
        <span class="n">noccb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxob</span><span class="p">)</span>
        <span class="n">nvira</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxva</span><span class="p">)</span>
        <span class="n">nvirb</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">idxvb</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rx</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">r1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">idxoa</span><span class="p">,</span> <span class="n">idxvb</span><span class="p">)</span>
            <span class="n">r1ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">rx</span><span class="p">,</span> <span class="n">idxob</span><span class="p">,</span> <span class="n">idxva</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r1ab</span><span class="p">,</span> <span class="n">r1ba</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">idxoaa</span> <span class="o">=</span> <span class="n">idxoa</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxoa</span>
            <span class="n">idxoab</span> <span class="o">=</span> <span class="n">idxoa</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxob</span>
            <span class="n">idxoba</span> <span class="o">=</span> <span class="n">idxob</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxoa</span>
            <span class="n">idxobb</span> <span class="o">=</span> <span class="n">idxob</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">idxob</span>
            <span class="n">idxvaa</span> <span class="o">=</span> <span class="n">idxva</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxva</span>
            <span class="n">idxvab</span> <span class="o">=</span> <span class="n">idxva</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxvb</span>
            <span class="n">idxvba</span> <span class="o">=</span> <span class="n">idxvb</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxva</span>
            <span class="n">idxvbb</span> <span class="o">=</span> <span class="n">idxvb</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">nvir</span> <span class="o">+</span> <span class="n">idxvb</span>
            <span class="n">r2</span> <span class="o">=</span> <span class="n">rx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">r2baaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">idxoba</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvaa</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">r2aaba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">idxoaa</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvba</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">r2abbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">idxoab</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvbb</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">r2bbab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">r2</span><span class="p">,</span> <span class="n">idxobb</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">idxvab</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">r2baaa</span> <span class="o">=</span> <span class="n">r2baaa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">r2aaba</span> <span class="o">=</span> <span class="n">r2aaba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">r2abbb</span> <span class="o">=</span> <span class="n">r2abbb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">r2bbab</span> <span class="o">=</span> <span class="n">r2bbab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">r2baaa</span><span class="p">,</span><span class="n">r2aaba</span><span class="p">,</span><span class="n">r2abbb</span><span class="p">,</span><span class="n">r2bbab</span></div>


<span class="k">class</span> <span class="nc">_ERISspin</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;incore&#39;</span><span class="p">,</span>
                 <span class="n">ao2mofn</span><span class="o">=</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">outcore</span><span class="o">.</span><span class="n">general_iofree</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">moidx</span> <span class="o">=</span> <span class="n">get_umoidx</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                        <span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="p">[</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                        <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>

        <span class="n">nocc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nmo</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nmo</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">mem_incore</span><span class="p">,</span> <span class="n">mem_outcore</span><span class="p">,</span> <span class="n">mem_basic</span> <span class="o">=</span> <span class="n">rccsd</span><span class="o">.</span><span class="n">_mem_usage</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fock</span><span class="p">,</span> <span class="n">so_coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="n">uspatial2spin</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">moidx</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Overwrite cc.orbspin by _ERIS.&#39;</span><span class="p">)</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">feri</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">mem_incore</span><span class="o">+</span><span class="n">mem_now</span> <span class="o">&lt;</span> <span class="n">cc</span><span class="o">.</span><span class="n">max_memory</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">incore_anyway</span><span class="p">):</span>
            <span class="n">idxa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">idxb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">moa</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxa</span><span class="p">]</span>
            <span class="n">mob</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxb</span><span class="p">]</span>
            <span class="n">nmoa</span> <span class="o">=</span> <span class="n">moa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nmob</span> <span class="o">=</span> <span class="n">mob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">maska</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idxa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">idxa</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">maskb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idxb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">idxb</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">eri</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmo</span><span class="o">*</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="o">*</span><span class="n">nmo</span><span class="p">))</span>

            <span class="n">eri_aa</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="n">moa</span><span class="p">),</span> <span class="n">nmoa</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">eri</span><span class="p">,</span> <span class="n">eri_aa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmoa</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">maska</span><span class="p">,</span> <span class="n">maska</span><span class="p">)</span>
            <span class="n">eri_bb</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="n">mob</span><span class="p">),</span> <span class="n">nmob</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">eri</span><span class="p">,</span> <span class="n">eri_bb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmob</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">maskb</span><span class="p">,</span> <span class="n">maskb</span><span class="p">)</span>

            <span class="n">eri_ab</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="p">(</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">),</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">eri_ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eri_ab</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">eri</span><span class="p">,</span> <span class="n">eri_ab</span><span class="p">,</span> <span class="n">maska</span><span class="p">,</span> <span class="n">maskb</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">eri</span><span class="p">,</span> <span class="n">eri_ba</span><span class="p">,</span> <span class="n">maskb</span><span class="p">,</span> <span class="n">maska</span><span class="p">)</span>
            <span class="n">eri</span> <span class="o">=</span> <span class="n">eri</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="p">,</span> <span class="s1">&#39;with_df&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">orbo</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">orbv</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">ds_type</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oooo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovoo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;vvvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>

            <span class="n">idxoa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">idxob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">idxva</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">idxvb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">idxa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">idxb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">orbo_a</span> <span class="o">=</span> <span class="n">orbo</span><span class="p">[:,</span><span class="n">idxoa</span><span class="p">]</span>
            <span class="n">orbo_b</span> <span class="o">=</span> <span class="n">orbo</span><span class="p">[:,</span><span class="n">idxob</span><span class="p">]</span>
            <span class="n">orbv_a</span> <span class="o">=</span> <span class="n">orbv</span><span class="p">[:,</span><span class="n">idxva</span><span class="p">]</span>
            <span class="n">orbv_b</span> <span class="o">=</span> <span class="n">orbv</span><span class="p">[:,</span><span class="n">idxvb</span><span class="p">]</span>
            <span class="n">moa</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxa</span><span class="p">]</span>
            <span class="n">mob</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxb</span><span class="p">]</span>
            <span class="n">nocca</span> <span class="o">=</span> <span class="n">orbo_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">noccb</span> <span class="o">=</span> <span class="n">orbo_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nvira</span> <span class="o">=</span> <span class="n">orbv_a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nvirb</span> <span class="o">=</span> <span class="n">orbv_b</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nmoa</span> <span class="o">=</span> <span class="n">moa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nmob</span> <span class="o">=</span> <span class="n">mob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># &lt;ij||pq&gt; = &lt;ij|pq&gt; - &lt;ij|qp&gt; = (ip|jq) - (iq|jp)</span>
            <span class="n">tmpfile2</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbo_a</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbo_a</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbo_b</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ba&#39;</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbo_b</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">maska1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idxa</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maskb1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idxb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maska2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idxa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">idxa</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maskb2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idxb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">idxb</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">bufv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmo</span><span class="o">*</span><span class="n">nmo</span><span class="o">*</span><span class="n">nmo</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="o">*</span><span class="n">nmo</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># alpha</span>
                        <span class="n">ia</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">idxoa</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">ia</span><span class="o">*</span><span class="n">nmoa</span><span class="p">:</span><span class="n">ia</span><span class="o">*</span><span class="n">nmoa</span><span class="o">+</span><span class="n">nmoa</span><span class="p">]</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">bufv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmoa</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maska1</span><span class="p">,</span> <span class="n">maska2</span><span class="p">)</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ab&#39;</span><span class="p">][</span><span class="n">ia</span><span class="o">*</span><span class="n">nmoa</span><span class="p">:</span><span class="n">ia</span><span class="o">*</span><span class="n">nmoa</span><span class="o">+</span><span class="n">nmoa</span><span class="p">]</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">bufv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmoa</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maska1</span><span class="p">,</span> <span class="n">maskb2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ib</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">idxob</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ba&#39;</span><span class="p">][</span><span class="n">ib</span><span class="o">*</span><span class="n">nmob</span><span class="p">:</span><span class="n">ib</span><span class="o">*</span><span class="n">nmob</span><span class="o">+</span><span class="n">nmob</span><span class="p">]</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">bufv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmob</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maskb1</span><span class="p">,</span> <span class="n">maska2</span><span class="p">)</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bb&#39;</span><span class="p">][</span><span class="n">ib</span><span class="o">*</span><span class="n">nmob</span><span class="p">:</span><span class="n">ib</span><span class="o">*</span><span class="n">nmob</span><span class="o">+</span><span class="n">nmob</span><span class="p">]</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">v1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">bufv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmob</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maskb1</span><span class="p">,</span> <span class="n">maskb2</span><span class="p">)</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">bufv</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming oopq, ovpq&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>

            <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">orbv_a</span><span class="p">,</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">orbv_b</span><span class="p">,</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbv_a</span><span class="p">,</span><span class="n">orbv_a</span><span class="p">,</span><span class="n">orbv_b</span><span class="p">,</span><span class="n">orbv_b</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbv_b</span><span class="p">,</span><span class="n">orbv_b</span><span class="p">,</span><span class="n">orbv_a</span><span class="p">,</span><span class="n">orbv_a</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ba&#39;</span><span class="p">,</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">maska1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idxva</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maskb1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">idxvb</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maska2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idxva</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">idxva</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">maskb2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">idxvb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">idxvb</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">):</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">idxva</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>  <span class="c1"># alpha</span>
                        <span class="n">ia</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">idxva</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">ia</span><span class="o">*</span><span class="n">nvira</span><span class="p">:</span><span class="n">ia</span><span class="o">*</span><span class="n">nvira</span><span class="o">+</span><span class="n">nvira</span><span class="p">]</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maska1</span><span class="p">,</span> <span class="n">maska2</span><span class="p">)</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ab&#39;</span><span class="p">][</span><span class="n">ia</span><span class="o">*</span><span class="n">nvira</span><span class="p">:</span><span class="n">ia</span><span class="o">*</span><span class="n">nvira</span><span class="o">+</span><span class="n">nvira</span><span class="p">]</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maska1</span><span class="p">,</span> <span class="n">maskb2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ib</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">idxvb</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;ba&#39;</span><span class="p">][</span><span class="n">ib</span><span class="o">*</span><span class="n">nvirb</span><span class="p">:</span><span class="n">ib</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">nvirb</span><span class="p">]</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maskb1</span><span class="p">,</span> <span class="n">maska2</span><span class="p">)</span>
                        <span class="n">v1</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;bb&#39;</span><span class="p">][</span><span class="n">ib</span><span class="o">*</span><span class="n">nvirb</span><span class="p">:</span><span class="n">ib</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">nvirb</span><span class="p">]</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">maskb1</span><span class="p">,</span> <span class="n">maskb2</span><span class="p">)</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="n">buf</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span>
                    <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming vvvv&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD integral transformation&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">_ERIS</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;incore&#39;</span><span class="p">,</span>
                 <span class="n">ao2mofn</span><span class="o">=</span><span class="n">ao2mo</span><span class="o">.</span><span class="n">outcore</span><span class="o">.</span><span class="n">general_iofree</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">moidx</span> <span class="o">=</span> <span class="n">get_umoidx</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="p">[</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                        <span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="p">[</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                                        <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">moidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]]</span>

        <span class="n">nocc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nmo</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nmo</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">mem_incore</span><span class="p">,</span> <span class="n">mem_outcore</span><span class="p">,</span> <span class="n">mem_basic</span> <span class="o">=</span> <span class="n">rccsd</span><span class="o">.</span><span class="n">_mem_usage</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">fock</span><span class="p">,</span> <span class="n">so_coeff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="n">uspatial2spin</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">moidx</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">idxa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="n">idxb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">focka</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">idxa</span><span class="p">][:,</span><span class="n">idxa</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fockb</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">idxb</span><span class="p">][:,</span><span class="n">idxb</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span><span class="o">.</span><span class="n">size</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="o">.</span><span class="n">size</span> <span class="ow">or</span>
            <span class="nb">any</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Overwrite cc.orbspin by _ERIS.&#39;</span><span class="p">)</span>
            <span class="n">cc</span><span class="o">.</span><span class="n">orbspin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">mem_incore</span><span class="o">+</span><span class="n">mem_now</span> <span class="o">&lt;</span> <span class="n">cc</span><span class="o">.</span><span class="n">max_memory</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">incore_anyway</span><span class="p">):</span>
            <span class="n">moa</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxa</span><span class="p">]</span>
            <span class="n">mob</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxb</span><span class="p">]</span>
            <span class="n">nmoa</span> <span class="o">=</span> <span class="n">moa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nmob</span> <span class="o">=</span> <span class="n">mob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">eri_aa</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="n">moa</span><span class="p">),</span> <span class="n">nmoa</span><span class="p">)</span>
            <span class="n">eri_bb</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="n">mob</span><span class="p">),</span> <span class="n">nmob</span><span class="p">)</span>
            <span class="n">eri_ab</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="p">(</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">),</span> <span class="n">compact</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">eri_ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eri_ab</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">nocca</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noccb</span> <span class="o">=</span> <span class="n">noccb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nvira</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">nvirb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">orbspin</span><span class="p">[</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">nmoa</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">+</span> <span class="n">nvira</span>
            <span class="n">nmob</span> <span class="o">=</span> <span class="n">noccb</span> <span class="o">+</span> <span class="n">nvirb</span>
            <span class="n">eri_aa</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">)</span>
            <span class="n">eri_ab</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">)</span>
            <span class="n">eri_ba</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">)</span>
            <span class="n">eri_bb</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">eri_aa</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">eri_aa</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">nvira</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOOO</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOOV</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVOO</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOVO</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVOV</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOVV</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVVO</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">eri_bb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VVVV</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">restore</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">eri_bb</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> <span class="n">nvirb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooOO</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooOV</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovOO</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooVO</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovOV</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooVV</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovVO</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">vvVV</span> <span class="o">=</span> <span class="n">eri_ab</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">idxa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">idxb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">vvVV</span><span class="p">,</span> <span class="n">idxa</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvira</span><span class="o">+</span><span class="n">idxa</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">idxb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nvirb</span><span class="o">+</span><span class="n">idxb</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="c1">#self.OOoo = eri_ba[:noccb,:noccb,:nocca,:nocca].copy()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOov</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVoo</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOvo</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">#self.OVov = eri_ba[:noccb,noccb:,:nocca,nocca:].copy()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOvv</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVvo</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1">#self.OVvv = eri_ba[:noccb,noccb:,nocca:,nocca:].copy()</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">eri_ba</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1">#self.VVvv = eri_ba[noccb:,noccb:,nocca:,nocca:].copy()</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="p">,</span> <span class="s1">&#39;with_df&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">moa</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxa</span><span class="p">]</span>
            <span class="n">mob</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxb</span><span class="p">]</span>
            <span class="n">nmoa</span> <span class="o">=</span> <span class="n">moa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">nmob</span> <span class="o">=</span> <span class="n">mob</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nocca</span> <span class="o">=</span> <span class="n">nocca</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">moidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">noccb</span> <span class="o">=</span> <span class="n">noccb</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">moidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="n">nvira</span> <span class="o">=</span> <span class="n">nmoa</span> <span class="o">-</span> <span class="n">nocca</span>
            <span class="n">nvirb</span> <span class="o">=</span> <span class="n">nmob</span> <span class="o">-</span> <span class="n">noccb</span>

            <span class="n">orboa</span> <span class="o">=</span> <span class="n">moa</span><span class="p">[:,:</span><span class="n">nocca</span><span class="p">]</span>
            <span class="n">orbob</span> <span class="o">=</span> <span class="n">mob</span><span class="p">[:,:</span><span class="n">noccb</span><span class="p">]</span>
            <span class="n">orbva</span> <span class="o">=</span> <span class="n">moa</span><span class="p">[:,</span><span class="n">nocca</span><span class="p">:]</span>
            <span class="n">orbvb</span> <span class="o">=</span> <span class="n">mob</span><span class="p">[:,</span><span class="n">noccb</span><span class="p">:]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dtype</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="o">.</span><span class="n">dtype</span>
            <span class="n">ds_type</span> <span class="o">=</span> <span class="n">so_coeff</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oooo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovoo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="c1">#self.vvvv = self.feri.create_dataset(&#39;vvvv&#39;, (nvira,nvira,nvira,nvira), ds_type)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOOO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOOO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOOV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVOO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVOO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOVO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOVO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVOV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOVV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVVO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVVO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVVV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="c1">#self.VVVV = self.feri.create_dataset(&#39;VVVV&#39;, (nvirb,nvirb,nvirb,nvirb), ds_type)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooOO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooOO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooOV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovOO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovOO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooVO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooVO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovOV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovOV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooVV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovVO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovVO&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovVV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="o">*</span><span class="p">(</span><span class="n">nvirb</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="c1">#self.vvVV = self.feri.create_dataset(&#39;vvVV&#39;, (nvira,nvira,nvirb,nvirb), ds_type)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVoo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOvo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOvo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OOvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OOvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVvo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVvo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">OVvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;OVvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="o">*</span><span class="p">(</span><span class="n">nvira</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">),</span> <span class="n">ds_type</span><span class="p">)</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="c1"># &lt;ij||pq&gt; = &lt;ij|pq&gt; - &lt;ij|qp&gt; = (ip|jq) - (iq|jp)</span>
            <span class="n">tmpfile2</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orboa</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocca</span><span class="p">):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmoa</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmoa</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;aa&#39;</span><span class="p">])</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbob</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">noccb</span><span class="p">):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;bb&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmob</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmob</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOOO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOOV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVOO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVOV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOVO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVVO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;bb&#39;</span><span class="p">])</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orboa</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">mob</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ab&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmob</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocca</span><span class="p">):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ab&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmoa</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmoa</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooOO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooOV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovOO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovOV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooVO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovVO</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">noccb</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ab&#39;</span><span class="p">])</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbob</span><span class="p">,</span><span class="n">mob</span><span class="p">,</span><span class="n">moa</span><span class="p">,</span><span class="n">moa</span><span class="p">),</span> <span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;ba&#39;</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile2</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmob</span><span class="p">,</span><span class="n">nmoa</span><span class="p">,</span><span class="n">nmoa</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">noccb</span><span class="p">):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ba&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmob</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">nmob</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVoo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOvo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OOvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVvo</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,:</span><span class="n">nocca</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:])</span>
                <span class="k">del</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;ba&#39;</span><span class="p">])</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming oopq, ovpq&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>

            <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">orbva</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;vvvv&#39;</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">orbvb</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;VVVV&#39;</span><span class="p">)</span>
            <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbva</span><span class="p">,</span><span class="n">orbva</span><span class="p">,</span><span class="n">orbvb</span><span class="p">,</span><span class="n">orbvb</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">,</span> <span class="n">dataname</span><span class="o">=</span><span class="s1">&#39;vvVV&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">[</span><span class="s1">&#39;vvvv&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">VVVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">[</span><span class="s1">&#39;VVVV&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri</span><span class="p">[</span><span class="s1">&#39;vvVV&#39;</span><span class="p">]</span>

            <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming vvvv&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>

        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD integral transformation&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>


<div class="viewcode-block" id="get_umoidx"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.uccsd.get_umoidx">[docs]</a><span class="k">def</span> <span class="nf">get_umoidx</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get MO boolean indices for unrestricted reference, accounting for frozen orbs.&#39;&#39;&#39;</span>
    <span class="n">moidxa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">moidxb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">moidxa</span><span class="p">[:</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">moidxb</span><span class="p">[:</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<span class="c1">#        dm = cc._scf.make_rdm1(cc.mo_coeff, cc.mo_occ)</span>
<span class="c1">#        fockao = cc._scf.get_hcore() + cc._scf.get_veff(cc.mol, dm)</span>
<span class="c1">#        eab = list()</span>
<span class="c1">#        for a in range(2):</span>
<span class="c1">#            eab.append( np.diag(reduce(numpy.dot, (cc.mo_coeff[a].T, fockao[a], cc.mo_coeff[a]))) )</span>
<span class="c1">#        eab = np.array(eab)</span>
<span class="c1">#        #FIXME: if occ-energy &gt; vir-energy, vir orbitals may be appeared in occ set and may be frozen</span>
<span class="c1">#        idxs = np.column_stack(np.unravel_index(np.argsort(eab.ravel()), (2, eab.shape[1])))</span>
<span class="c1">#        frozen = [[],[]]</span>
<span class="c1">#        for n, idx in zip(range(cc.frozen), idxs):</span>
<span class="c1">#            frozen[idx[0]].append(idx[1])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">frozen</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">frozen</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">frozen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">frozen</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
            <span class="n">frozen</span> <span class="o">=</span> <span class="p">[</span><span class="n">frozen</span><span class="p">,</span><span class="n">frozen</span><span class="p">]</span>
        <span class="n">moidxa</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frozen</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">moidxb</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">frozen</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">moidxa</span><span class="p">,</span><span class="n">moidxb</span></div>

<span class="k">def</span> <span class="nf">orbspin_of_sorted_mo_energy</span><span class="p">(</span><span class="n">mo_energy</span><span class="p">,</span> <span class="n">mo_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mo_energy</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="n">mo_energy</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># RHF orbitals</span>
        <span class="n">orbspin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">mo_energy</span><span class="o">.</span><span class="n">size</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">orbspin</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># UHF orbitals</span>
        <span class="k">if</span> <span class="n">mo_occ</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mo_occ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mo_energy</span><span class="p">)</span>
        <span class="n">idxo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">mo_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">],</span>
                          <span class="n">mo_energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">idxv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">mo_energy</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">],</span>
                          <span class="n">mo_energy</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">]])</span><span class="o">.</span><span class="n">argsort</span><span class="p">()</span>
        <span class="n">nocca</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">nvira</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">occspin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">idxo</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">occspin</span><span class="p">[</span><span class="n">nocca</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># label beta orbitals</span>
        <span class="n">virspin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">idxv</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">virspin</span><span class="p">[</span><span class="n">nvira</span><span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">orbspin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">occspin</span><span class="p">[</span><span class="n">idxo</span><span class="p">],</span> <span class="n">virspin</span><span class="p">[</span><span class="n">idxv</span><span class="p">]])</span>
    <span class="k">return</span> <span class="n">orbspin</span>

<div class="viewcode-block" id="uspatial2spin"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.uccsd.uspatial2spin">[docs]</a><span class="k">def</span> <span class="nf">uspatial2spin</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">moidx</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Convert the results of an unrestricted mean-field calculation to spin-orbital form.</span>

<span class="sd">    Spin-orbital ordering is determined by orbital energy without regard for spin.</span>

<span class="sd">    Returns:</span>
<span class="sd">        fock : (nso,nso) ndarray</span>
<span class="sd">            The Fock matrix in the basis of spin-orbitals</span>
<span class="sd">        so_coeff : (nao, nso) ndarray</span>
<span class="sd">            The matrix of spin-orbital coefficients in the AO basis</span>
<span class="sd">        spin : (nso,) ndarary</span>
<span class="sd">            The spin (0 or 1) of each spin-orbital</span>
<span class="sd">    &#39;&#39;&#39;</span>
<span class="c1"># Note: Always recompute the fock matrix in UCCSD because the mf object may be</span>
<span class="c1"># converted from ROHF object in which orbital energies are eigenvalues of</span>
<span class="c1"># Roothaan Fock rather than the true alpha, beta orbital energies.</span>
    <span class="n">dm</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span>
    <span class="n">fockao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span>
    <span class="n">fockab</span> <span class="o">=</span> <span class="p">[</span><span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fockao</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span>
              <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fockao</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>

    <span class="n">mo_energy</span> <span class="o">=</span> <span class="p">[</span><span class="n">fockab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">(),</span> <span class="n">fockab</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()]</span>
    <span class="n">mo_occa</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">moidx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">mo_occb</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">moidx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">spin</span> <span class="o">=</span> <span class="n">orbspin_of_sorted_mo_energy</span><span class="p">(</span><span class="n">mo_energy</span><span class="p">,</span> <span class="p">(</span><span class="n">mo_occa</span><span class="p">,</span><span class="n">mo_occb</span><span class="p">))</span>

    <span class="n">sorta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mo_occa</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mo_occa</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">sortb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mo_occb</span><span class="o">!=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mo_occb</span><span class="o">==</span><span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]])</span>
    <span class="n">idxa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spin</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">idxb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">spin</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">nao</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">nmo</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">fock</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">fockab</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">fock</span><span class="p">,</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">fockab</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sorta</span><span class="p">,</span> <span class="n">sorta</span><span class="p">),</span> <span class="n">idxa</span><span class="p">,</span> <span class="n">idxa</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">fock</span><span class="p">,</span> <span class="n">lib</span><span class="o">.</span><span class="n">take_2d</span><span class="p">(</span><span class="n">fockab</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">sortb</span><span class="p">,</span> <span class="n">sortb</span><span class="p">),</span> <span class="n">idxb</span><span class="p">,</span> <span class="n">idxb</span><span class="p">)</span>

    <span class="n">so_coeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nao</span><span class="p">,</span> <span class="n">nmo</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxa</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">0</span><span class="p">][:,</span><span class="n">sorta</span><span class="p">]</span>
    <span class="n">so_coeff</span><span class="p">[:,</span><span class="n">idxb</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[</span><span class="mi">1</span><span class="p">][:,</span><span class="n">sortb</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">fock</span><span class="p">,</span> <span class="n">so_coeff</span><span class="p">,</span> <span class="n">spin</span></div>


<span class="k">class</span> <span class="nc">_IMDS</span><span class="p">:</span>
    <span class="c1"># Exactly the same as RCCSD IMDS except</span>
    <span class="c1"># -- rintermediates --&gt; uintermediates</span>
    <span class="c1"># -- Loo, Lvv, cc_Fov --&gt; Foo, Fvv, Fov</span>
    <span class="c1"># -- One less 2-virtual intermediate</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">t1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">t2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eris</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">eris</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ip_imds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ea_imds</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ee_imds</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">_make_shared</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">fov</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="n">foo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
        <span class="n">fvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>

        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span>
        <span class="n">Fvv</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">)</span>
        <span class="n">Fvv</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,meaf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">)</span>
        <span class="n">Wmbej</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mebf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">)</span>
        <span class="n">Wmbej</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mfbe-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">)</span>
        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tau_tilde</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nb-&gt;jnfb&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">tau_tilde</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">Foo</span>  <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span><span class="n">tau_tilde</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Fvv</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span><span class="n">tau_tilde</span><span class="p">,</span><span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Wmbej</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">Foo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,mine-&gt;mi&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">eris_ooov</span><span class="p">)</span>
        <span class="n">Foo</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,nime-&gt;mi&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">eris_ooov</span><span class="p">)</span>
        <span class="n">Wmbej</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mjne-&gt;mbej&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">eris_ooov</span><span class="p">)</span>
        <span class="n">Wmbej</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,njme-&gt;mbej&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">eris_ooov</span><span class="p">)</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Foo</span> <span class="o">+=</span> <span class="n">foo</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span><span class="n">fov</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">Foo</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foo</span> <span class="o">=</span> <span class="n">Foo</span>
        <span class="n">Fvv</span> <span class="o">+=</span> <span class="n">fvv</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span><span class="n">fov</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
        <span class="n">Fvv</span> <span class="o">-=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,me-&gt;ae&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvv</span> <span class="o">=</span> <span class="n">Fvv</span>

        <span class="n">Wmbej</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Wmbej</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wovvo</span> <span class="o">=</span> <span class="n">Wmbej</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD shared intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_ip</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_shared</span><span class="p">()</span>

        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>

        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">-</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">Woooo</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mine-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,jnbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wooov</span> <span class="o">=</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Woooo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Woooo</span> <span class="o">=</span> <span class="n">Woooo</span> <span class="o">-</span> <span class="n">Woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Woooo</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Wooov</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,mfne-&gt;mnie&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>

        <span class="n">tmp</span>  <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbej-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Wmbij</span> <span class="o">=</span> <span class="n">Wmbij</span> <span class="o">-</span> <span class="n">Wmbij</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mebj-&gt;mbij&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvo</span><span class="p">)</span>
        <span class="n">tmp</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mjbe-&gt;mbij&#39;</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Wmbij</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ijbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mnij-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Woooo</span><span class="p">)</span>

        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,ijef-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="n">Wmbij</span> <span class="o">-=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfbe,ijef-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">,</span> <span class="n">tau</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wovoo</span> <span class="o">=</span> <span class="n">Wmbij</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ip_imds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD IP intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_ea</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_made_shared</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_make_shared</span><span class="p">()</span>

        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">spatial2spin</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="o">.</span><span class="n">orbspin</span><span class="p">)</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">imd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>

        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">Wabei</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nime,mnab-&gt;abei&#39;</span><span class="p">,</span><span class="n">eris_ooov</span><span class="p">,</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Wabei</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,miab-&gt;abei&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fov</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,menf-&gt;mbei&#39;</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbei-&gt;abei&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mibe-&gt;abei&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mebi-&gt;abei&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvo</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">Wabei</span> <span class="o">+=</span> <span class="n">tmp</span> <span class="o">-</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">)</span>
        <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">eris_ovvv</span> <span class="o">-</span> <span class="n">eris_ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Wabei</span> <span class="o">+=</span> <span class="n">eris_ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,miaf-&gt;abei&#39;</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="n">Wabei</span> <span class="o">-=</span> <span class="n">tmp1</span> <span class="o">-</span> <span class="n">tmp1</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Wvvvo</span> <span class="o">=</span> <span class="n">Wabei</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">made_ea_imds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD EA intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">make_ee</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">eris</span>
        <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
        <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
        <span class="n">nocca</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nvirb</span> <span class="o">=</span> <span class="n">t2ab</span><span class="o">.</span><span class="n">shape</span>

        <span class="n">fooa</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,:</span><span class="n">nocca</span><span class="p">]</span>
        <span class="n">foob</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,:</span><span class="n">noccb</span><span class="p">]</span>
        <span class="n">fova</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[:</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">:]</span>
        <span class="n">fovb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[:</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">:]</span>
        <span class="n">fvva</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">focka</span><span class="p">[</span><span class="n">nocca</span><span class="p">:,</span><span class="n">nocca</span><span class="p">:]</span>
        <span class="n">fvvb</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fockb</span><span class="p">[</span><span class="n">noccb</span><span class="p">:,</span><span class="n">noccb</span><span class="p">:]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvva</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvvb</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">))</span>

        <span class="n">wovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
        <span class="n">wOVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
        <span class="n">woVvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
        <span class="n">woVVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
        <span class="n">wOvVo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
        <span class="n">wOvvO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>

        <span class="n">wovoo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>
        <span class="n">wOVOO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
        <span class="n">woVoO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">noccb</span><span class="p">))</span>
        <span class="n">wOvOo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nocca</span><span class="p">))</span>

        <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvira,nvira)</span>
        <span class="c1">#:ovvv = eris_ovvv - eris_ovvv.transpose(0,3,2,1)</span>
        <span class="c1">#:self.Fvva  = np.einsum(&#39;mf,mfae-&gt;ae&#39;, t1a, ovvv)</span>
        <span class="c1">#:self.wovvo = lib.einsum(&#39;jf,mebf-&gt;mbej&#39;, t1a, ovvv)</span>
        <span class="c1">#:self.wovoo  = 0.5 * einsum(&#39;mebf,ijef-&gt;mbij&#39;, eris_ovvv, tauaa)</span>
        <span class="c1">#:self.wovoo -= 0.5 * einsum(&#39;mfbe,ijef-&gt;mbij&#39;, eris_ovvv, tauaa)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">ovvv</span> <span class="o">-</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fvva</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">wovvo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mebf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">)</span>
            <span class="n">wovoo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,ijef-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">)</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_OVVV = lib.unpack_tril(np.asarray(eris.OVVV).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvirb,nvirb)</span>
        <span class="c1">#:OVVV = eris_OVVV - eris_OVVV.transpose(0,3,2,1)</span>
        <span class="c1">#:self.Fvvb  = np.einsum(&#39;mf,mfae-&gt;ae&#39;, t1b, OVVV)</span>
        <span class="c1">#:self.wOVVO = lib.einsum(&#39;jf,mebf-&gt;mbej&#39;, t1b, OVVV)</span>
        <span class="c1">#:self.wOVOO  = 0.5 * einsum(&#39;mebf,ijef-&gt;mbij&#39;, OVVV, taubb)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="n">OVVV</span> <span class="o">-</span> <span class="n">OVVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fvvb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVVV</span><span class="p">)</span>
            <span class="n">wOVVO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mebf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">)</span>
            <span class="n">wOVOO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,ijef-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">taubb</span><span class="p">)</span>
            <span class="n">OVVV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:self.Fvvb += np.einsum(&#39;mf,mfAE-&gt;AE&#39;, t1a, eris_ovVV)</span>
        <span class="c1">#:self.woVvO = lib.einsum(&#39;JF,meBF-&gt;mBeJ&#39;, t1b, eris_ovVV)</span>
        <span class="c1">#:self.woVVo = lib.einsum(&#39;jf,mfBE-&gt;mBEj&#39;,-t1a, eris_ovVV)</span>
        <span class="c1">#:self.woVoO  = 0.5 * einsum(&#39;meBF,iJeF-&gt;mBiJ&#39;, eris_ovVV, tauab)</span>
        <span class="c1">#:self.woVoO += 0.5 * einsum(&#39;mfBE,iJfE-&gt;mBiJ&#39;, eris_ovVV, tauab)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fvvb</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mf,mfAE-&gt;AE&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">ovVV</span><span class="p">)</span>
            <span class="n">woVvO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JF,meBF-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">)</span>
            <span class="n">woVVo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,mfBE-&gt;mBEj&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1a</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">)</span>
            <span class="n">woVoO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meBF,iJeF-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
            <span class="n">woVoO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfBE,iJfE-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
            <span class="n">ovVV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:self.Fvva += np.einsum(&#39;MF,MFae-&gt;ae&#39;, t1b, eris_OVvv)</span>
        <span class="c1">#:self.wOvVo = lib.einsum(&#39;jf,MEbf-&gt;MbEj&#39;, t1a, eris_OVvv)</span>
        <span class="c1">#:self.wOvvO = lib.einsum(&#39;JF,MFbe-&gt;MbeJ&#39;,-t1b, eris_OVvv)</span>
        <span class="c1">#:self.wOvOo  = 0.5 * einsum(&#39;MEbf,jIfE-&gt;MbIj&#39;, eris_OVvv, tauab)</span>
        <span class="c1">#:self.wOvOo += 0.5 * einsum(&#39;MFbe,jIeF-&gt;MbIj&#39;, eris_OVvv, tauab)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Fvva</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MF,MFae-&gt;ae&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">OVvv</span><span class="p">)</span>
            <span class="n">wOvVo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,MEbf-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">)</span>
            <span class="n">wOvvO</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JF,MFbe-&gt;MbeJ&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1b</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">)</span>
            <span class="n">wOvOo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEbf,jIfE-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
            <span class="n">wOvOo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">+=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFbe,jIeF-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">tauab</span><span class="p">)</span>
            <span class="n">OVvv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">-</span> <span class="n">eris_OVOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NF,meNF-&gt;me&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,menf-&gt;me&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nf,nfME-&gt;ME&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tilaa</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">tilbb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">fac</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilaa</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNeF,meNF-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;inef,menf-&gt;mi&#39;</span><span class="p">,</span> <span class="n">tilbb</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfE,nfME-&gt;MI&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvva</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tilaa</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvva</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mNaF,meNF-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvvb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mnaf,menf-&gt;ae&#39;</span><span class="p">,</span> <span class="n">tilbb</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvvb</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nMfA,nfME-&gt;AE&#39;</span><span class="p">,</span> <span class="n">tilab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">wovvo</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="n">wovvo</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,meNF-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">wOVVO</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="n">wOVVO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,nfME-&gt;MBEJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,menf-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JNFB,meNF-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">wOvVo</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jnfb,nfME-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">wOvVo</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MENF-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="n">woVVo</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNfB,mfNE-&gt;mBEj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">wOvvO</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJbF,neMF-&gt;MbeJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>

        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">)</span>
        <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">)</span>
        <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,mine-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,nime-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NE,miNE-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,mine-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,nime-&gt;mi&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ne,MIne-&gt;MI&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nfme-&gt;njme&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nfme-&gt;njme&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OVOV</span><span class="p">)</span>
        <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">eris_ooOV</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,nfme-&gt;njme&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">eris_OOov</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jf,menf-&gt;njme&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">-</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">-</span> <span class="n">eris_OOOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">wovvo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mjne-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span>      <span class="n">ooov</span><span class="p">)</span>
        <span class="n">wOVVO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mjne-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span>      <span class="n">OOOV</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,NJme-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
        <span class="n">wOvVo</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,njME-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
        <span class="n">woVVo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,mjNE-&gt;mBEj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
        <span class="n">wOvvO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,MJne-&gt;MbeJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Fooa</span> <span class="o">+=</span> <span class="n">fooa</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="o">+</span><span class="n">fova</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Foob</span> <span class="o">+=</span> <span class="n">foob</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ie-&gt;mi&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="o">+</span><span class="n">fovb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvva</span> <span class="o">+=</span> <span class="n">fvva</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="o">+</span><span class="n">fova</span><span class="p">,</span> <span class="n">t1a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Fvvb</span> <span class="o">+=</span> <span class="n">fvvb</span> <span class="o">-</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ma-&gt;ae&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="o">+</span><span class="n">fovb</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>

        <span class="c1"># 0 or 1 virtuals</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">)</span>
        <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">)</span>
        <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">)</span>
        <span class="n">ooov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">-</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">OOOV</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">-</span> <span class="n">eris_OOOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">woooo</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mine-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span>      <span class="n">ooov</span><span class="p">)</span>
        <span class="n">wOOOO</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,mine-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span>      <span class="n">OOOV</span><span class="p">)</span>
        <span class="n">woOoO</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;JE,miNE-&gt;mNiJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">)</span>
        <span class="n">woOOo</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;je,NIme-&gt;mNIj&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">)</span>
        <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,jnbe-&gt;mbij&#39;</span><span class="p">,</span>      <span class="n">ooov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">tmpaa</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,jNbE-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,jnbe-&gt;mbij&#39;</span><span class="p">,</span>      <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">tmpbb</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,nJeB-&gt;MBIJ&#39;</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mine,nJeB-&gt;mBiJ&#39;</span><span class="p">,</span>      <span class="n">ooov</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;miNE,JNBE-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIme,jNeB-&gt;mBjI&#39;</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MINE,jNbE-&gt;MbIj&#39;</span><span class="p">,</span>      <span class="n">OOOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MIne,jnbe-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;niME,nJbE-&gt;MbJi&#39;</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">wovoo</span> <span class="o">+=</span> <span class="n">tmpaa</span> <span class="o">-</span> <span class="n">tmpaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wOVOO</span> <span class="o">+=</span> <span class="n">tmpbb</span> <span class="o">-</span> <span class="n">tmpbb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wooov</span> <span class="o">=</span>       <span class="n">ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOOOV</span> <span class="o">=</span>       <span class="n">OOOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoV</span> <span class="o">=</span> <span class="n">eris_ooOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOoOv</span> <span class="o">=</span> <span class="n">eris_OOov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOooV</span> <span class="o">=-</span><span class="n">eris_ooOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOOv</span> <span class="o">=-</span><span class="n">eris_OOov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">woooo</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">wOOOO</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOO</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">woOoO</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOO</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woooo</span> <span class="o">=</span> <span class="n">woooo</span> <span class="o">-</span> <span class="n">woooo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOOOO</span> <span class="o">=</span> <span class="n">wOOOO</span> <span class="o">-</span> <span class="n">wOOOO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">=</span> <span class="n">woOoO</span> <span class="o">-</span> <span class="n">woOOo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">-</span> <span class="n">eris_OVOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">tauaa</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">taubb</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span><span class="n">t1</span><span class="p">,</span><span class="n">t1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woooo</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">tauaa</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOOOO</span> <span class="o">+=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijef,menf-&gt;mnij&#39;</span><span class="p">,</span> <span class="n">taubb</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span> <span class="o">+=</span>     <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iJeF,meNF-&gt;mNiJ&#39;</span><span class="p">,</span> <span class="n">tauab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wooov</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,mfne-&gt;mnie&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOOOV</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,mfne-&gt;mnie&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOoV</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,mfNE-&gt;mNiE&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOoOv</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IF,neMF-&gt;MnIe&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOooV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;if,nfME-&gt;MniE&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woOOv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IF,meNF-&gt;mNIe&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>

        <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="n">tmp1aa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,meNF-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,menf-&gt;mbej&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="n">tmp1bb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,nfME-&gt;MBEJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NJBF,meNF-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tmp1ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJfB,menf-&gt;mBeJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span>      <span class="n">ovov</span><span class="p">)</span>
        <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njbf,nfME-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tmp1ba</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNbF,MENF-&gt;MbEj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span>      <span class="n">OVOV</span><span class="p">)</span>
        <span class="n">tmp1abba</span> <span class="o">=-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jNfB,mfNE-&gt;mBEj&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tmp1baab</span> <span class="o">=-</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nJbF,neMF-&gt;MbeJ&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">)</span>
        <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbej-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1aa</span><span class="p">)</span>
        <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mbej-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1bb</span><span class="p">)</span>
        <span class="n">tmpab</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mBeJ-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">)</span>
        <span class="n">tmpab</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,mBEj-&gt;mBjI&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1abba</span><span class="p">)</span>
        <span class="n">tmpba</span> <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MbEj-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1ba</span><span class="p">)</span>
        <span class="n">tmpba</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,MbeJ-&gt;MbJi&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1baab</span><span class="p">)</span>
        <span class="n">wovoo</span> <span class="o">-=</span> <span class="n">tmpaa</span> <span class="o">-</span> <span class="n">tmpaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wOVOO</span> <span class="o">-=</span> <span class="n">tmpbb</span> <span class="o">-</span> <span class="n">tmpbb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">-=</span> <span class="n">tmpab</span>
        <span class="n">wOvOo</span> <span class="o">-=</span> <span class="n">tmpba</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">eris_oovo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovo</span><span class="p">)</span>
        <span class="n">eris_OOVO</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVO</span><span class="p">)</span>
        <span class="n">eris_OOvo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvo</span><span class="p">)</span>
        <span class="n">eris_ooVO</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVO</span><span class="p">)</span>
        <span class="n">wovoo</span> <span class="o">+=</span> <span class="n">eris_oovo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris_oovo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wOVOO</span> <span class="o">+=</span> <span class="n">eris_OOVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="o">-</span> <span class="n">eris_OOVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">+=</span> <span class="n">eris_ooVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">+=</span> <span class="n">eris_OOvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">eris_oovo</span> <span class="o">=</span> <span class="n">eris_OOVO</span> <span class="o">=</span> <span class="n">eris_OOvo</span> <span class="o">=</span> <span class="n">eris_ooVO</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span>
        <span class="n">eris_OVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVO</span><span class="p">)</span>
        <span class="n">eris_OVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvo</span><span class="p">)</span>
        <span class="n">eris_ovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVO</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span>
        <span class="n">eris_OOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">)</span>
        <span class="n">eris_OOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">)</span>
        <span class="n">eris_ooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">)</span>
        <span class="n">wovvo</span> <span class="o">+=</span> <span class="n">eris_ovvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">wOVVO</span> <span class="o">+=</span> <span class="n">eris_OVVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">woVvO</span> <span class="o">+=</span> <span class="n">eris_ovVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">wOvVo</span> <span class="o">+=</span> <span class="n">eris_OVvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">wovvo</span> <span class="o">-=</span> <span class="n">eris_oovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wOVVO</span> <span class="o">-=</span> <span class="n">eris_OOVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">woVVo</span> <span class="o">-=</span> <span class="n">eris_ooVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">wOvvO</span> <span class="o">-=</span> <span class="n">eris_OOvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">tmpaa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mebj-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovvo</span><span class="p">)</span>
        <span class="n">tmpbb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mebj-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OVVO</span><span class="p">)</span>
        <span class="n">tmpaa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mjbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">)</span>
        <span class="n">tmpbb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,mjbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOVV</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,meBJ-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovVO</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,mjBE-&gt;mBjI&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1b</span><span class="p">,</span> <span class="n">eris_ooVV</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;IE,MEbj-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OVvo</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ie,MJbe-&gt;MbJi&#39;</span><span class="p">,</span><span class="o">-</span><span class="n">t1a</span><span class="p">,</span> <span class="n">eris_OOvv</span><span class="p">)</span>
        <span class="n">wovoo</span> <span class="o">+=</span> <span class="n">tmpaa</span> <span class="o">-</span> <span class="n">tmpaa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wOVOO</span> <span class="o">+=</span> <span class="n">tmpbb</span> <span class="o">-</span> <span class="n">tmpbb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">wovoo</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ijbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">)</span>
        <span class="n">wOVOO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,ijbe-&gt;mbij&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,iJeB-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,jIbE-&gt;MbIj&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">)</span>
        <span class="n">wovoo</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mnij-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">woooo</span><span class="p">)</span>
        <span class="n">wOVOO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,mnij-&gt;mbij&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wOOOO</span><span class="p">)</span>
        <span class="n">woVoO</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NB,mNiJ-&gt;mBiJ&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span><span class="p">)</span>
        <span class="n">wOvOo</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nb,nMjI-&gt;MbIj&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">woOoO</span><span class="p">)</span>
        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">eris_OVVO</span> <span class="o">=</span> <span class="n">eris_OVvo</span> <span class="o">=</span> <span class="n">eris_ovVO</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">eris_OOVV</span> <span class="o">=</span> <span class="n">eris_OOvv</span> <span class="o">=</span> <span class="n">eris_ooVV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;ovvo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wovvo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OVVO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wOVVO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;oVvO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">woVvO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OvVo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wOvVo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;oVVo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">woVVo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OvvO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wOvvO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wovvo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;ovvo&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOVVO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OVVO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVvO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;oVvO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOvVo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OvVo&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVVo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;oVVo&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOvvO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OvvO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;ovoo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wovoo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OVOO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wOVOO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;oVoO&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">woVoO</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OvOo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">wOvOo</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wovoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;ovoo&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOVOO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OVOO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">woVoO</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;oVoO&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wOvOo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="p">[</span><span class="s1">&#39;OvOo&#39;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wvovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;vovv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nvira</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wVOVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;VOVV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nvirb</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;vOvV&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nvira</span><span class="p">,</span><span class="n">noccb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">),</span> <span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wVoVv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">saved</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;VoVv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nocca</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">),</span> <span class="n">t1a</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">char</span><span class="p">)</span>

        <span class="c1"># 3 or 4 virtuals</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">ovov</span> <span class="o">=</span> <span class="n">eris_ovov</span> <span class="o">-</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">)</span>
        <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvo</span><span class="p">)</span>
        <span class="n">oovv</span> <span class="o">=</span> <span class="n">eris_oovv</span> <span class="o">-</span> <span class="n">eris_ovvo</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">eris_ovvo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#:wvovv  = .5 * lib.einsum(&#39;nime,mnab-&gt;eiab&#39;, eris_ooov, tauaa)</span>
        <span class="c1">#:wvovv -= .5 * lib.einsum(&#39;me,miab-&gt;eiab&#39;, self.Fova, t2aa)</span>
        <span class="c1">#:tmp1aa = lib.einsum(&#39;nibf,menf-&gt;mbei&#39;, t2aa,      ovov)</span>
        <span class="c1">#:tmp1aa-= lib.einsum(&#39;iNbF,meNF-&gt;mbei&#39;, t2ab, eris_ovOV)</span>
        <span class="c1">#:wvovv+= lib.einsum(&#39;ma,mbei-&gt;eiab&#39;, t1a, tmp1aa)</span>
        <span class="c1">#:wvovv+= einsum(&#39;ma,mibe-&gt;eiab&#39;, t1a,      oovv)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">):</span>
            <span class="n">wvovv</span>  <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nime,mnab-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tauaa</span><span class="p">)</span>
            <span class="n">wvovv</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,miab-&gt;eiab&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t2aa</span><span class="p">)</span>

            <span class="n">tmp1aa</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,menf-&gt;mbei&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">ovov</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1aa</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNbF,meNF-&gt;mbei&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wvovv</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbei-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1aa</span><span class="p">)</span>
            <span class="n">wvovv</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mibe-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">oovv</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wvovv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvovv</span>
            <span class="n">tmp1aa</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvira,nvira)</span>
        <span class="c1">#:ovvv = eris_ovvv - eris_ovvv.transpose(0,3,2,1)</span>
        <span class="c1">#:wvovv += lib.einsum(&#39;mebf,miaf-&gt;eiab&#39;,      ovvv, t2aa)</span>
        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:wvovv += lib.einsum(&#39;MFbe,iMaF-&gt;eiab&#39;, eris_OVvv, t2ab)</span>
        <span class="c1">#:wvovv += eris_ovvv.transpose(2,0,3,1).conj()</span>
        <span class="c1">#:self.wvovv -= wvovv - wvovv.transpose(0,1,3,2)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">MAX_MEMORY</span> <span class="o">-</span> <span class="n">mem_now</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">6</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wvovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvovv</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
                <span class="n">wvovv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFbe,iMaF-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p0</span> <span class="o">==</span> <span class="n">i0</span><span class="p">:</span>
                    <span class="n">wvovv</span> <span class="o">+=</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">ovvv</span> <span class="o">-</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wvovv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,miaf-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wvovv</span> <span class="o">=</span> <span class="n">wvovv</span> <span class="o">-</span> <span class="n">wvovv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wvovv</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvovv</span>

        <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOOV</span><span class="p">)</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVOV</span><span class="p">)</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">OVOV</span> <span class="o">=</span> <span class="n">eris_OVOV</span> <span class="o">-</span> <span class="n">eris_OVOV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_OOVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOVV</span><span class="p">)</span>
        <span class="n">eris_OVVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVO</span><span class="p">)</span>
        <span class="n">OOVV</span> <span class="o">=</span> <span class="n">eris_OOVV</span> <span class="o">-</span> <span class="n">eris_OVVO</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_OOVV</span> <span class="o">=</span> <span class="n">eris_OVVO</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1">#:wVOVV  = .5*lib.einsum(&#39;nime,mnab-&gt;eiab&#39;, eris_OOOV, taubb)</span>
        <span class="c1">#:wVOVV -= .5*lib.einsum(&#39;me,miab-&gt;eiab&#39;, self.Fovb, t2bb)</span>
        <span class="c1">#:tmp1bb = lib.einsum(&#39;nibf,menf-&gt;mbei&#39;, t2bb,      OVOV)</span>
        <span class="c1">#:tmp1bb-= lib.einsum(&#39;nIfB,nfME-&gt;MBEI&#39;, t2ab, eris_ovOV)</span>
        <span class="c1">#:wVOVV += lib.einsum(&#39;ma,mbei-&gt;eiab&#39;, t1b, tmp1bb)</span>
        <span class="c1">#:wVOVV += einsum(&#39;ma,mibe-&gt;eiab&#39;, t1b,      OOVV)</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">):</span>
            <span class="n">wVOVV</span>  <span class="o">=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nime,mnab-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">eris_OOOV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">taubb</span><span class="p">)</span>
            <span class="n">wVOVV</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,miab-&gt;eiab&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t2bb</span><span class="p">)</span>

            <span class="n">tmp1bb</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,menf-&gt;mbei&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1bb</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfB,nfME-&gt;MBEI&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wVOVV</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mbei-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1bb</span><span class="p">)</span>
            <span class="n">wVOVV</span> <span class="o">+=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mibe-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">OOVV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wVOVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wVOVV</span>
            <span class="n">tmp1bb</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">eris_OVOV</span> <span class="o">=</span> <span class="n">eris_OOOV</span> <span class="o">=</span> <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_OVVV = lib.unpack_tril(np.asarray(eris.OVVV).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvirb,nvirb)</span>
        <span class="c1">#:OVVV = eris_OVVV - eris_OVVV.transpose(0,3,2,1)</span>
        <span class="c1">#:wVOVV -= lib.einsum(&#39;MEBF,MIAF-&gt;EIAB&#39;,      OVVV, t2bb)</span>
        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:wVOVV -= lib.einsum(&#39;mfBE,mIfA-&gt;EIAB&#39;, eris_ovVV, t2ab)</span>
        <span class="c1">#:wVOVV += eris_OVVV.transpose(2,0,3,1).conj()</span>
        <span class="c1">#:self.wVOVV += wVOVV - wVOVV.transpose(0,1,3,2)</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">6</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wVOVV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wVOVV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
                <span class="n">wVOVV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfBE,mIfA-&gt;EIAB&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p0</span> <span class="o">==</span> <span class="n">i0</span><span class="p">:</span>
                    <span class="n">wVOVV</span> <span class="o">+=</span> <span class="n">OVVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="n">OVVV</span> <span class="o">-</span> <span class="n">OVVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wVOVV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,miaf-&gt;eiab&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wVOVV</span> <span class="o">=</span> <span class="n">wVOVV</span> <span class="o">-</span> <span class="n">wVOVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wVOVV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wVOVV</span>

        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOov</span><span class="p">)</span>
        <span class="n">eris_OOvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OOvv</span><span class="p">)</span>
        <span class="n">eris_ovVO</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVO</span><span class="p">)</span>
        <span class="c1">#:self.wvOvV = einsum(&#39;NIme,mNaB-&gt;eIaB&#39;, eris_OOov, tauab)</span>
        <span class="c1">#:self.wvOvV -= lib.einsum(&#39;me,mIaB-&gt;eIaB&#39;, self.Fova, t2ab)</span>
        <span class="c1">#:tmp1ab = lib.einsum(&#39;NIBF,meNF-&gt;mBeI&#39;, t2bb, eris_ovOV)</span>
        <span class="c1">#:tmp1ab-= lib.einsum(&#39;nIfB,menf-&gt;mBeI&#39;, t2ab,      ovov)</span>
        <span class="c1">#:tmp1baab = lib.einsum(&#39;nIbF,neMF-&gt;MbeI&#39;, t2ab, eris_ovOV)</span>
        <span class="c1">#:tmpab = lib.einsum(&#39;ma,mBeI-&gt;eIaB&#39;, t1a, tmp1ab)</span>
        <span class="c1">#:tmpab+= lib.einsum(&#39;MA,MbeI-&gt;eIbA&#39;, t1b, tmp1baab)</span>
        <span class="c1">#:tmpab-= einsum(&#39;MA,MIbe-&gt;eIbA&#39;, t1b, eris_OOvv)</span>
        <span class="c1">#:tmpab-= einsum(&#39;ma,meBI-&gt;eIaB&#39;, t1a, eris_ovVO)</span>
        <span class="c1">#:self.wvOvV += tmpab</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvira</span><span class="p">,</span> <span class="n">nocca</span><span class="p">):</span>
            <span class="n">wvOvV</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIme,mNaB-&gt;eIaB&#39;</span><span class="p">,</span> <span class="n">eris_OOov</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tauab</span><span class="p">)</span>
            <span class="n">wvOvV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;me,mIaB-&gt;eIaB&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fova</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">)</span>
            <span class="n">tmp1ab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;NIBF,meNF-&gt;mBeI&#39;</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1ab</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIfB,menf-&gt;mBeI&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">ovov</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wvOvV</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mBeI-&gt;eIaB&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1ab</span><span class="p">)</span>
            <span class="n">tmp1ab</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp1baab</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nIbF,neMF-&gt;MbeI&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wvOvV</span><span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MbeI-&gt;eIbA&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1baab</span><span class="p">)</span>
            <span class="n">tmp1baab</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wvOvV</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MIbe-&gt;eIbA&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OOvv</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wvOvV</span><span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,meBI-&gt;eIaB&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ovVO</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvOvV</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">eris_OOov</span> <span class="o">=</span> <span class="n">eris_OOvv</span> <span class="o">=</span> <span class="n">eris_ovVO</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_ovvv = lib.unpack_tril(np.asarray(eris.ovvv).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvira,nvira)</span>
        <span class="c1">#:ovvv = eris_ovvv - eris_ovvv.transpose(0,3,2,1)</span>
        <span class="c1">#:self.wvOvV -= lib.einsum(&#39;mebf,mIfA-&gt;eIbA&#39;,      ovvv, t2ab)</span>
        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:self.wvOvV -= lib.einsum(&#39;meBF,mIaF-&gt;eIaB&#39;, eris_ovVV, t2ab)</span>
        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:self.wvOvV -= lib.einsum(&#39;MFbe,MIAF-&gt;eIbA&#39;, eris_OVvv, t2bb)</span>
        <span class="c1">#:self.wvOvV += eris_OVvv.transpose(2,0,3,1).conj()</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">6</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wvOvV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
                <span class="n">wvOvV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;meBF,mIaF-&gt;eIaB&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="n">ovvv</span> <span class="o">-</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wvOvV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mebf,mIfA-&gt;eIbA&#39;</span><span class="p">,</span><span class="n">ovvv</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">ovvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvOvV</span>

        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">*</span><span class="n">nvira</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wvOvV</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocca</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p0</span> <span class="o">==</span> <span class="n">i0</span><span class="p">:</span>
                    <span class="n">wvOvV</span> <span class="o">+=</span> <span class="n">OVvv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">wvOvV</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MFbe,MIAF-&gt;eIbA&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wvOvV</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wvOvV</span>

        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovOV</span><span class="p">)</span>
        <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooOV</span><span class="p">)</span>
        <span class="n">eris_ooVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooVV</span><span class="p">)</span>
        <span class="n">eris_OVvo</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvo</span><span class="p">)</span>
        <span class="c1">#:self.wVoVv = einsum(&#39;niME,nMbA-&gt;EiAb&#39;, eris_ooOV, tauab)</span>
        <span class="c1">#:self.wVoVv -= lib.einsum(&#39;ME,iMbA-&gt;EiAb&#39;, self.Fovb, t2ab)</span>
        <span class="c1">#:tmp1ba = lib.einsum(&#39;nibf,nfME-&gt;MbEi&#39;, t2aa, eris_ovOV)</span>
        <span class="c1">#:tmp1ba-= lib.einsum(&#39;iNbF,MENF-&gt;MbEi&#39;, t2ab,      OVOV)</span>
        <span class="c1">#:tmp1abba = lib.einsum(&#39;iNfB,mfNE-&gt;mBEi&#39;, t2ab, eris_ovOV)</span>
        <span class="c1">#:tmpba = lib.einsum(&#39;MA,MbEi-&gt;EiAb&#39;, t1b, tmp1ba)</span>
        <span class="c1">#:tmpba+= lib.einsum(&#39;ma,mBEi-&gt;EiBa&#39;, t1a, tmp1abba)</span>
        <span class="c1">#:tmpba-= einsum(&#39;ma,miBE-&gt;EiBa&#39;, t1a, eris_ooVV)</span>
        <span class="c1">#:tmpba-= einsum(&#39;MA,MEbi-&gt;EiAb&#39;, t1b, eris_OVvo)</span>
        <span class="c1">#:self.wVoVv += tmpba</span>
        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvirb</span><span class="p">,</span> <span class="n">noccb</span><span class="p">):</span>
            <span class="n">wVoVv</span>  <span class="o">=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;niME,nMbA-&gt;EiAb&#39;</span><span class="p">,</span> <span class="n">eris_ooOV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">tauab</span><span class="p">)</span>
            <span class="n">wVoVv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ME,iMbA-&gt;EiAb&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Fovb</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t2ab</span><span class="p">)</span>
            <span class="n">tmp1ba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nibf,nfME-&gt;MbEi&#39;</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">tmp1ba</span><span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNbF,MENF-&gt;MbEi&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">OVOV</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wVoVv</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MbEi-&gt;EiAb&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">tmp1ba</span><span class="p">)</span>
            <span class="n">tmp1ba</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">tmp1abba</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;iNfB,mfNE-&gt;mBEi&#39;</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">eris_ovOV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wVoVv</span> <span class="o">+=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,mBEi-&gt;EiBa&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">tmp1abba</span><span class="p">)</span>
            <span class="n">tmp1abba</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">wVoVv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ma,miBE-&gt;EiBa&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">eris_ooVV</span><span class="p">[:,:,:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="n">wVoVv</span> <span class="o">-=</span> <span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MA,MEbi-&gt;EiAb&#39;</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">eris_OVvo</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wVoVv</span>
        <span class="n">eris_ovOV</span> <span class="o">=</span> <span class="n">eris_ooOV</span> <span class="o">=</span> <span class="n">eris_ooVV</span> <span class="o">=</span> <span class="n">eris_OVvo</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1">#:eris_OVVV = lib.unpack_tril(np.asarray(eris.OVVV).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvirb,nvirb)</span>
        <span class="c1">#:OVVV = eris_OVVV - eris_OVVV.transpose(0,3,2,1)</span>
        <span class="c1">#:self.wVoVv -= lib.einsum(&#39;MEBF,iMaF-&gt;EiBa&#39;,      OVVV, t2ab)</span>
        <span class="c1">#:eris_OVvv = lib.unpack_tril(np.asarray(eris.OVvv).reshape(noccb*nvirb,-1)).reshape(noccb,nvirb,nvira,nvira)</span>
        <span class="c1">#:self.wVoVv -= lib.einsum(&#39;MEbf,iMfA-&gt;EiAb&#39;, eris_OVvv, t2ab)</span>
        <span class="c1">#:eris_ovVV = lib.unpack_tril(np.asarray(eris.ovVV).reshape(nocca*nvira,-1)).reshape(nocca,nvira,nvirb,nvirb)</span>
        <span class="c1">#:self.wVoVv -= lib.einsum(&#39;mfBE,miaf-&gt;EiBa&#39;, eris_ovVV, t2aa)</span>
        <span class="c1">#:self.wVoVv += eris_ovVV.transpose(2,0,3,1).conj()</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">6</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wVoVv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVvv</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvira</span><span class="p">)</span>
                <span class="n">wVoVv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEbf,iMfA-&gt;EiAb&#39;</span><span class="p">,</span> <span class="n">OVvv</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
                <span class="n">OVvv</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">OVVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvirb</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">OVVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="n">OVVV</span> <span class="o">-</span> <span class="n">OVVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">wVoVv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;MEBF,iMaF-&gt;EiBa&#39;</span><span class="p">,</span> <span class="n">OVVV</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">[</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
                <span class="n">OVVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wVoVv</span>

        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvira</span><span class="o">*</span><span class="n">nvirb</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">3</span><span class="p">)),</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i0</span><span class="p">,</span><span class="n">i1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">wVoVv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">p0</span><span class="p">,</span><span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">noccb</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovVV</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nvira</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">ovVV</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvira</span><span class="p">,</span><span class="n">nvirb</span><span class="p">,</span><span class="n">nvirb</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p0</span> <span class="o">==</span> <span class="n">i0</span><span class="p">:</span>
                    <span class="n">wVoVv</span> <span class="o">+=</span> <span class="n">ovVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
                <span class="n">wVoVv</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;mfBE,miaf-&gt;EiBa&#39;</span><span class="p">,</span> <span class="n">ovVV</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">])</span>
                <span class="n">ovVV</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wVoVv</span><span class="p">[:,</span><span class="n">i0</span><span class="p">:</span><span class="n">i1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wVoVv</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">made_ee_imds</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;EOM-CCSD EE intermediates&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">r1a</span><span class="p">,</span> <span class="n">r1b</span> <span class="o">=</span> <span class="n">r1</span>
    <span class="n">tau1aa</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">r1a</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="n">tau1bb</span> <span class="o">=</span> <span class="n">make_tau_aa</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">r1b</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="n">tau1ab</span> <span class="o">=</span> <span class="n">make_tau_ab</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">tau1aa</span><span class="p">,</span> <span class="n">tau1ab</span><span class="p">,</span> <span class="n">tau1bb</span>

<span class="k">def</span> <span class="nf">make_tau_aa</span><span class="p">(</span><span class="n">t2aa</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">r1a</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">tau1aa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
    <span class="n">tau1aa</span><span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;jiab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">r1a</span><span class="p">)</span>
    <span class="n">tau1aa</span> <span class="o">=</span> <span class="n">tau1aa</span> <span class="o">-</span> <span class="n">tau1aa</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">tau1aa</span> <span class="o">*=</span> <span class="n">fac</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">tau1aa</span> <span class="o">+=</span> <span class="n">t2aa</span>
    <span class="k">return</span> <span class="n">tau1aa</span>

<span class="k">def</span> <span class="nf">make_tau_ab</span><span class="p">(</span><span class="n">t2ab</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span> <span class="o">=</span> <span class="n">t1</span>
    <span class="n">r1a</span><span class="p">,</span> <span class="n">r1b</span> <span class="o">=</span> <span class="n">r1</span>
    <span class="n">tau1ab</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">r1b</span><span class="p">)</span>
    <span class="n">tau1ab</span><span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">r1a</span><span class="p">,</span> <span class="n">t1b</span><span class="p">)</span>
    <span class="n">tau1ab</span> <span class="o">*=</span> <span class="n">fac</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">tau1ab</span> <span class="o">+=</span> <span class="n">t2ab</span>
    <span class="k">return</span> <span class="n">tau1ab</span>

<span class="k">def</span> <span class="nf">_add_vvvv_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">Ht2</span><span class="p">):</span>
    <span class="n">t2aa</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">t2bb</span> <span class="o">=</span> <span class="n">t2</span>
    <span class="n">u2aa</span><span class="p">,</span> <span class="n">u2ab</span><span class="p">,</span> <span class="n">u2bb</span> <span class="o">=</span> <span class="n">Ht2</span>
    <span class="n">rccsd</span><span class="o">.</span><span class="n">_add_vvvv_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2aa</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">u2aa</span><span class="p">)</span>
    <span class="n">fakeri</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span><span class="kc">None</span>
    <span class="n">fakeri</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">VVVV</span>
    <span class="n">rccsd</span><span class="o">.</span><span class="n">_add_vvvv_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2bb</span><span class="p">,</span> <span class="n">fakeri</span><span class="p">,</span> <span class="n">u2bb</span><span class="p">)</span>
    <span class="n">fakeri</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">vvVV</span>
    <span class="n">rccsd</span><span class="o">.</span><span class="n">_add_vvvv1_</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">t2ab</span><span class="p">,</span> <span class="n">fakeri</span><span class="p">,</span> <span class="n">u2ab</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">u2aa</span><span class="p">,</span><span class="n">u2ab</span><span class="p">,</span><span class="n">u2bb</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">scf</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">gto</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="p">[[</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">0.</span><span class="p">,</span>   <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)],</span>
                <span class="p">[</span><span class="s1">&#39;O&#39;</span><span class="p">,</span> <span class="p">(</span><span class="mf">1.21</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)]]</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="s1">&#39;cc-pvdz&#39;</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">spin</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">UHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">scf</span><span class="p">())</span>
    <span class="c1"># Freeze 1s electrons</span>
    <span class="n">frozen</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]</span>
    <span class="c1"># also acceptable</span>
    <span class="c1">#frozen = 4</span>
    <span class="n">ucc</span> <span class="o">=</span> <span class="n">UCCSD</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="n">frozen</span><span class="p">)</span>
    <span class="n">ecc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">ucc</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ecc</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.3486987472235819</span><span class="p">)</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">8</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="mf">0.</span>     <span class="p">,</span> <span class="mf">0.</span><span class="p">)],</span>
        <span class="p">[</span><span class="mi">1</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.757</span> <span class="p">,</span> <span class="mf">0.587</span><span class="p">)],</span>
        <span class="p">[</span><span class="mi">1</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="mf">0.757</span>  <span class="p">,</span> <span class="mf">0.587</span><span class="p">)]]</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="s1">&#39;cc-pvdz&#39;</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">spin</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">UHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">scf</span><span class="p">())</span>

    <span class="n">mycc</span> <span class="o">=</span> <span class="n">UCCSD</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
    <span class="n">ecc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">kernel</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ecc</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.2133432712431435</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">ccsd_t</span><span class="p">()</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.003060021865720902</span><span class="p">)</span>

    <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">ipccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.4335604332073799</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5187659896045407</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.6782876002229172</span><span class="p">)</span>

    <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">eaccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.16737886338859731</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.24027613852009164</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.51006797826488071</span><span class="p">)</span>

    <span class="n">e</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">eeccsd</span><span class="p">(</span><span class="n">nroots</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.2757159395886167</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.2757159395886167</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.2757159395886167</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.3005716731825082</span><span class="p">)</span>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-, Qiming Sun &lt;osirpt.sun@gmail.com&gt;.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.4.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>