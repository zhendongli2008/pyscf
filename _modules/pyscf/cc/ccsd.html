

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pyscf.cc.ccsd &mdash; PySCF 1.4.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="PySCF 1.4.0 documentation" href="../../../index.html"/>
        <link rel="up" title="Module code" href="../../index.html"/> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> PySCF
          

          
          </a>

          
            
            
              <div class="version">
                1.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../overview.html">An overview of PySCF</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../advanced.html">Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../gto.html">gto &#8212; Molecular structure and GTO basis</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lib.html">lib &#8212; Helper functions, parameters, and C extensions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scf.html">scf &#8212; Mean-field methods</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ao2mo.html">ao2mo &#8212; Integral transformations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mcscf.html">mcscf &#8212; Multi-configurational self-consistent field</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fci.html">fci &#8212; Full configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../symm.html">symm &#8211; Point group symmetry and spin symmetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../df.html">df &#8212; Density fitting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dft.html">dft &#8212; Density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tddft.html">tddft &#8212; Time dependent density functional theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cc.html">cc &#8212; Coupled cluster</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ci.html">ci &#8212; Configuration interaction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../dmrgscf.html">dmrgscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../fciqmcscf.html">fciqmcscf</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tools.html">tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../grad.html">grad &#8212; Analytical nuclear gradients</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../hessian.html">hessian &#8212; Analytical nuclear Hessian</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pbc.html">pbc &#8212; Periodic boundary conditions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lo.html">lo &#8212; Orbital localization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qmmm.html">qmmm &#8212; QM/MM interface</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../mrpt.html">mrpt &#8212; Multi-reference perturbation theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../benchmark.html">Benchmark</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../code-rule.html">Code standard</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../version.html">Version history</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PySCF</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>pyscf.cc.ccsd</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pyscf.cc.ccsd</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1">#</span>
<span class="c1"># Author: Qiming Sun &lt;osirpt.sun@gmail.com&gt;</span>
<span class="c1">#</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">ctypes</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">reduce</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">h5py</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">gto</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">lib</span>
<span class="kn">from</span> <span class="nn">pyscf.lib</span> <span class="k">import</span> <span class="n">logger</span>
<span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">ao2mo</span>
<span class="kn">from</span> <span class="nn">pyscf.ao2mo</span> <span class="k">import</span> <span class="n">_ao2mo</span>
<span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">_ccsd</span>
<span class="n">_dgemm</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">numpy_helper</span><span class="o">.</span><span class="n">_dgemm</span>

<span class="n">BLKMIN</span> <span class="o">=</span> <span class="mi">4</span>

<span class="c1"># t2 as ijab</span>

<span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="n">tolnormt</span><span class="o">=</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span>
           <span class="n">verbose</span><span class="o">=</span><span class="n">logger</span><span class="o">.</span><span class="n">INFO</span><span class="p">):</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">new_logger</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">verbose</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">get_init_guess</span><span class="p">(</span><span class="n">eris</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">elif</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">get_init_guess</span><span class="p">(</span><span class="n">eris</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

    <span class="n">cput1</span> <span class="o">=</span> <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">eold</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">eccsd</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis</span><span class="p">:</span>
        <span class="n">adiis</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">diis</span><span class="o">.</span><span class="n">DIIS</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis_file</span><span class="p">)</span>
        <span class="n">adiis</span><span class="o">.</span><span class="n">space</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis_space</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">adiis</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="n">t1</span><span class="p">,</span><span class="n">t2</span><span class="p">)</span>

    <span class="n">conv</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">istep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_cycle</span><span class="p">):</span>
        <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">update_amps</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
        <span class="n">normt</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t1new</span><span class="o">-</span><span class="n">t1</span><span class="p">)</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">t2new</span><span class="o">-</span><span class="n">t2</span><span class="p">)</span>
        <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span>
        <span class="n">t1new</span> <span class="o">=</span> <span class="n">t2new</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis</span><span class="p">:</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">eccsd</span><span class="o">-</span><span class="n">eold</span><span class="p">,</span> <span class="n">adiis</span><span class="p">)</span>
        <span class="n">eold</span><span class="p">,</span> <span class="n">eccsd</span> <span class="o">=</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">energy</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;cycle = </span><span class="si">%d</span><span class="s1">  E(CCSD) = </span><span class="si">%.15g</span><span class="s1">  dE = </span><span class="si">%.9g</span><span class="s1">  norm(t1,t2) = </span><span class="si">%.6g</span><span class="s1">&#39;</span><span class="p">,</span>
                 <span class="n">istep</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">eccsd</span> <span class="o">-</span> <span class="n">eold</span><span class="p">,</span> <span class="n">normt</span><span class="p">)</span>
        <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD iter&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">eccsd</span><span class="o">-</span><span class="n">eold</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">tol</span> <span class="ow">and</span> <span class="n">normt</span> <span class="o">&lt;</span> <span class="n">tolnormt</span><span class="p">:</span>
            <span class="n">conv</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
    <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conv</span><span class="p">,</span> <span class="n">eccsd</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>


<span class="k">def</span> <span class="nf">update_amps</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span>
    <span class="n">fock</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span>

    <span class="n">t1t2new</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nov</span><span class="o">+</span><span class="n">nov</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">t1new</span> <span class="o">=</span> <span class="n">t1t2new</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">t2new</span> <span class="o">=</span> <span class="n">t1t2new</span><span class="p">[</span><span class="n">nov</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">t2new_tril</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
    <span class="n">mycc</span><span class="o">.</span><span class="n">add_wvvVV_</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t2new_tril</span><span class="p">)</span>
    <span class="n">idxo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">takebak_2d</span><span class="p">(</span><span class="n">t2new</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">t2new_tril</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span>
                   <span class="n">idxo</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">nocc</span><span class="o">+</span><span class="n">idxo</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">idxo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">nocc</span><span class="p">)</span>
    <span class="n">t2new</span><span class="p">[</span><span class="n">idxo</span><span class="p">,</span><span class="n">idxo</span><span class="p">]</span> <span class="o">*=</span> <span class="o">.</span><span class="mi">5</span>
    <span class="n">t2new_tril</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;vvvv&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>

<span class="c1">#** make_inter_F</span>
    <span class="n">fov</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">t1new</span> <span class="o">+=</span> <span class="n">fov</span>

    <span class="n">foo</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">foo</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">foo</span> <span class="o">+=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ja-&gt;ij&#39;</span><span class="p">,</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:],</span> <span class="n">t1</span><span class="p">)</span>

    <span class="n">fvv</span> <span class="o">=</span> <span class="n">fock</span><span class="p">[</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">fvv</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">),</span><span class="nb">range</span><span class="p">(</span><span class="n">nvir</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fvv</span> <span class="o">-=</span> <span class="o">.</span><span class="mi">5</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ib-&gt;ab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:])</span>

    <span class="c1">#: woooo = numpy.einsum(&#39;la,ikja-&gt;ikjl&#39;, t1, eris.ooov)</span>
    <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">)</span>
    <span class="n">foo</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kc,jikc-&gt;ij&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
    <span class="n">foo</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kc,jkic-&gt;ij&#39;</span><span class="p">,</span>  <span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_ooov</span><span class="p">)</span>
    <span class="n">woooo</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">eris_ooov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">t1</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nocc</span><span class="p">,)</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">woooo</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose_sum</span><span class="p">(</span><span class="n">woooo</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">woooo</span> <span class="o">+=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oooo</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">woooo</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">woooo</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">eris_ooov</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;woooo&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time1</span><span class="p">)</span>

    <span class="n">unit</span> <span class="o">=</span> <span class="n">_memory_usage_inloop</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
    <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">blksize</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">BLKMIN</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_memory</span><span class="o">/</span><span class="n">unit</span><span class="p">)))</span>
    <span class="n">blknvir</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">max_memory</span><span class="o">*.</span><span class="mi">9</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">-</span><span class="n">blksize</span><span class="o">*</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">6</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">blksize</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">blknvir</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">BLKMIN</span><span class="p">,</span> <span class="n">blknvir</span><span class="p">))</span>
    <span class="n">log</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="s1">&#39;max_memory </span><span class="si">%d</span><span class="s1"> MB,  nocc,nvir = </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">  blksize = </span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span>
               <span class="n">max_memory</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">blksize</span><span class="p">,</span> <span class="n">blknvir</span><span class="p">)</span>
    <span class="n">nvir_pair</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
    <span class="k">def</span> <span class="nf">load_ovvv</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">q1</span> <span class="o">!=</span> <span class="n">nvir</span><span class="p">:</span>
            <span class="n">q0</span><span class="p">,</span> <span class="n">q1</span> <span class="o">=</span> <span class="n">q1</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span> <span class="n">q1</span><span class="o">+</span><span class="n">blknvir</span><span class="p">)</span>
            <span class="n">readbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">q1</span><span class="o">-</span><span class="n">q0</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
            <span class="n">readbuf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">load_eri</span><span class="p">(</span><span class="n">eri</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">buf</span><span class="p">):</span>
        <span class="n">buf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span>

    <span class="n">buflen</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">bufs</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">5</span><span class="p">,</span><span class="n">blksize</span><span class="o">*</span><span class="n">buflen</span><span class="p">))</span>
    <span class="n">buf1</span><span class="p">,</span> <span class="n">buf2</span><span class="p">,</span> <span class="n">buf3</span><span class="p">,</span> <span class="n">buf4</span><span class="p">,</span> <span class="n">buf5</span> <span class="o">=</span> <span class="n">bufs</span>
    <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
    <span class="c1">#: wOoVv += numpy.einsum(&#39;iabc,jc-&gt;ijab&#39;, eris.ovvv, t1)</span>
    <span class="c1">#: wOoVv -= numpy.einsum(&#39;jbik,ka-&gt;jiba&#39;, eris.ovoo, t1)</span>
        <span class="n">wOoVv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf3</span><span class="p">)</span>
        <span class="n">wooVV</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf4</span><span class="p">)</span>
        <span class="n">readbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">blknvir</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">))</span>
        <span class="n">prefetchbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">blknvir</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">))</span>
        <span class="n">ovvvbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">blknvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">lib</span><span class="o">.</span><span class="n">call_in_background</span><span class="p">(</span><span class="n">load_ovvv</span><span class="p">)</span> <span class="k">as</span> <span class="n">prefetch_ovvv</span><span class="p">:</span>
            <span class="n">prefetchbuf</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="nb">min</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span><span class="n">blknvir</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">q0</span><span class="p">,</span> <span class="n">q1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">blknvir</span><span class="p">):</span>
                <span class="n">readbuf</span><span class="p">,</span> <span class="n">prefetchbuf</span> <span class="o">=</span> <span class="n">prefetchbuf</span><span class="p">,</span> <span class="n">readbuf</span>
                <span class="n">prefetch_ovvv</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">q0</span><span class="p">,</span> <span class="n">q1</span><span class="p">,</span> <span class="n">prefetchbuf</span><span class="p">)</span>
                <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">q1</span><span class="o">-</span><span class="n">q0</span><span class="p">),</span><span class="n">nvir_pair</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">readbuf</span><span class="p">)</span>
                <span class="c1">#:eris_ovvv = _cp(eris.ovvv[p0:p1,q0:q1])</span>
                <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eris_ovvv</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">ovvvbuf</span><span class="p">)</span>
                <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="n">eris_ovvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">q1</span><span class="o">-</span><span class="n">q0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

                <span class="c1">#: tau = t2 + numpy.einsum(&#39;ia,jb-&gt;ijab&#39;, t1, t1)</span>
                <span class="c1">#: tmp = numpy.einsum(&#39;ijcd,kcdb-&gt;ijbk&#39;, tau, eris.ovvv)</span>
                <span class="c1">#: t2new += numpy.einsum(&#39;ka,ijbk-&gt;ijab&#39;, -t1, tmp)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mycc</span><span class="o">.</span><span class="n">direct</span><span class="p">:</span>
                    <span class="n">eris_vovv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eris_ovvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
                    <span class="n">eris_vovv</span> <span class="o">=</span> <span class="n">eris_vovv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                    <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                        <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">q1</span><span class="o">-</span><span class="n">q0</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
                        <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,jb-&gt;ijab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">],</span> <span class="n">t1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
                        <span class="n">tau</span> <span class="o">+=</span> <span class="n">t2</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">,:,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">]</span>
                        <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">eris_vovv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                 <span class="n">tmp</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="n">tmp1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
                    <span class="n">tmp1</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">),</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t2new</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
                    <span class="n">eris_vovv</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">tmp1</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="n">fvv</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kc,kcba-&gt;ab&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">],</span> <span class="n">eris_ovvv</span><span class="p">)</span>
                <span class="n">fvv</span><span class="p">[:,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kc,kbca-&gt;ab&#39;</span><span class="p">,</span> <span class="o">-</span><span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">eris_ovvv</span><span class="p">)</span>

                <span class="c1">#: wooVV -= numpy.einsum(&#39;jc,icba-&gt;ijba&#39;, t1, eris_ovvv)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">t1</span><span class="p">[:,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eris_ovvv</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">q1</span><span class="o">-</span><span class="n">q0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">wooVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

                <span class="c1">#: wOoVv += numpy.einsum(&#39;ibac,jc-&gt;jiba&#39;, eris_ovvv, t1)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">q1</span><span class="o">-</span><span class="n">q0</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">wOoVv</span><span class="p">[:,:,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span>

                <span class="c1">#: theta = t2.transpose(1,0,2,3) * 2 - t2</span>
                <span class="c1">#: t1new += numpy.einsum(&#39;ijcb,jcba-&gt;ia&#39;, theta, eris.ovvv)</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">tmp</span>
                <span class="n">theta</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,:,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">,:]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
                <span class="n">theta</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="n">theta</span> <span class="o">-=</span> <span class="n">t2</span><span class="p">[:,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">,</span><span class="n">q0</span><span class="p">:</span><span class="n">q1</span><span class="p">,:]</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">eris_ovvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t1new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">readbuf</span> <span class="o">=</span> <span class="n">prefetchbuf</span> <span class="o">=</span> <span class="n">ovvvbuf</span> <span class="o">=</span> <span class="n">eris_ovvv</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time2</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;ovvv [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">),</span> <span class="o">*</span><span class="n">time1</span><span class="p">)</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
        <span class="n">tmp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovoo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">t1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">wOoVv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">lib</span><span class="o">.</span><span class="n">call_in_background</span><span class="p">(</span><span class="n">load_eri</span><span class="p">)</span> <span class="k">as</span> <span class="n">prefetch</span><span class="p">:</span>
            <span class="n">prefetch</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">oovv</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
            <span class="n">tmp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eris_ooov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="c1">#: wooVV = numpy.einsum(&#39;ka,ijkb-&gt;ijba&#39;, t1, eris.ooov[p0:p1])</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">wooVV</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">t2new</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wOoVv</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>

        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">with</span> <span class="n">lib</span><span class="o">.</span><span class="n">call_in_background</span><span class="p">(</span><span class="n">load_eri</span><span class="p">)</span> <span class="k">as</span> <span class="n">prefetch</span><span class="p">:</span>
            <span class="n">prefetch</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
            <span class="n">t1new</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,ijba-&gt;ia&#39;</span><span class="p">,</span>  <span class="o">-</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">)</span>
            <span class="n">wooVV</span> <span class="o">-=</span> <span class="n">eris_oovv</span>

            <span class="c1">#tmp = numpy.einsum(&#39;ic,jkbc-&gt;jikb&#39;, t1, eris_oovv)</span>
            <span class="c1">#t2new[p0:p1] += numpy.einsum(&#39;ka,jikb-&gt;ijba&#39;, -t1, tmp)</span>
            <span class="n">tmp1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
            <span class="n">tmp2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_oovv</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_cp</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">tmp2</span><span class="p">)</span>
                <span class="n">t2new</span><span class="p">[:,</span><span class="n">p0</span><span class="o">+</span><span class="n">j</span><span class="p">]</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp2</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">eris_oovv</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">t2new</span><span class="p">[</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">eris_ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">t1new</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,iajb-&gt;ia&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>
        <span class="c1">#:tmp = numpy.einsum(&#39;ic,jbkc-&gt;jibk&#39;, t1, eris_ovov)</span>
        <span class="c1">#:t2new[p0:p1] += numpy.einsum(&#39;ka,jibk-&gt;jiba&#39;, -t1, tmp)</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp1</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">t1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t2new</span><span class="p">[</span><span class="n">p0</span><span class="o">+</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tmp1</span> <span class="o">=</span> <span class="n">tmp2</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">fov</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kc,iakc-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="n">fov</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;kc,icka-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">)</span>

    <span class="c1">#: fvv -= numpy.einsum(&#39;ijca,ibjc-&gt;ab&#39;, theta, eris.ovov)</span>
    <span class="c1">#: foo += numpy.einsum(&#39;iakb,jkba-&gt;ij&#39;, eris.ovov, theta)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,jb-&gt;jab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">tau</span> <span class="o">+=</span> <span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
            <span class="n">theta</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tau</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
            <span class="n">theta</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="n">theta</span> <span class="o">-=</span> <span class="n">tau</span>
            <span class="n">vov</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eris_ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">vov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">foo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">eris_ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">fvv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">=</span> <span class="n">vov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: theta = t2.transpose(0,2,1,3) * 2 - t2.transpose(0,3,2,1)</span>
    <span class="c1">#: t1new += numpy.einsum(&#39;jb,ijba-&gt;ia&#39;, fov, theta)</span>
    <span class="c1">#: t1new -= numpy.einsum(&#39;kijb,kjba-&gt;ia&#39;, eris_ooov, theta)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
            <span class="n">tmp</span><span class="o">-=</span> <span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">eris_ooov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                     <span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">t1new</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_cp</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">theta</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>  <span class="c1"># theta[i] = tmp.transpose(2,0,1)</span>
        <span class="n">t1new</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jb,jbia-&gt;ia&#39;</span><span class="p">,</span> <span class="n">fov</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">theta</span><span class="p">)</span>
        <span class="n">eris_ooov</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1">#: wOVov += eris.ovov</span>
    <span class="c1">#: tau = theta - numpy.einsum(&#39;ic,kb-&gt;ikcb&#39;, t1, t1*2)</span>
    <span class="c1">#: wOVov += .5 * numpy.einsum(&#39;jakc,ikcb-&gt;jiba&#39;, eris.ovov, tau)</span>
    <span class="c1">#: wOVov -= .5 * numpy.einsum(&#39;jcka,ikcb-&gt;jiba&#39;, eris.ovov, t2)</span>
    <span class="c1">#: t2new += numpy.einsum(&#39;ikca,kjbc-&gt;ijba&#39;, theta, wOVov)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">):</span>
            <span class="n">wOoVv</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">wooVV</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">*.</span><span class="mi">5</span>  <span class="c1">#: jiba + ijba*.5</span>
        <span class="n">wOVov</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">wOoVv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">buf5</span><span class="p">)</span>
        <span class="n">wOVov</span> <span class="o">=</span> <span class="n">wOVov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">eris_OVov</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eris_ovov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">buf3</span><span class="p">)</span>
        <span class="n">eris_OVov</span> <span class="o">=</span> <span class="n">eris_OVov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">wOVov</span> <span class="o">+=</span> <span class="n">eris_OVov</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">theta</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>  <span class="c1"># OVov-OVov.transpose(0,3,2,1)*.5</span>
            <span class="n">eris_OVov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">eris_OVov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">*.</span><span class="mi">5</span>
        <span class="k">for</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">):</span>
                <span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>  <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
                <span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">t2</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,jb-&gt;bja&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">t1</span><span class="p">)</span>
            <span class="c1">#: wOVov[j0:j1] += .5 * numpy.einsum(&#39;iakc,jbkc-&gt;jbai&#39;, eris_ovov, tau)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">),</span> <span class="n">eris_OVov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nov</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                     <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">wOVov</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

            <span class="c1">#theta = t2[p0:p1] * 2 - t2[p0:p1].transpose(0,1,3,2)</span>
            <span class="c1">#: t2new[j0:j1] += numpy.einsum(&#39;iack,jbck-&gt;jiba&#39;, theta, wOVov[j0:j1])</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">wOVov</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="n">theta</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">):</span>
                <span class="n">t2new</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">wOoVv</span> <span class="o">=</span> <span class="n">wOVov</span> <span class="o">=</span> <span class="n">eris_OVov</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time2</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;wOVov [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">),</span> <span class="o">*</span><span class="n">time2</span><span class="p">)</span>

    <span class="c1">#: tau = t2 + numpy.einsum(&#39;ia,jb-&gt;ijab&#39;, t1, t1)</span>
    <span class="c1">#: woooo += numpy.einsum(&#39;ijba,klab-&gt;ijkl&#39;, eris.oOVv, tau)</span>
    <span class="c1">#: tau = .5*t2 + numpy.einsum(&#39;ia,jb-&gt;ijab&#39;, t1, t1)</span>
    <span class="c1">#: woVoV += numpy.einsum(&#39;jkca,ikbc-&gt;ijba&#39;, tau, eris.oOVv)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span>
        <span class="n">tmp</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">wooVV</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">woVoV</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_cp</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">buf4</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">eris_oOvV</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf3</span><span class="p">)</span>
        <span class="n">eris_oOvV</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eris_ovov</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">eris_oVOv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">eris_oOvV</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">buf5</span><span class="p">)</span>
        <span class="n">eris_oVOv</span> <span class="o">=</span> <span class="n">eris_oVOv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">],</span> <span class="n">t1</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">],</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
            <span class="c1">#: woooo[p0:p1,:,j0:j1] += numpy.einsum(&#39;ijab,klab-&gt;ijkl&#39;, eris_oOvV, tau)</span>
            <span class="n">_dgemm</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span> <span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span>
                   <span class="n">eris_oOvV</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span>
                   <span class="n">woooo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j0</span><span class="o">*</span><span class="n">nocc</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">):</span>
                <span class="n">tau</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-=</span> <span class="n">t2</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
            <span class="c1">#: woVoV[j0:j1] += numpy.einsum(&#39;jkca,ickb-&gt;jiab&#39;, tau, eris_ovov)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">),</span>
                     <span class="n">eris_oVOv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
                    <span class="mi">1</span><span class="p">,</span> <span class="n">woVoV</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">time2</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;woVoV [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">),</span> <span class="o">*</span><span class="n">time2</span><span class="p">)</span>

        <span class="n">tau</span> <span class="o">=</span> <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
        <span class="c1">#: t2new += .5 * numpy.einsum(&#39;klij,klab-&gt;ijab&#39;, woooo[p0:p1], tau)</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">woooo</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span>
                 <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="n">t2new</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">eris_ovov</span> <span class="o">=</span> <span class="n">eris_oVOv</span> <span class="o">=</span> <span class="n">eris_oOvV</span> <span class="o">=</span> <span class="n">wooVV</span> <span class="o">=</span> <span class="n">tau</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">t2ibja</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">_cp</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">out</span><span class="o">=</span><span class="n">buf1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">blksize</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">buf2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="ow">in</span> <span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
            <span class="c1">#: t2new[j0:j1] += numpy.einsum(&#39;ibkc,kcja-&gt;ijab&#39;, woVoV[j0:j1], t2ibja)</span>
            <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">woVoV</span><span class="p">[</span><span class="n">j0</span><span class="p">:</span><span class="n">j1</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span>
                     <span class="n">t2ibja</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">[:</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nov</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">):</span>
                <span class="n">t2new</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">t2new</span><span class="p">[</span><span class="n">j0</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="o">.</span><span class="mi">5</span>
        <span class="n">woVoV</span> <span class="o">=</span> <span class="n">t2ibja</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">time1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;contract occ [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">),</span> <span class="o">*</span><span class="n">time1</span><span class="p">)</span>
    <span class="n">buf1</span> <span class="o">=</span> <span class="n">buf2</span> <span class="o">=</span> <span class="n">buf3</span> <span class="o">=</span> <span class="n">buf4</span> <span class="o">=</span> <span class="n">buf5</span> <span class="o">=</span> <span class="n">bufs</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">time1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;contract loop&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>

    <span class="n">woooo</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">ft_ij</span> <span class="o">=</span> <span class="n">foo</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ja,ia-&gt;ij&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">,</span> <span class="n">fov</span><span class="p">)</span>
    <span class="n">ft_ab</span> <span class="o">=</span> <span class="n">fvv</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ib-&gt;ab&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">t1</span><span class="p">,</span> <span class="n">fov</span><span class="p">)</span>
    <span class="c1">#: t2new += numpy.einsum(&#39;ijac,bc-&gt;ijab&#39;, t2, ft_ab)</span>
    <span class="c1">#: t2new -= numpy.einsum(&#39;ki,kjab-&gt;ijab&#39;, ft_ij, t2)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">t2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">ft_ab</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">t2new</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">ft_ij</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">t2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
             <span class="n">t2new</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">mo_e</span> <span class="o">=</span> <span class="n">fock</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
    <span class="n">eia</span> <span class="o">=</span> <span class="n">mo_e</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">mo_e</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
    <span class="n">t1new</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ib,ab-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">fvv</span><span class="p">)</span>
    <span class="n">t1new</span> <span class="o">-=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ja,ji-&gt;ia&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">foo</span><span class="p">)</span>
    <span class="n">t1new</span> <span class="o">/=</span> <span class="n">eia</span>

    <span class="c1">#: t2new = t2new + t2new.transpose(1,0,3,2)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t2new</span><span class="p">[:</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;a,jb-&gt;jab&#39;</span><span class="p">,</span> <span class="n">eia</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">eia</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="n">t2new</span><span class="p">[:</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
        <span class="n">t2new</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">/=</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;a,b-&gt;ab&#39;</span><span class="p">,</span> <span class="n">eia</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">eia</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

    <span class="n">time0</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;update t1 t2&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t1new</span><span class="p">,</span> <span class="n">t2new</span>


<span class="k">def</span> <span class="nf">add_wvvVV_</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t2new_tril</span><span class="p">,</span> <span class="n">with_ovvv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>

    <span class="c1">#: tau = t2 + numpy.einsum(&#39;ia,jb-&gt;ijab&#39;, t1, t1)</span>
    <span class="c1">#: t2new += numpy.einsum(&#39;ijcd,acdb-&gt;ijab&#39;, tau, vvvv)</span>
    <span class="k">def</span> <span class="nf">contract_rec_</span><span class="p">(</span><span class="n">t2new_tril</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eri</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">):</span>
        <span class="n">nao</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">ic</span> <span class="o">=</span> <span class="n">i1</span> <span class="o">-</span> <span class="n">i0</span>
        <span class="n">jc</span> <span class="o">=</span> <span class="n">j1</span> <span class="o">-</span> <span class="n">j0</span>
        <span class="c1">#: t2tril[:,j0:j1] += numpy.einsum(&#39;xcd,cdab-&gt;xab&#39;, tau[:,i0:i1], eri)</span>
        <span class="n">_dgemm</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">jc</span><span class="o">*</span><span class="n">nao</span><span class="p">,</span> <span class="n">ic</span><span class="o">*</span><span class="n">nao</span><span class="p">,</span>
               <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="n">eri</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jc</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span>
               <span class="n">t2new_tril</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">i0</span><span class="o">*</span><span class="n">nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">j0</span><span class="o">*</span><span class="n">nao</span><span class="p">)</span>

        <span class="c1">#: t2tril[:,i0:i1] += numpy.einsum(&#39;xcd,abcd-&gt;xab&#39;, tau[:,j0:j1], eri)</span>
        <span class="n">_dgemm</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">ic</span><span class="o">*</span><span class="n">nao</span><span class="p">,</span> <span class="n">jc</span><span class="o">*</span><span class="n">nao</span><span class="p">,</span>
               <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="n">eri</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">jc</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span>
               <span class="n">t2new_tril</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nao</span><span class="o">*</span><span class="n">nao</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">j0</span><span class="o">*</span><span class="n">nao</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i0</span><span class="o">*</span><span class="n">nao</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">contract_tril_</span><span class="p">(</span><span class="n">t2new_tril</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">eri</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="c1">#: t2new[i,:i+1, a] += numpy.einsum(&#39;xcd,cdb-&gt;xb&#39;, tau[:,a0:a+1], eri)</span>
        <span class="n">_dgemm</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">a0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span>
               <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">eri</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span>
               <span class="n">t2new_tril</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a0</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>

        <span class="c1">#: t2new[i,:i+1,a0:a] += numpy.einsum(&#39;xd,abd-&gt;xab&#39;, tau[:,a], eri[:a])</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">&gt;</span> <span class="n">a0</span><span class="p">:</span>
            <span class="n">_dgemm</span><span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">a0</span><span class="p">)</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span>
                   <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="n">eri</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span>
                   <span class="n">t2new_tril</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">a</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a0</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">direct</span><span class="p">:</span>   <span class="c1"># AO-direct CCSD</span>
        <span class="n">mol</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mol</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">eris</span><span class="p">,</span> <span class="s1">&#39;mo_coeff&#39;</span><span class="p">):</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">mo_coeff</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mo</span> <span class="o">=</span> <span class="n">_mo_without_core</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="n">nao</span><span class="p">,</span> <span class="n">nmo</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nao_pair</span> <span class="o">=</span> <span class="n">nao</span> <span class="o">*</span> <span class="p">(</span><span class="n">nao</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
        <span class="n">aos</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mo</span><span class="p">[:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
        <span class="n">nocc2</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="n">outbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">outbuf</span><span class="p">)</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
            <span class="n">tau</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,jb-&gt;jab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tau</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">_ao2mo</span><span class="o">.</span><span class="n">nr_e2</span><span class="p">(</span><span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="n">aos</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;s1&#39;</span><span class="p">)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">tau</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">)</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="s1">&#39;vvvv-tau&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>

        <span class="n">intor</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">_add_suffix</span><span class="p">(</span><span class="s1">&#39;int2e&#39;</span><span class="p">)</span>
        <span class="n">ao2mopt</span> <span class="o">=</span> <span class="n">_ao2mo</span><span class="o">.</span><span class="n">AO2MOpt</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">intor</span><span class="p">,</span> <span class="s1">&#39;CVHFnr_schwarz_cond&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;CVHFsetnr_direct_scf&#39;</span><span class="p">)</span>
        <span class="n">outbuf</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">ao_loc</span> <span class="o">=</span> <span class="n">mol</span><span class="o">.</span><span class="n">ao_loc_nr</span><span class="p">()</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">max_memory</span><span class="o">*.</span><span class="mi">95</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="n">nao</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">sh_ranges</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">outcore</span><span class="o">.</span><span class="n">balance_partition</span><span class="p">(</span><span class="n">ao_loc</span><span class="p">,</span> <span class="n">dmax</span><span class="p">)</span>
        <span class="n">dmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">sh_ranges</span><span class="p">)</span>
        <span class="n">eribuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">dmax</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
        <span class="n">loadbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">dmax</span><span class="p">,</span><span class="n">dmax</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">nao</span><span class="p">))</span>
        <span class="n">fint</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">moleintor</span><span class="o">.</span><span class="n">getints4c</span>

        <span class="k">for</span> <span class="n">ip</span><span class="p">,</span> <span class="p">(</span><span class="n">ish0</span><span class="p">,</span> <span class="n">ish1</span><span class="p">,</span> <span class="n">ni</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sh_ranges</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">jsh0</span><span class="p">,</span> <span class="n">jsh1</span><span class="p">,</span> <span class="n">nj</span> <span class="ow">in</span> <span class="n">sh_ranges</span><span class="p">[:</span><span class="n">ip</span><span class="p">]:</span>
                <span class="n">eri</span> <span class="o">=</span> <span class="n">fint</span><span class="p">(</span><span class="n">intor</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">_atm</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">_bas</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span>
                           <span class="n">shls_slice</span><span class="o">=</span><span class="p">(</span><span class="n">ish0</span><span class="p">,</span><span class="n">ish1</span><span class="p">,</span><span class="n">jsh0</span><span class="p">,</span><span class="n">jsh1</span><span class="p">),</span> <span class="n">aosym</span><span class="o">=</span><span class="s1">&#39;s2kl&#39;</span><span class="p">,</span>
                           <span class="n">ao_loc</span><span class="o">=</span><span class="n">ao_loc</span><span class="p">,</span> <span class="n">cintopt</span><span class="o">=</span><span class="n">ao2mopt</span><span class="o">.</span><span class="n">_cintopt</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">eribuf</span><span class="p">)</span>
                <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">ao_loc</span><span class="p">[</span><span class="n">ish0</span><span class="p">],</span> <span class="n">ao_loc</span><span class="p">[</span><span class="n">ish1</span><span class="p">]</span>
                <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="o">=</span> <span class="n">ao_loc</span><span class="p">[</span><span class="n">jsh0</span><span class="p">],</span> <span class="n">ao_loc</span><span class="p">[</span><span class="n">jsh1</span><span class="p">]</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">i1</span><span class="o">-</span><span class="n">i0</span><span class="p">,</span><span class="n">nao</span><span class="p">,</span><span class="n">j1</span><span class="o">-</span><span class="n">j0</span><span class="p">,</span><span class="n">nao</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">loadbuf</span><span class="p">)</span>
                <span class="n">_ccsd</span><span class="o">.</span><span class="n">libcc</span><span class="o">.</span><span class="n">CCload_eri</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">),</span>
                                       <span class="n">eri</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">),</span>
                                       <span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="o">*</span><span class="mi">4</span><span class="p">)(</span><span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">),</span>
                                       <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">nao</span><span class="p">))</span>
                <span class="n">contract_rec_</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span><span class="p">,</span> <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span><span class="p">)</span>
                <span class="n">time0</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="s1">&#39;AO-vvvv [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span>
                                            <span class="p">(</span><span class="n">ish0</span><span class="p">,</span><span class="n">ish1</span><span class="p">,</span><span class="n">jsh0</span><span class="p">,</span><span class="n">jsh1</span><span class="p">),</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
            <span class="n">eri</span> <span class="o">=</span> <span class="n">fint</span><span class="p">(</span><span class="n">intor</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">_atm</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">_bas</span><span class="p">,</span> <span class="n">mol</span><span class="o">.</span><span class="n">_env</span><span class="p">,</span>
                       <span class="n">shls_slice</span><span class="o">=</span><span class="p">(</span><span class="n">ish0</span><span class="p">,</span><span class="n">ish1</span><span class="p">,</span><span class="n">ish0</span><span class="p">,</span><span class="n">ish1</span><span class="p">),</span> <span class="n">aosym</span><span class="o">=</span><span class="s1">&#39;s4&#39;</span><span class="p">,</span>
                       <span class="n">ao_loc</span><span class="o">=</span><span class="n">ao_loc</span><span class="p">,</span> <span class="n">cintopt</span><span class="o">=</span><span class="n">ao2mopt</span><span class="o">.</span><span class="n">_cintopt</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">eribuf</span><span class="p">)</span>
            <span class="n">i0</span><span class="p">,</span> <span class="n">i1</span> <span class="o">=</span> <span class="n">ao_loc</span><span class="p">[</span><span class="n">ish0</span><span class="p">],</span> <span class="n">ao_loc</span><span class="p">[</span><span class="n">ish1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i1</span><span class="o">-</span><span class="n">i0</span><span class="p">):</span>
                <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="o">=</span> <span class="n">i</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eri</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">loadbuf</span><span class="p">)</span>
                <span class="n">contract_tril_</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">i0</span><span class="p">,</span> <span class="n">i0</span><span class="o">+</span><span class="n">i</span><span class="p">)</span>
            <span class="n">time0</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="s1">&#39;AO-vvvv [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">,</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span> <span class="o">%</span>
                                        <span class="p">(</span><span class="n">ish0</span><span class="p">,</span><span class="n">ish1</span><span class="p">,</span><span class="n">ish0</span><span class="p">,</span><span class="n">ish1</span><span class="p">),</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
        <span class="n">eribuf</span> <span class="o">=</span> <span class="n">loadbuf</span> <span class="o">=</span> <span class="n">eri</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">tmp</span> <span class="o">=</span> <span class="n">_ao2mo</span><span class="o">.</span><span class="n">nr_e2</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nmo</span><span class="p">),</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">t2new_tril</span> <span class="o">+=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">with_ovvv</span><span class="p">:</span>
            <span class="c1">#: tmp = numpy.einsum(&#39;ijcd,ka,kdcb-&gt;ijba&#39;, tau, t1, eris.ovvv)</span>
            <span class="c1">#: t2new -= tmp + tmp.transpose(1,0,3,2)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">_ao2mo</span><span class="o">.</span><span class="n">nr_e2</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
            <span class="n">t2new_tril</span> <span class="o">-=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">_ao2mo</span><span class="o">.</span><span class="n">nr_e2</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nmo</span><span class="p">),</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="s1">&#39;s1&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
            <span class="c1">#: t2new_tril -= numpy.einsum(&#39;xkb,ka-&gt;xab&#39;, tmp.reshape(-1,nocc,nvir), t1)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">outbuf</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">((</span><span class="n">nocc2</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">buffer</span><span class="o">=</span><span class="n">tau</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">out</span><span class="o">=</span><span class="n">outbuf</span><span class="p">)</span>
            <span class="n">t2new_tril</span> <span class="o">-=</span> <span class="n">tmp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1">#: tau = t2 + numpy.einsum(&#39;ia,jb-&gt;ijab&#39;, t1, t1)</span>
        <span class="c1">#: t2new += numpy.einsum(&#39;ijcd,acdb-&gt;ijab&#39;, tau, vvvv)</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="n">p0</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
            <span class="n">tau</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;a,jb-&gt;jab&#39;</span><span class="p">,</span> <span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">t1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">tau</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p0</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="s1">&#39;vvvv-tau&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
        <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">mycc</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">-</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">blksize</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">*.</span><span class="mi">95</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span><span class="p">)))</span>

        <span class="k">def</span> <span class="nf">block_contract</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
                <span class="n">contract_tril_</span><span class="p">(</span><span class="n">t2new_tril</span><span class="p">,</span> <span class="n">tau</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">a0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">lib</span><span class="o">.</span><span class="n">call_in_background</span><span class="p">(</span><span class="n">block_contract</span><span class="p">)</span> <span class="k">as</span> <span class="n">bcontract</span><span class="p">:</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">outbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">blksize</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
            <span class="n">outbuf1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">outbuf</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">):</span>
                    <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eris</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p0</span><span class="o">+</span><span class="n">a</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">outbuf</span><span class="p">[</span><span class="n">a</span><span class="o">-</span><span class="n">a0</span><span class="p">])</span>
                    <span class="n">p0</span> <span class="o">+=</span> <span class="n">a</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">bcontract</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">a0</span><span class="p">,</span> <span class="n">a1</span><span class="p">)</span>
                <span class="n">outbuf</span><span class="p">,</span> <span class="n">outbuf1</span> <span class="o">=</span> <span class="n">outbuf1</span><span class="p">,</span> <span class="n">outbuf</span>
                <span class="n">time0</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="s1">&#39;vvvv [</span><span class="si">%d</span><span class="s1">:</span><span class="si">%d</span><span class="s1">]&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span><span class="n">a1</span><span class="p">),</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t2new_tril</span>


<span class="k">def</span> <span class="nf">get_nocc</span><span class="p">(</span><span class="n">mycc</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nocc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nocc</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
        <span class="k">assert</span><span class="p">(</span><span class="n">nocc</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">nocc</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">occ_idx</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">occ_idx</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">count_nonzero</span><span class="p">(</span><span class="n">occ_idx</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_nmo</span><span class="p">(</span><span class="n">mycc</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nmo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_nmo</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span> <span class="o">-</span> <span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">mycc</span><span class="o">.</span><span class="n">frozen</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">amplitudes_to_vector</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
    <span class="n">size</span> <span class="o">=</span> <span class="n">nov</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">vector</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ndarray</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">t1</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span> <span class="n">buffer</span><span class="o">=</span><span class="n">out</span><span class="p">)</span>
    <span class="n">vector</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">vector</span><span class="p">[</span><span class="n">nov</span><span class="p">:]</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">)]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">vector</span>

<span class="k">def</span> <span class="nf">vector_to_amplitudes</span><span class="p">(</span><span class="n">vector</span><span class="p">,</span> <span class="n">nmo</span><span class="p">,</span> <span class="n">nocc</span><span class="p">):</span>
    <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
    <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">*</span> <span class="n">nvir</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="n">vector</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">t2tril</span> <span class="o">=</span> <span class="n">vector</span><span class="p">[</span><span class="n">nov</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">tril_indices</span><span class="p">(</span><span class="n">nocc</span><span class="p">)</span>
    <span class="n">t2</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">t2tril</span>
    <span class="n">t2</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">t2tril</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>


<div class="viewcode-block" id="energy"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.ccsd.energy">[docs]</a><span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;CCSD correlation energy&#39;&#39;&#39;</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
    <span class="n">fock</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span>
    <span class="n">e</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ia,ia&#39;</span><span class="p">,</span> <span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:],</span> <span class="n">t1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">p0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
        <span class="n">p1</span> <span class="o">=</span> <span class="n">p0</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t1</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">],</span> <span class="n">t1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">tau</span><span class="o">*</span><span class="mi">2</span> <span class="o">-</span> <span class="n">tau</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">+=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijab,ijab&#39;</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span>
                          <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">e</span></div>


<div class="viewcode-block" id="as_scanner"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.ccsd.as_scanner">[docs]</a><span class="k">def</span> <span class="nf">as_scanner</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Generating a scanner/solver for CCSD PES.</span>

<span class="sd">    The returned solver is a function. This function requires one argument</span>
<span class="sd">    &quot;mol&quot; as input and returns total CCSD energy.</span>

<span class="sd">    The solver will automatically use the results of last calculation as the</span>
<span class="sd">    initial guess of the new calculation.  All parameters assigned in the</span>
<span class="sd">    CCSD and the underlying SCF objects (conv_tol, max_memory etc) are</span>
<span class="sd">    automatically applied in the solver.</span>

<span class="sd">    Note scanner has side effects.  It may change many underlying objects</span>
<span class="sd">    (_scf, with_df, with_x2c, ...) during calculation.</span>

<span class="sd">    Examples::</span>

<span class="sd">        &gt;&gt;&gt; from pyscf import gto, scf, cc</span>
<span class="sd">        &gt;&gt;&gt; mol = gto.M(atom=&#39;H 0 0 0; F 0 0 1&#39;)</span>
<span class="sd">        &gt;&gt;&gt; cc_scanner = cc.CCSD(scf.RHF(mol)).as_scanner()</span>
<span class="sd">        &gt;&gt;&gt; e_tot, grad = cc_scanner(gto.M(atom=&#39;H 0 0 0; F 0 0 1.1&#39;))</span>
<span class="sd">        &gt;&gt;&gt; e_tot, grad = cc_scanner(gto.M(atom=&#39;H 0 0 0; F 0 0 1.5&#39;))</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="s1">&#39;Set </span><span class="si">%s</span><span class="s1"> as a scanner&#39;</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
    <span class="k">class</span> <span class="nc">CCSD_Scanner</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">lib</span><span class="o">.</span><span class="n">SinglePointScanner</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">as_scanner</span><span class="p">()</span>
        <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol</span><span class="p">):</span>
            <span class="n">mf_scanner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span>
            <span class="n">mf_scanner</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mol</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mf_scanner</span><span class="o">.</span><span class="n">mo_coeff</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">=</span> <span class="n">mf_scanner</span><span class="o">.</span><span class="n">mo_occ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_tot</span>
    <span class="k">return</span> <span class="n">CCSD_Scanner</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span></div>


<div class="viewcode-block" id="CCSD"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.ccsd.CCSD">[docs]</a><span class="k">class</span> <span class="nc">CCSD</span><span class="p">(</span><span class="n">lib</span><span class="o">.</span><span class="n">StreamObject</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;restricted CCSD</span>

<span class="sd">    Attributes:</span>
<span class="sd">        verbose : int</span>
<span class="sd">            Print level.  Default value equals to :class:`Mole.verbose`</span>
<span class="sd">        max_memory : float or int</span>
<span class="sd">            Allowed memory in MB.  Default value equals to :class:`Mole.max_memory`</span>
<span class="sd">        conv_tol : float</span>
<span class="sd">            converge threshold.  Default is 1e-7.</span>
<span class="sd">        conv_tol_normt : float</span>
<span class="sd">            converge threshold for norm(t1,t2).  Default is 1e-5.</span>
<span class="sd">        max_cycle : int</span>
<span class="sd">            max number of iterations.  Default is 50.</span>
<span class="sd">        diis_space : int</span>
<span class="sd">            DIIS space size.  Default is 6.</span>
<span class="sd">        diis_start_cycle : int</span>
<span class="sd">            The step to start DIIS.  Default is 0.</span>
<span class="sd">        direct : bool</span>
<span class="sd">            AO-direct CCSD. Default is False.</span>
<span class="sd">        frozen : int or list</span>
<span class="sd">            If integer is given, the inner-most orbitals are frozen from CC</span>
<span class="sd">            amplitudes.  Given the orbital indices (0-based) in a list, both</span>
<span class="sd">            occupied and virtual orbitals can be frozen in CC calculation.</span>

<span class="sd">            &gt;&gt;&gt; mol = gto.M(atom = &#39;H 0 0 0; F 0 0 1.1&#39;, basis = &#39;ccpvdz&#39;)</span>
<span class="sd">            &gt;&gt;&gt; mf = scf.RHF(mol).run()</span>
<span class="sd">            &gt;&gt;&gt; # freeze 2 core orbitals</span>
<span class="sd">            &gt;&gt;&gt; mycc = cc.CCSD(mf).set(frozen = 2).run()</span>
<span class="sd">            &gt;&gt;&gt; # freeze 2 core orbitals and 3 high lying unoccupied orbitals</span>
<span class="sd">            &gt;&gt;&gt; mycc.set(frozen = [0,1,16,17,18]).run()</span>

<span class="sd">    Saved results</span>

<span class="sd">        converged : bool</span>
<span class="sd">            CCSD converged or not</span>
<span class="sd">        e_corr : float</span>
<span class="sd">            CCSD correlation correction</span>
<span class="sd">        e_tot : float</span>
<span class="sd">            Total CCSD energy (HF + correlation)</span>
<span class="sd">        t1, t2 : </span>
<span class="sd">            T amplitudes t1[i,a], t2[i,j,a,b]  (i,j in occ, a,b in virt)</span>
<span class="sd">        l1, l2 : </span>
<span class="sd">            Lambda amplitudes l1[i,a], l2[i,j,a,b]  (i,j in occ, a,b in virt)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mf</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mo_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">gto</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mf</span><span class="p">,</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">You see this error message because of the API updates in pyscf v0.10.</span>
<span class="s1">In the new API, the first argument of CC class is HF objects.  Please see</span>
<span class="s1">http://sunqm.net/pyscf/code-rule.html#api-rules for the details of API conventions&#39;&#39;&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mo_coeff</span>  <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mo_coeff</span>  <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span>
        <span class="k">if</span> <span class="n">mo_occ</span>    <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">mo_occ</span>    <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">mo_occ</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mol</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">mol</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span> <span class="o">=</span> <span class="n">mf</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">max_memory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diis_space</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diis_file</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diis_start_cycle</span> <span class="o">=</span> <span class="mi">0</span>
<span class="c1"># FIXME: Should we avoid DIIS starting early?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diis_start_energy_diff</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">direct</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">frozen</span> <span class="o">=</span> <span class="n">frozen</span>

<span class="c1">##################################################</span>
<span class="c1"># don&#39;t modify the following attributes, they are not input options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">=</span> <span class="n">mo_occ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged_lambda</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nocc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nmo</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chkfile</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ecc</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">e_tot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">e_tot</span>

    <span class="n">nocc</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_nocc</span><span class="p">)</span>
    <span class="nd">@nocc</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nocc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nocc</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">nmo</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">get_nmo</span><span class="p">)</span>
    <span class="nd">@nmo</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">nmo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nmo</span> <span class="o">=</span> <span class="n">n</span>

    <span class="n">get_nocc</span> <span class="o">=</span> <span class="n">get_nocc</span>
    <span class="n">get_nmo</span> <span class="o">=</span> <span class="n">get_nmo</span>

    <span class="k">def</span> <span class="nf">dump_flags</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;******** </span><span class="si">%s</span><span class="s1"> flags ********&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;CCSD nocc = </span><span class="si">%d</span><span class="s1">, nvir = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;frozen orbitals </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frozen</span><span class="p">))</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_cycle = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;direct = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;conv_tol = </span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;conv_tol_normt = </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;diis_space = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diis_space</span><span class="p">)</span>
        <span class="c1">#log.info(&#39;diis_file = %s&#39;, self.diis_file)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;diis_start_cycle = </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diis_start_cycle</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;diis_start_energy_diff = </span><span class="si">%g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">diis_start_energy_diff</span><span class="p">)</span>
        <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;max_memory </span><span class="si">%d</span><span class="s1"> MB (current use </span><span class="si">%d</span><span class="s1"> MB)&#39;</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">max_memory</span><span class="p">,</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">get_init_guess</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">init_amps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">):</span>
        <span class="n">time0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="n">mo_e</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="o">.</span><span class="n">diagonal</span><span class="p">()</span>
        <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">mo_e</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">eia</span> <span class="o">=</span> <span class="n">mo_e</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">mo_e</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="n">t1</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">fock</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span> <span class="o">/</span> <span class="n">eia</span>
        <span class="n">t2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
            <span class="n">gi</span> <span class="o">=</span> <span class="n">eris</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">t2i</span> <span class="o">=</span> <span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">gi</span><span class="o">/</span><span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;jb,a-&gt;jba&#39;</span><span class="p">,</span> <span class="n">eia</span><span class="p">,</span> <span class="n">eia</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">+=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jab,jab&#39;</span><span class="p">,</span> <span class="n">t2i</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">gi</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ab,ab&#39;</span>  <span class="p">,</span> <span class="n">t2i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">gi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">-=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;jab,jba&#39;</span><span class="p">,</span> <span class="n">t2i</span><span class="p">[:</span><span class="n">i</span><span class="p">],</span> <span class="n">gi</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span> <span class="o">-=</span>     <span class="n">numpy</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ab,ba&#39;</span>  <span class="p">,</span> <span class="n">t2i</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">,</span> <span class="n">gi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Init t2, MP2 energy = </span><span class="si">%.15g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;init mp2&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">time0</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">emp2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

    <span class="n">energy</span> <span class="o">=</span> <span class="n">energy</span>


    <span class="k">def</span> <span class="nf">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ccsd</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">ccsd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;=</span> <span class="n">logger</span><span class="o">.</span><span class="n">WARN</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">check_sanity</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dump_flags</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> \
                <span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                       <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol</span><span class="p">,</span> <span class="n">tolnormt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span><span class="p">,</span>
                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">converged</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;CCSD converged&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;CCSD not converged&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">e_tot</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;E_corr = </span><span class="si">%.16g</span><span class="s1">&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">note</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;E(CCSD) = </span><span class="si">%.16g</span><span class="s1">  E_corr = </span><span class="si">%.16g</span><span class="s1">&#39;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">e_tot</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>

    <span class="n">as_scanner</span> <span class="o">=</span> <span class="n">as_scanner</span>


    <span class="k">def</span> <span class="nf">solve_lambda</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">ccsd_lambda</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">converged_lambda</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span> <span class="o">=</span> \
                <span class="n">ccsd_lambda</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">,</span>
                                   <span class="n">max_cycle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cycle</span><span class="p">,</span>
                                   <span class="n">tol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">conv_tol_normt</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>

    <span class="k">def</span> <span class="nf">ccsd_t</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">eris</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">ccsd_t</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">eris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">eris</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ccsd_t</span><span class="o">.</span><span class="n">kernel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

<div class="viewcode-block" id="CCSD.make_rdm1"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.ccsd.CCSD.make_rdm1">[docs]</a>    <span class="k">def</span> <span class="nf">make_rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Un-relaxed 1-particle density matrix in MO space&#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">ccsd_rdm</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span>
        <span class="k">if</span> <span class="n">l2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lambda</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span></div>

<div class="viewcode-block" id="CCSD.make_rdm2"><a class="viewcode-back" href="../../../cc.html#pyscf.cc.ccsd.CCSD.make_rdm2">[docs]</a>    <span class="k">def</span> <span class="nf">make_rdm2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l1</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">l2</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;2-particle density matrix in MO space.  The density matrix is</span>
<span class="sd">        stored as</span>

<span class="sd">        dm2[p,r,q,s] = &lt;p^+ q^+ s r&gt;</span>
<span class="sd">        &#39;&#39;&#39;</span>
        <span class="kn">from</span> <span class="nn">pyscf.cc</span> <span class="k">import</span> <span class="n">ccsd_rdm</span>
        <span class="k">if</span> <span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t1</span>
        <span class="k">if</span> <span class="n">t2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1</span>
        <span class="k">if</span> <span class="n">l2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2</span>
        <span class="k">if</span> <span class="n">l1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_lambda</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ccsd_rdm</span><span class="o">.</span><span class="n">make_rdm2</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">l1</span><span class="p">,</span> <span class="n">l2</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">ao2mo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Pseudo code how _ERIS are implemented:</span>
        <span class="c1"># nocc = self.nocc</span>
        <span class="c1"># nmo = self.nmo</span>
        <span class="c1"># nvir = nmo - nocc</span>
        <span class="c1"># eri1 = ao2mo.incore.full(self._scf._eri, mo_coeff)</span>
        <span class="c1"># eri1 = ao2mo.restore(1, eri1, nmo)</span>
        <span class="c1"># eris = lambda:None</span>
        <span class="c1"># eris.oooo = eri1[:nocc,:nocc,:nocc,:nocc].copy()</span>
        <span class="c1"># eris.ooov = eri1[:nocc,:nocc,:nocc,nocc:].copy()</span>
        <span class="c1"># eris.ovoo = eri1[:nocc,nocc:,:nocc,:nocc].copy()</span>
        <span class="c1"># eris.oovv = eri1[:nocc,:nocc,nocc:,nocc:].copy()</span>
        <span class="c1"># eris.ovov = eri1[:nocc,nocc:,:nocc,nocc:].copy()</span>
        <span class="c1"># ovvv = eri1[:nocc,nocc:,nocc:,nocc:].copy()</span>
        <span class="c1"># eris.ovvv = numpy.empty((nocc,nvir,nvir*(nvir+1)//2))</span>
        <span class="c1"># for i in range(nocc):</span>
        <span class="c1">#     for j in range(nvir):</span>
        <span class="c1">#         eris.ovvv[i,j] = lib.pack_tril(ovvv[i,j])</span>
        <span class="c1"># eris.vvvv = ao2mo.restore(4, eri1[nocc:,nocc:,nocc:,nocc:].copy(), nvir)</span>
        <span class="c1"># eris.fock = numpy.diag(self._scf.mo_energy)</span>
        <span class="c1"># return eris</span>
        <span class="k">return</span> <span class="n">_ERIS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>

    <span class="n">add_wvvVV_</span> <span class="o">=</span> <span class="n">add_wvvVV_</span>

    <span class="k">def</span> <span class="nf">add_wvvVV</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">with_ovvv</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">t2new_tril</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_wvvVV_</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">,</span> <span class="n">t2new_tril</span><span class="p">,</span> <span class="n">with_ovvv</span><span class="p">)</span>

    <span class="n">update_amps</span> <span class="o">=</span> <span class="n">update_amps</span>

    <span class="k">def</span> <span class="nf">diis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">adiis</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">diis_</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">adiis</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">diis_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">adiis</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diis_start_cycle</span> <span class="ow">and</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">diis_start_energy_diff</span><span class="p">):</span>
            <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>
            <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">adiis</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">vec</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;DIIS for step </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">istep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>

    <span class="k">def</span> <span class="nf">amplitudes_to_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">vector_to_amplitudes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">,</span> <span class="n">nmo</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nocc</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">nocc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nocc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nocc</span>
        <span class="k">if</span> <span class="n">nmo</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">nmo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nmo</span>
        <span class="k">return</span> <span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">vec</span><span class="p">,</span> <span class="n">nmo</span><span class="p">,</span> <span class="n">nocc</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dump_chk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ci</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frozen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">mo_occ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">ci</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ci</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ci</span>
        <span class="k">if</span> <span class="n">frozen</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">frozen</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frozen</span>
        <span class="n">ci_chk</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;e_corr&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">e_corr</span><span class="p">,</span>
                  <span class="s1">&#39;ci&#39;</span><span class="p">:</span> <span class="n">ci</span><span class="p">,</span>
                  <span class="s1">&#39;frozen&#39;</span><span class="p">:</span> <span class="n">frozen</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ci_chk</span><span class="p">[</span><span class="s1">&#39;mo_coeff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo_coeff</span>
        <span class="k">if</span> <span class="n">mo_occ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ci_chk</span><span class="p">[</span><span class="s1">&#39;mo_occ&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mo_occ</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nmo</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ci_chk</span><span class="p">[</span><span class="s1">&#39;_nmo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nmo</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nocc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="n">ci_chk</span><span class="p">[</span><span class="s1">&#39;_nocc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nocc</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">chkfile</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">chkfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chkfile</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chkfile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">chkfile</span>
        <span class="n">lib</span><span class="o">.</span><span class="n">chkfile</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">chkfile</span><span class="p">,</span> <span class="s1">&#39;cisd&#39;</span><span class="p">,</span> <span class="n">ci_chk</span><span class="p">)</span></div>

<span class="n">CC</span> <span class="o">=</span> <span class="n">CCSD</span>

<span class="k">class</span> <span class="nc">_ERIS</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;incore&#39;</span><span class="p">):</span>
        <span class="n">cput0</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">mo_coeff</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">_mo_without_core</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">_mo_without_core</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>
<span class="c1"># Note: Always recompute the fock matrix because cc._scf.mo_energy may not be</span>
<span class="c1"># the eigenvalue of Fock matrix (eg when level shift is used in the scf object</span>
<span class="c1"># and the scf does not converge, mo_energy has the contribution of level shift).</span>
        <span class="n">dm</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">)</span>
        <span class="n">fockao</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">get_hcore</span><span class="p">()</span> <span class="o">+</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">dm</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fock</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">mo_coeff</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">fockao</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">))</span>

        <span class="n">nocc</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nocc</span>
        <span class="n">nmo</span> <span class="o">=</span> <span class="n">cc</span><span class="o">.</span><span class="n">nmo</span>
        <span class="n">nvir</span> <span class="o">=</span> <span class="n">nmo</span> <span class="o">-</span> <span class="n">nocc</span>
        <span class="n">mem_incore</span><span class="p">,</span> <span class="n">mem_outcore</span><span class="p">,</span> <span class="n">mem_basic</span> <span class="o">=</span> <span class="n">_mem_usage</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span>
        <span class="n">mem_now</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">log</span> <span class="o">=</span> <span class="n">logger</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;incore&#39;</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>
            <span class="p">(</span><span class="n">mem_incore</span><span class="o">+</span><span class="n">mem_now</span> <span class="o">&lt;</span> <span class="n">cc</span><span class="o">.</span><span class="n">max_memory</span><span class="p">)</span> <span class="ow">or</span> <span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="o">.</span><span class="n">incore_anyway</span><span class="p">):</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Build MO integrals with incore ao2mo&#39;</span><span class="p">)</span>
            <span class="n">eri1</span> <span class="o">=</span> <span class="n">ao2mo</span><span class="o">.</span><span class="n">incore</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">_eri</span><span class="p">,</span> <span class="n">mo_coeff</span><span class="p">)</span>
            <span class="c1">#:eri1 = ao2mo.restore(1, eri1, nmo)</span>
            <span class="c1">#:self.oooo = eri1[:nocc,:nocc,:nocc,:nocc].copy()</span>
            <span class="c1">#:self.ooov = eri1[:nocc,:nocc,:nocc,nocc:].copy()</span>
            <span class="c1">#:self.ovoo = eri1[:nocc,nocc:,:nocc,:nocc].copy()</span>
            <span class="c1">#:self.oovv = eri1[:nocc,:nocc,nocc:,nocc:].copy()</span>
            <span class="c1">#:self.ovov = eri1[:nocc,nocc:,:nocc,nocc:].copy()</span>
            <span class="c1">#:ovvv = eri1[:nocc,nocc:,nocc:,nocc:].copy()</span>
            <span class="c1">#:self.ovvv = numpy.empty((nocc,nvir,nvir*(nvir+1)//2))</span>
            <span class="c1">#:for i in range(nocc):</span>
            <span class="c1">#:    for j in range(nvir):</span>
            <span class="c1">#:        self.ovvv[i,j] = lib.pack_tril(ovvv[i,j])</span>
            <span class="c1">#:self.vvvv = ao2mo.restore(4, eri1[nocc:,nocc:,nocc:,nocc:], nvir)</span>
            <span class="n">nvir_pair</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nvir_pair</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">))</span>
            <span class="n">ij</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">outbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eri1</span><span class="p">[</span><span class="n">ij</span><span class="p">:</span><span class="n">ij</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">outbuf</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span>
                <span class="n">ij</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">ij1</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nmo</span><span class="p">):</span>
                <span class="n">buf</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">eri1</span><span class="p">[</span><span class="n">ij</span><span class="p">:</span><span class="n">ij</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="o">=</span><span class="n">outbuf</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="o">-</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">_cp</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]))</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span><span class="p">[</span><span class="n">ij1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">_cp</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]))</span>
                    <span class="n">ij1</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">ij</span> <span class="o">+=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="p">,</span> <span class="s1">&#39;with_df&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">with_df</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;CCSD detected DF being used in the HF object. &#39;</span>
                     <span class="s1">&#39;MO integrals are computed based on the DF 3-index tensors.</span><span class="se">\n</span><span class="s1">&#39;</span>
                     <span class="s2">&quot;It</span><span class="se">\&#39;</span><span class="s2">s recommended to use dfccsd.CCSD for the DF-CCSD calculations&quot;</span><span class="p">)</span>
            <span class="n">nvir_pair</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="n">oooo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">))</span>
            <span class="n">ooov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">))</span>
            <span class="n">ovoo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">))</span>
            <span class="n">oovv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="o">*</span><span class="n">nvir</span><span class="p">))</span>
            <span class="n">ovov</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">))</span>
            <span class="n">ovvv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">))</span>
            <span class="n">vvvv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nvir_pair</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">))</span>

            <span class="n">mo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">mo_coeff</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;F&#39;</span><span class="p">)</span>
            <span class="n">nmo</span> <span class="o">=</span> <span class="n">mo</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">ijslice</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nmo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nmo</span><span class="p">)</span>
            <span class="n">Lpq</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">eri1</span> <span class="ow">in</span> <span class="n">cc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">with_df</span><span class="o">.</span><span class="n">loop</span><span class="p">():</span>
                <span class="n">Lpq</span> <span class="o">=</span> <span class="n">_ao2mo</span><span class="o">.</span><span class="n">nr_e2</span><span class="p">(</span><span class="n">eri1</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="n">ijslice</span><span class="p">,</span> <span class="n">aosym</span><span class="o">=</span><span class="s1">&#39;s2&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">Lpq</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">)</span>
                <span class="n">Loo</span> <span class="o">=</span> <span class="n">Lpq</span><span class="p">[:,:</span><span class="n">nocc</span><span class="p">,:</span><span class="n">nocc</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">Lov</span> <span class="o">=</span> <span class="n">Lpq</span><span class="p">[:,:</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span>
                <span class="n">Lvv</span> <span class="o">=</span> <span class="n">Lpq</span><span class="p">[:,</span><span class="n">nocc</span><span class="p">:,</span><span class="n">nocc</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Loo</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Loo</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oooo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Loo</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Lov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ooov</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Lov</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Loo</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ovoo</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Loo</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Lvv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">oovv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Lov</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Lov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ovov</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">Lvv</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">pack_tril</span><span class="p">(</span><span class="n">Lvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Lov</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Lvv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ovvv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">lib</span><span class="o">.</span><span class="n">ddot</span><span class="p">(</span><span class="n">Lvv</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">Lvv</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vvvv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;oooo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oooo</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ooov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ooov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ovoo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ovoo</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;oovv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oovv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ovov&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ovov</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ovvv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ovvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;vvvv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vvvv</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nvir_pair</span><span class="p">,</span><span class="n">nvir_pair</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;oooo&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ooov&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ovoo&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;oovv&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ovov&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;ovvv&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="p">[</span><span class="s1">&#39;vvvv&#39;</span><span class="p">]</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Build MO integrals with outcore ao2mo&#39;</span><span class="p">)</span>
            <span class="n">cput1</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">(),</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
            <span class="n">orbo</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,:</span><span class="n">nocc</span><span class="p">]</span>
            <span class="n">orbv</span> <span class="o">=</span> <span class="n">mo_coeff</span><span class="p">[:,</span><span class="n">nocc</span><span class="p">:]</span>
            <span class="n">nvpair</span> <span class="o">=</span> <span class="n">nvir</span> <span class="o">*</span> <span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oooo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ooov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovoo&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;oovv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovov&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri1</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;ovvv&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvpair</span><span class="p">),</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
            <span class="n">fsort</span> <span class="o">=</span> <span class="n">_ccsd</span><span class="o">.</span><span class="n">libcc</span><span class="o">.</span><span class="n">CCsd_sort_inplace</span>
            <span class="n">nocc_pair</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="n">nvir_pair</span> <span class="o">=</span> <span class="n">nvir</span><span class="o">*</span><span class="p">(</span><span class="n">nvir</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
            <span class="k">def</span> <span class="nf">sort_inplace</span><span class="p">(</span><span class="n">eri</span><span class="p">):</span>
                <span class="n">fsort</span><span class="p">(</span><span class="n">eri</span><span class="o">.</span><span class="n">ctypes</span><span class="o">.</span><span class="n">data_as</span><span class="p">(</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_void_p</span><span class="p">),</span>
                      <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">nocc</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">nvir</span><span class="p">),</span>
                      <span class="n">ctypes</span><span class="o">.</span><span class="n">c_int</span><span class="p">(</span><span class="n">eri</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                <span class="n">vv</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:,:</span><span class="n">nvir_pair</span><span class="p">]</span>
                <span class="n">oo</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:,</span><span class="n">nvir_pair</span><span class="p">:</span><span class="n">nvir_pair</span><span class="o">+</span><span class="n">nocc_pair</span><span class="p">]</span>
                <span class="n">ov</span> <span class="o">=</span> <span class="n">eri</span><span class="p">[:,</span><span class="n">nvir_pair</span><span class="o">+</span><span class="n">nocc_pair</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">oo</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="n">vv</span>
            <span class="n">buf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">))</span>
            <span class="k">def</span> <span class="nf">save_occ_frac</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">eri</span><span class="p">):</span>
                <span class="n">oo</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="n">vv</span> <span class="o">=</span> <span class="n">sort_inplace</span><span class="p">(</span><span class="n">eri</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oooo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ooov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ov</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">oovv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">vv</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">save_vir_frac</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">eri</span><span class="p">):</span>
                <span class="n">oo</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="n">vv</span> <span class="o">=</span> <span class="n">sort_inplace</span><span class="p">(</span><span class="n">eri</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ovoo</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">unpack_tril</span><span class="p">(</span><span class="n">oo</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">buf</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ovov</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ov</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ovvv</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">p0</span><span class="p">:</span><span class="n">p1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vv</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cc</span><span class="o">.</span><span class="n">direct</span><span class="p">:</span>
                <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span><span class="n">cc</span><span class="o">.</span><span class="n">max_memory</span><span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feri2</span> <span class="o">=</span> <span class="n">lib</span><span class="o">.</span><span class="n">H5TmpFile</span><span class="p">()</span>
                <span class="n">ao2mo</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="n">orbv</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri2</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">=</span><span class="n">max_memory</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vvvv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feri2</span><span class="p">[</span><span class="s1">&#39;eri_mo&#39;</span><span class="p">]</span>
                <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming vvvv&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>

            <span class="n">tmpfile3</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="nb">dir</span><span class="o">=</span><span class="n">lib</span><span class="o">.</span><span class="n">param</span><span class="o">.</span><span class="n">TMPDIR</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">tmpfile3</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">feri</span><span class="p">:</span>
                <span class="n">max_memory</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2000</span><span class="p">,</span> <span class="n">cc</span><span class="o">.</span><span class="n">max_memory</span><span class="o">-</span><span class="n">lib</span><span class="o">.</span><span class="n">current_memory</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">mo</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">orbv</span><span class="p">,</span> <span class="n">orbo</span><span class="p">))</span>
                <span class="n">ao2mo</span><span class="o">.</span><span class="n">general</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mol</span><span class="p">,</span> <span class="p">(</span><span class="n">orbo</span><span class="p">,</span><span class="n">mo</span><span class="p">,</span><span class="n">mo</span><span class="p">,</span><span class="n">mo</span><span class="p">),</span>
                              <span class="n">feri</span><span class="p">,</span> <span class="n">max_memory</span><span class="o">=</span><span class="n">max_memory</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">log</span><span class="p">)</span>
                <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;transforming oppp&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>
                <span class="n">blksize</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="mi">8</span><span class="n">e9</span><span class="p">,</span><span class="n">max_memory</span><span class="o">*.</span><span class="mi">5</span><span class="n">e6</span><span class="p">)</span><span class="o">/</span><span class="mi">8</span><span class="o">/</span><span class="n">nmo</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

                <span class="k">with</span> <span class="n">lib</span><span class="o">.</span><span class="n">call_in_background</span><span class="p">(</span><span class="n">save_vir_frac</span><span class="p">,</span>
                                            <span class="n">save_occ_frac</span><span class="p">)</span> <span class="k">as</span> <span class="p">(</span><span class="n">sav_v</span><span class="p">,</span> <span class="n">sav_o</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nvir</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                            <span class="n">eri</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">feri</span><span class="p">[</span><span class="s1">&#39;eri_mo&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmo</span><span class="o">+</span><span class="n">p0</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">nmo</span><span class="o">+</span><span class="n">p1</span><span class="p">])</span>
                            <span class="n">sav_v</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">eri</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span> <span class="ow">in</span> <span class="n">lib</span><span class="o">.</span><span class="n">prange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nocc</span><span class="p">,</span> <span class="n">blksize</span><span class="p">):</span>
                            <span class="n">eri</span> <span class="o">=</span> <span class="n">_cp</span><span class="p">(</span><span class="n">feri</span><span class="p">[</span><span class="s1">&#39;eri_mo&#39;</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">nmo</span><span class="o">+</span><span class="n">nvir</span><span class="o">+</span><span class="n">p0</span><span class="p">:</span><span class="n">i</span><span class="o">*</span><span class="n">nmo</span><span class="o">+</span><span class="n">nvir</span><span class="o">+</span><span class="n">p1</span><span class="p">])</span>
                            <span class="n">sav_o</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">eri</span><span class="p">)</span>
                        <span class="n">cput1</span> <span class="o">=</span> <span class="n">log</span><span class="o">.</span><span class="n">timer_debug1</span><span class="p">(</span><span class="s1">&#39;sorting </span><span class="si">%d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="o">*</span><span class="n">cput1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">feri</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="k">del</span><span class="p">(</span><span class="n">feri</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="n">log</span><span class="o">.</span><span class="n">timer</span><span class="p">(</span><span class="s1">&#39;CCSD integral transformation&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">cput0</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_moidx</span><span class="p">(</span><span class="n">cc</span><span class="p">):</span>
    <span class="n">moidx</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">mo_occ</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">numpy</span><span class="o">.</span><span class="n">integer</span><span class="p">)):</span>
        <span class="n">moidx</span><span class="p">[:</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">moidx</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">cc</span><span class="o">.</span><span class="n">frozen</span><span class="p">)]</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">moidx</span>
<span class="k">def</span> <span class="nf">_mo_without_core</span><span class="p">(</span><span class="n">cc</span><span class="p">,</span> <span class="n">mo</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">mo</span><span class="p">[:,</span><span class="n">get_moidx</span><span class="p">(</span><span class="n">cc</span><span class="p">)]</span>

<span class="c1"># assume nvir &gt; nocc, minimal requirements on memory in loop of update_amps</span>
<span class="k">def</span> <span class="nf">_memory_usage_inloop</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*.</span><span class="mi">3</span><span class="o">+</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">6</span><span class="p">,</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">7</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">v</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span>
<span class="c1"># assume nvir &gt; nocc, minimal requirements on memory</span>
<span class="k">def</span> <span class="nf">_mem_usage</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">):</span>
    <span class="n">basic</span> <span class="o">=</span> <span class="n">_memory_usage_inloop</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">)</span><span class="o">*</span><span class="mi">1</span><span class="n">e6</span><span class="o">/</span><span class="mi">8</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">4</span>
    <span class="n">basic</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">basic</span><span class="p">,</span> <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span>
    <span class="n">basic</span> <span class="o">=</span> <span class="n">basic</span> <span class="o">*</span> <span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span>
    <span class="n">nmo</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nvir</span>
    <span class="n">incore</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="n">nmo</span><span class="o">*</span><span class="p">(</span><span class="n">nmo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span><span class="p">,</span> <span class="n">basic</span><span class="p">)</span> <span class="o">+</span>
              <span class="p">(</span><span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nvir</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
               <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="mi">8</span><span class="o">/</span><span class="mi">1</span><span class="n">e6</span><span class="p">)</span>
    <span class="n">outcore</span> <span class="o">=</span> <span class="n">basic</span>
    <span class="k">return</span> <span class="n">incore</span><span class="p">,</span> <span class="n">outcore</span><span class="p">,</span> <span class="n">basic</span>

<span class="k">def</span> <span class="nf">residual_as_diis_errvec</span><span class="p">(</span><span class="n">mycc</span><span class="p">):</span>
<span class="c1"># Seems not quite useful</span>
<span class="c1"># Cannot be used with non-conanical mf object</span>
    <span class="k">def</span> <span class="nf">fupdate</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">istep</span><span class="p">,</span> <span class="n">normt</span><span class="p">,</span> <span class="n">de</span><span class="p">,</span> <span class="n">adiis</span><span class="p">):</span>
        <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">nov</span> <span class="o">=</span> <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span>
        <span class="n">moidx</span> <span class="o">=</span> <span class="n">get_moidx</span><span class="p">(</span><span class="n">mycc</span><span class="p">)</span>
        <span class="n">mo_e</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">_scf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">[</span><span class="n">moidx</span><span class="p">]</span>
        <span class="n">eia</span> <span class="o">=</span> <span class="n">mo_e</span><span class="p">[:</span><span class="n">nocc</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span> <span class="o">-</span> <span class="n">mo_e</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="n">nocc</span><span class="p">:]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">istep</span> <span class="o">&gt;</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis_start_cycle</span> <span class="ow">and</span>
            <span class="nb">abs</span><span class="p">(</span><span class="n">de</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">mycc</span><span class="o">.</span><span class="n">diis_start_energy_diff</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">mycc</span><span class="o">.</span><span class="n">t1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">mycc</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span>
                <span class="n">mycc</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nov</span><span class="o">*</span><span class="p">(</span><span class="n">nov</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">tbuf</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">t1</span><span class="o">-</span><span class="n">mycc</span><span class="o">.</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">eia</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">pbuf</span> <span class="o">=</span> <span class="n">tbuf</span><span class="p">[</span><span class="n">nov</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nocc</span><span class="p">):</span>
                    <span class="n">pbuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-</span><span class="n">mycc</span><span class="o">.</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">*</span> <span class="n">lib</span><span class="o">.</span><span class="n">direct_sum</span><span class="p">(</span><span class="s1">&#39;jb,a-&gt;jba&#39;</span><span class="p">,</span> <span class="n">eia</span><span class="p">,</span> <span class="n">eia</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">adiis</span><span class="o">.</span><span class="n">push_err_vec</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span>
                <span class="n">tbuf</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nov</span><span class="o">*</span><span class="p">(</span><span class="n">nov</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                <span class="n">tbuf</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span> <span class="o">=</span> <span class="n">t1</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">tbuf</span><span class="p">[</span><span class="n">nov</span><span class="p">:]</span> <span class="o">=</span> <span class="n">t2</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">t1</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tbuf</span><span class="o">.</span><span class="n">data</span> <span class="c1"># release memory</span>
                <span class="n">t2</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">tbuf</span><span class="o">.</span><span class="n">data</span>

                <span class="n">tbuf</span> <span class="o">=</span> <span class="n">adiis</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span>
                <span class="n">mycc</span><span class="o">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">=</span> <span class="n">tbuf</span><span class="p">[:</span><span class="n">nov</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
                <span class="n">mycc</span><span class="o">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">tbuf</span><span class="p">[</span><span class="n">nov</span><span class="p">:]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="s1">&#39;DIIS for step </span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">istep</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span>
    <span class="k">return</span> <span class="n">fupdate</span>


<span class="k">def</span> <span class="nf">_fp</span><span class="p">(</span><span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Total float points&#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>     <span class="c1"># Ftilde</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">nvir</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>    <span class="c1"># Wijkl</span>
            <span class="n">nocc</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>                        <span class="c1"># Wabcd</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>     <span class="c1"># Wiabj</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>     <span class="c1"># t1</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
            <span class="n">nocc</span><span class="o">*</span><span class="p">(</span><span class="n">nocc</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">4</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>                 <span class="c1"># vvvv</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span>     <span class="c1"># t2</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span>
            <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">nocc</span><span class="o">**</span><span class="mi">3</span><span class="o">*</span><span class="n">nvir</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>      <span class="c1"># Wiabj</span>


<span class="c1"># t2 + numpy.einsum(&#39;ia,jb-&gt;ijab&#39;, t1a, t1b)</span>
<span class="k">def</span> <span class="nf">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">fac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_ccsd</span><span class="o">.</span><span class="n">make_tau</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t1a</span><span class="p">,</span> <span class="n">t1b</span><span class="p">,</span> <span class="n">fac</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

<span class="c1"># t2.transpose(0,1,3,2)*2 - t2</span>
<span class="k">def</span> <span class="nf">make_theta</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">_ccsd</span><span class="o">.</span><span class="n">make_0132</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">out</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">prange</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">step</span><span class="p">):</span>
        <span class="k">yield</span> <span class="n">i</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="n">step</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_cp</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">gto</span>
    <span class="kn">from</span> <span class="nn">pyscf</span> <span class="k">import</span> <span class="n">scf</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">M</span><span class="p">()</span>
    <span class="n">nocc</span><span class="p">,</span> <span class="n">nvir</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">12</span>
    <span class="n">nmo</span> <span class="o">=</span> <span class="n">nocc</span> <span class="o">+</span> <span class="n">nvir</span>
    <span class="n">nmo_pair</span> <span class="o">=</span> <span class="n">nmo</span><span class="o">*</span><span class="p">(</span><span class="n">nmo</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
    <span class="n">mf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">_eri</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="n">nmo_pair</span><span class="o">*</span><span class="p">(</span><span class="n">nmo_pair</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">))</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span> <span class="n">nmo</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">mo_occ</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nmo</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">mo_occ</span><span class="p">[:</span><span class="n">nocc</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">vhf</span> <span class="o">=</span> <span class="n">mf</span><span class="o">.</span><span class="n">get_veff</span><span class="p">(</span><span class="n">mol</span><span class="p">,</span> <span class="n">mf</span><span class="o">.</span><span class="n">make_rdm1</span><span class="p">())</span>
    <span class="n">cinv</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_coeff</span><span class="p">)</span>
    <span class="n">mf</span><span class="o">.</span><span class="n">get_hcore</span> <span class="o">=</span> <span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">:</span> <span class="p">(</span><span class="n">reduce</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">,</span> <span class="p">(</span><span class="n">cinv</span><span class="o">.</span><span class="n">T</span><span class="o">*</span><span class="n">mf</span><span class="o">.</span><span class="n">mo_energy</span><span class="p">,</span> <span class="n">cinv</span><span class="p">))</span> <span class="o">-</span> <span class="n">vhf</span><span class="p">)</span>
    <span class="n">mycc</span> <span class="o">=</span> <span class="n">CCSD</span><span class="p">(</span><span class="n">mf</span><span class="p">)</span>
    <span class="n">eris</span> <span class="o">=</span> <span class="n">mycc</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">()</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">nmo</span><span class="p">,</span><span class="n">nmo</span><span class="p">))</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span>
    <span class="n">eris</span><span class="o">.</span><span class="n">fock</span> <span class="o">+=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">a</span><span class="o">.</span><span class="n">T</span>
    <span class="n">t1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="n">nocc</span><span class="p">,</span><span class="n">nocc</span><span class="p">,</span><span class="n">nvir</span><span class="p">,</span><span class="n">nvir</span><span class="p">))</span> <span class="o">*</span> <span class="o">.</span><span class="mi">1</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">t2</span> <span class="o">+</span> <span class="n">t2</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r1</span><span class="p">,</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">vector_to_amplitudes</span><span class="p">(</span><span class="n">amplitudes_to_vector</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">),</span> <span class="n">nocc</span><span class="o">+</span><span class="n">nvir</span><span class="p">,</span> <span class="n">nocc</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="o">-</span><span class="n">r1</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t2</span><span class="o">-</span><span class="n">r2</span><span class="p">)</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">finger</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">size</span><span class="p">)))</span>
    <span class="n">t1a</span><span class="p">,</span> <span class="n">t2a</span> <span class="o">=</span> <span class="n">update_amps</span><span class="p">(</span><span class="n">mycc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">finger</span><span class="p">(</span><span class="n">t1a</span><span class="p">)</span> <span class="o">-</span> <span class="o">-</span><span class="mf">106360.5276951083</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">finger</span><span class="p">(</span><span class="n">t2a</span><span class="p">)</span> <span class="o">-</span> <span class="mf">66540.100267798145</span><span class="p">)</span>

    <span class="n">mol</span> <span class="o">=</span> <span class="n">gto</span><span class="o">.</span><span class="n">Mole</span><span class="p">()</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">atom</span> <span class="o">=</span> <span class="p">[</span>
        <span class="p">[</span><span class="mi">8</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="mf">0.</span>     <span class="p">,</span> <span class="mf">0.</span><span class="p">)],</span>
        <span class="p">[</span><span class="mi">1</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="o">-</span><span class="mf">0.757</span> <span class="p">,</span> <span class="mf">0.587</span><span class="p">)],</span>
        <span class="p">[</span><span class="mi">1</span> <span class="p">,</span> <span class="p">(</span><span class="mf">0.</span> <span class="p">,</span> <span class="mf">0.757</span>  <span class="p">,</span> <span class="mf">0.587</span><span class="p">)]]</span>

    <span class="n">mol</span><span class="o">.</span><span class="n">basis</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;H&#39;</span><span class="p">:</span> <span class="s1">&#39;cc-pvdz&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;O&#39;</span><span class="p">:</span> <span class="s1">&#39;cc-pvdz&#39;</span><span class="p">,}</span>
    <span class="n">mol</span><span class="o">.</span><span class="n">build</span><span class="p">()</span>
    <span class="n">rhf</span> <span class="o">=</span> <span class="n">scf</span><span class="o">.</span><span class="n">RHF</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
    <span class="n">rhf</span><span class="o">.</span><span class="n">scf</span><span class="p">()</span> <span class="c1"># -76.0267656731</span>

    <span class="n">mcc</span> <span class="o">=</span> <span class="n">CCSD</span><span class="p">(</span><span class="n">rhf</span><span class="o">.</span><span class="n">density_fit</span><span class="p">())</span>
    <span class="n">eris</span> <span class="o">=</span> <span class="n">mcc</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">()</span>
    <span class="n">emp2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">mcc</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">4.9497459404635027</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">emp2</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.20378410853394652</span><span class="p">)</span>
    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">update_amps</span><span class="p">(</span><span class="n">mcc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.04740146211751467</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">5.3943058907680506</span> <span class="p">)</span>

    <span class="n">mcc</span> <span class="o">=</span> <span class="n">CCSD</span><span class="p">(</span><span class="n">rhf</span><span class="p">)</span>
    <span class="n">eris</span> <span class="o">=</span> <span class="n">mcc</span><span class="o">.</span><span class="n">ao2mo</span><span class="p">()</span>
    <span class="n">emp2</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">mcc</span><span class="o">.</span><span class="n">init_amps</span><span class="p">(</span><span class="n">eris</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">4.9556571218177</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">emp2</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.2040199672883385</span><span class="p">)</span>
    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">update_amps</span><span class="p">(</span><span class="n">mcc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="mf">0.0475038989126</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">-</span><span class="mf">5.401823846018721</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">energy</span><span class="p">(</span><span class="n">mcc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.208967840546667</span><span class="p">)</span>
    <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span> <span class="o">=</span> <span class="n">update_amps</span><span class="p">(</span><span class="n">mcc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">energy</span><span class="p">(</span><span class="n">mcc</span><span class="p">,</span> <span class="n">t1</span><span class="p">,</span> <span class="n">t2</span><span class="p">,</span> <span class="n">eris</span><span class="p">)</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.212173678670510</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">0.05470123093500083</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">5.5605208391876539</span><span class="p">)</span>

    <span class="n">mcc</span><span class="o">.</span><span class="n">ccsd</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">ecc</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.213343234198275</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">5.63970304662375</span><span class="p">)</span>

    <span class="n">mcc</span><span class="o">.</span><span class="n">max_memory</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mcc</span><span class="o">.</span><span class="n">direct</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mcc</span><span class="o">.</span><span class="n">ccsd</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">ecc</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.213343234198275</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">5.63970304662375</span><span class="p">)</span>

    <span class="n">mcc</span><span class="o">.</span><span class="n">diis</span> <span class="o">=</span> <span class="n">residual_as_diis_errvec</span><span class="p">(</span><span class="n">mcc</span><span class="p">)</span>
    <span class="n">mcc</span><span class="o">.</span><span class="n">ccsd</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">ecc</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.213343234198275</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">t2</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mf">5.63970304662375</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">mcc</span><span class="o">.</span><span class="n">ccsd_t</span><span class="p">()</span> <span class="o">-</span> <span class="o">-</span><span class="mf">0.003060021865720902</span><span class="p">)</span>

</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015-, Qiming Sun &lt;osirpt.sun@gmail.com&gt;.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../',
            VERSION:'1.4.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: ''
        };
    </script>
      <script type="text/javascript" src="../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>